<!DOCTYPE html>
<html  lang="ru-RU">

<head>

  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title>Учебник по языку R для начинающих</title>
  <meta name="description" content="Учебник по языку R и не только :)">
  <meta name="generator" content="bookdown <!--bookdown:version--> and GitBook 2.6.7">

  <meta property="og:title" content="Учебник по языку R для начинающих" />
  <meta property="og:type" content="book" />
  
  
  <meta property="og:description" content="Учебник по языку R и не только :)" />
  <meta name="github-repo" content="bdemeshev/r_manual_book" />

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="Учебник по языку R для начинающих" />
  
  <meta name="twitter:description" content="Учебник по языку R и не только :)" />
  

<meta name="author" content="Борис Демешев">


<meta name="date" content="2017-08-25">

  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  
  
<!--bookdown:link_prev-->
<!--bookdown:link_next-->
<script src="libs/jquery-2.2.3/jquery.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/lunr.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>


<style type="text/css">
div.sourceCode { overflow-x: auto; }
table.sourceCode, tr.sourceCode, td.lineNumbers, td.sourceCode {
  margin: 0; padding: 0; vertical-align: baseline; border: none; }
table.sourceCode { width: 100%; line-height: 100%; }
td.lineNumbers { text-align: right; padding-right: 4px; padding-left: 4px; color: #aaaaaa; border-right: 1px solid #aaaaaa; }
td.sourceCode { padding-left: 5px; }
code > span.kw { color: #007020; font-weight: bold; } /* Keyword */
code > span.dt { color: #902000; } /* DataType */
code > span.dv { color: #40a070; } /* DecVal */
code > span.bn { color: #40a070; } /* BaseN */
code > span.fl { color: #40a070; } /* Float */
code > span.ch { color: #4070a0; } /* Char */
code > span.st { color: #4070a0; } /* String */
code > span.co { color: #60a0b0; font-style: italic; } /* Comment */
code > span.ot { color: #007020; } /* Other */
code > span.al { color: #ff0000; font-weight: bold; } /* Alert */
code > span.fu { color: #06287e; } /* Function */
code > span.er { color: #ff0000; font-weight: bold; } /* Error */
code > span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
code > span.cn { color: #880000; } /* Constant */
code > span.sc { color: #4070a0; } /* SpecialChar */
code > span.vs { color: #4070a0; } /* VerbatimString */
code > span.ss { color: #bb6688; } /* SpecialString */
code > span.im { } /* Import */
code > span.va { color: #19177c; } /* Variable */
code > span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code > span.op { color: #666666; } /* Operator */
code > span.bu { } /* BuiltIn */
code > span.ex { } /* Extension */
code > span.pp { color: #bc7a00; } /* Preprocessor */
code > span.at { color: #7d9029; } /* Attribute */
code > span.do { color: #ba2121; font-style: italic; } /* Documentation */
code > span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code > span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code > span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
</style>

<link rel="stylesheet" href="style.css" type="text/css" />
</head>

<body>



<!--bookdown:title:start-->
<div id="header">
<h1 class="title">Учебник по языку R для начинающих</h1>
<h4 class="author"><em>Борис Демешев</em></h4>
<h4 class="date"><em>2017-08-25</em></h4>
</div>
<!--bookdown:title:end-->

<!--bookdown:toc:start-->
  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">
<!--bookdown:toc2:start-->
<ul>
<li><a href="#-">О книге</a></li>
<li><a href="#first_steps"><span class="toc-section-number">1</span> Первые шаги</a><ul>
<li><a href="#installation"><span class="toc-section-number">1.1</span> Установка софта</a><ul>
<li><a href="#russia"><span class="toc-section-number">1.1.1</span> Россия — родина слонов</a></li>
</ul></li>
<li><a href="#light_setup"><span class="toc-section-number">1.2</span> Набор легковооружённого кавалериста</a><ul>
<li><a href="#install_R"><span class="toc-section-number">1.2.1</span> R</a></li>
<li><a href="#r_chelyabinsk"><span class="toc-section-number">1.2.2</span> Установка R для суровых челябинцев</a></li>
<li><a href="#install_Rstudio"><span class="toc-section-number">1.2.3</span> Rstudio</a></li>
</ul></li>
<li><a href="#other_programs"><span class="toc-section-number">1.3</span> Тяжёловооружённая кавалерия</a><ul>
<li><a href="#install_Latex"><span class="toc-section-number">1.3.1</span> LaTeX</a></li>
<li><a href="#install_git"><span class="toc-section-number">1.3.2</span> git-клиент</a></li>
<li><a href="#install_editor"><span class="toc-section-number">1.3.3</span> Текстовый редактор</a></li>
<li><a href="#install_jupyter"><span class="toc-section-number">1.3.4</span> jupyter</a></li>
<li><a href="#install_lyx"><span class="toc-section-number">1.3.5</span> LyX</a></li>
<li><a href="#install_font"><span class="toc-section-number">1.3.6</span> Шрифты</a></li>
<li><a href="#pandoc"><span class="toc-section-number">1.3.7</span> Pandoc</a></li>
<li><a href="#install_gretl"><span class="toc-section-number">1.3.8</span> gretl</a></li>
</ul></li>
<li><a href="#funny_calc"><span class="toc-section-number">1.4</span> Весёлый калькулятор</a><ul>
<li><a href="#value_selection"><span class="toc-section-number">1.4.1</span> Отбор элементов вектора</a></li>
<li><a href="#number_comparison"><span class="toc-section-number">1.4.2</span> Сравнение чисел — штука тонкая</a></li>
</ul></li>
<li><a href="#first_script"><span class="toc-section-number">1.5</span> Первый скрипт</a></li>
<li><a href="#packages"><span class="toc-section-number">1.6</span> Установка и подключение пакетов</a><ul>
<li><a href="#-----cran"><span class="toc-section-number">1.6.1</span> Установка пакета с официального репозитория CRAN</a></li>
<li><a href="#----bioconductor"><span class="toc-section-number">1.6.2</span> Установка пакета с репозитория <code id="bioconductor">bioconductor</code></a></li>
<li><a href="#attach_and_use"><span class="toc-section-number">1.6.3</span> Подключение и использование пакетов</a></li>
<li><a href="#-----github"><span class="toc-section-number">1.6.4</span> Установка пакетов с репозитория на github</a></li>
<li><a href="#---"><span class="toc-section-number">1.6.5</span> Какие пакеты мне нужны?</a></li>
</ul></li>
<li><a href="#io"><span class="toc-section-number">1.7</span> Чтение и запись данных</a></li>
<li><a href="#popular_formats"><span class="toc-section-number">1.8</span> Распространённые форматы</a><ul>
<li><a href="#comma-separated-values-sv"><span class="toc-section-number">1.8.1</span> Comma separated values: сsv</a></li>
<li><a href="#-excel-xls--xlsx"><span class="toc-section-number">1.8.2</span> Форматы Excel: xls и xlsx</a></li>
<li><a href="#-spss-sav"><span class="toc-section-number">1.8.3</span> Формат SPSS: sav</a></li>
<li><a href="#-eviews-wf1"><span class="toc-section-number">1.8.4</span> Формат Eviews: wf1</a></li>
<li><a href="#-stata-dta"><span class="toc-section-number">1.8.5</span> Формат Stata: dta</a></li>
</ul></li>
<li><a href="#internet_sources"><span class="toc-section-number">1.9</span> Интернет-источники данных</a></li>
<li><a href="#code_style"><span class="toc-section-number">1.10</span> Стиль кода</a></li>
<li><a href="#two_traditions"><span class="toc-section-number">1.11</span> Две записи функций</a></li>
<li><a href="#data_manipulations"><span class="toc-section-number">1.12</span> Манипуляции с данными</a><ul>
<li><a href="#glimpse"><span class="toc-section-number">1.12.1</span> Быстрый взгляд на табличку</a></li>
<li><a href="#filter_observations"><span class="toc-section-number">1.12.2</span> Отбор наблюдений</a></li>
<li><a href="#select_rename"><span class="toc-section-number">1.12.3</span> Отбор и переименование переменных:</a></li>
<li><a href="#mutate_variables"><span class="toc-section-number">1.12.4</span> Преобразование и создание новых переменных</a></li>
<li><a href="#df_sorting"><span class="toc-section-number">1.12.5</span> Сортировка</a></li>
<li><a href="#group_by"><span class="toc-section-number">1.12.6</span> Операции с группировкой</a></li>
<li><a href="#join_df"><span class="toc-section-number">1.12.7</span> Слияние наборов данных</a></li>
<li><a href="#mortal_kombat"><span class="toc-section-number">1.12.8</span> Комбо-серия!</a></li>
</ul></li>
<li><a href="#graphs"><span class="toc-section-number">1.13</span> Графики</a><ul>
<li><a href="#two_simple_graphs"><span class="toc-section-number">1.13.1</span> Два простеньких графика</a></li>
</ul></li>
<li><a href="#error"><span class="toc-section-number">1.14</span> У меня ошибка!</a></li>
<li><a href="#R_links"><span class="toc-section-number">1.15</span> Ресурсы по R</a></li>
</ul></li>
<li><a href="#friends_of_R"><span class="toc-section-number">2</span> Друзья R</a><ul>
<li><a href="#workflow"><span class="toc-section-number">2.1</span> Рабочий процесс</a></li>
<li><a href="#version_control"><span class="toc-section-number">2.2</span> Контроль версий</a></li>
<li><a href="#latex"><span class="toc-section-number">2.3</span> Латех</a></li>
<li><a href="#markdown"><span class="toc-section-number">2.4</span> Маркдаун</a></li>
<li><a href="#reproducible_research"><span class="toc-section-number">2.5</span> Воспроизводимые исследования</a></li>
<li><a href="#own_package"><span class="toc-section-number">2.6</span> Написание своего пакета</a></li>
<li><a href="#cloud_computing"><span class="toc-section-number">2.7</span> Вычисления в облаке</a></li>
<li><a href="#presentations"><span class="toc-section-number">2.8</span> Презентации</a></li>
<li><a href="#this_book"><span class="toc-section-number">2.9</span> Про эту книжку</a></li>
</ul></li>
<li><a href="#statistics_and_more"><span class="toc-section-number">3</span> Статистика и не только</a><ul>
<li><a href="#random_variables"><span class="toc-section-number">3.1</span> Генерирование случайных величин</a></li>
<li><a href="#statistical_tests"><span class="toc-section-number">3.2</span> Базовые статистические тесты</a></li>
<li><a href="#classic_regression"><span class="toc-section-number">3.3</span> Множественная регрессия</a></li>
<li><a href="#quantile_regression"><span class="toc-section-number">3.4</span> Квантильная регрессия</a></li>
<li><a href="#instrumental_variables"><span class="toc-section-number">3.5</span> Инструментальные переменные</a></li>
<li><a href="#heteroskedasticity"><span class="toc-section-number">3.6</span> Гетероскедастичность</a><ul>
<li><a href="#hetero_testing"><span class="toc-section-number">3.6.1</span> Тесты на гетероскедастичность</a></li>
<li><a href="#hetero_bp_test"><span class="toc-section-number">3.6.2</span> Тест Бройша-Пагана, Breusch-Pagan:</a></li>
<li><a href="#white_test"><span class="toc-section-number">3.6.3</span> Тест Уайта. White test</a></li>
<li><a href="#gq_test"><span class="toc-section-number">3.6.4</span> Тест Goldfeld-Quandt</a></li>
<li><a href="#hetero_fail"><span class="toc-section-number">3.6.5</span> Тестирование и борьба с гетероскедастичностью</a></li>
<li><a href="#hetero_forecasting"><span class="toc-section-number">3.6.6</span> Прогнозирование при гетероскедастичности</a></li>
<li><a href="#hetero_links"><span class="toc-section-number">3.6.7</span> Дополнительно:</a></li>
</ul></li>
<li><a href="#factor_variables"><span class="toc-section-number">3.7</span> Работа с качественными переменными</a></li>
<li><a href="#logit_probit"><span class="toc-section-number">3.8</span> Логит и пробит с визуализацией</a></li>
<li><a href="#pca"><span class="toc-section-number">3.9</span> Метод главных компонент</a></li>
<li><a href="#multicollinearity"><span class="toc-section-number">3.10</span> Мультиколлинеарность</a></li>
<li><a href="#lasso"><span class="toc-section-number">3.11</span> LASSO</a></li>
<li><a href="#maximum_likelihood"><span class="toc-section-number">3.12</span> Метод максимального правдоподобия</a></li>
<li><a href="#svm"><span class="toc-section-number">3.13</span> Метод опорных векторов</a></li>
<li><a href="#random_forest"><span class="toc-section-number">3.14</span> Случайный лес</a></li>
<li><a href="#exponential_smoothing"><span class="toc-section-number">3.15</span> Экспоненциальное сглаживание</a></li>
<li><a href="#arma"><span class="toc-section-number">3.16</span> ARMA модели</a></li>
<li><a href="#garch"><span class="toc-section-number">3.17</span> GARCH</a></li>
<li><a href="#var_bvar"><span class="toc-section-number">3.18</span> VAR и BVAR</a></li>
<li><a href="#panel_data"><span class="toc-section-number">3.19</span> Панельные данные</a></li>
<li><a href="#bayesian_first_steps"><span class="toc-section-number">3.20</span> Байесовский подход: первые шаги</a></li>
<li><a href="#stan"><span class="toc-section-number">3.21</span> Байесовский подход: STAN</a></li>
<li><a href="#maps"><span class="toc-section-number">3.22</span> Карты</a></li>
<li><a href="#differential_equations"><span class="toc-section-number">3.23</span> Дифференциальные уравнения</a></li>
<li><a href="#optimisation"><span class="toc-section-number">3.24</span> Задачи оптимизации</a></li>
</ul></li>
</ul>
<!--bookdown:toc2:end-->
      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">Учебник по языку R для начинающих</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<!--bookdown:toc:end-->
<!--bookdown:body:start-->
<div id="-" class="section level1 unnumbered">
<h1>О книге</h1>
<p>Сейчас живут три кита анализа данных и научных вычислений — Julia, Python и R. Эта книга про одного из китов!</p>
<p>Данная версия книги скомпилирована для html.</p>
<!--chapter:end:index.Rmd-->
</div>
<div id="first_steps" class="section level1">
<h1><span class="header-section-number">1</span> Первые шаги</h1>
<blockquote>
<p>Поехали!</p>
<p>Алексей Гагарин</p>
</blockquote>
<div id="installation" class="section level2">
<h2><span class="header-section-number">1.1</span> Установка софта</h2>
<p>Казалось бы, чего проще — поставить программу?! Однако не всегда всё идёт гладко, поэтому подробности в студию:</p>
<div id="russia" class="section level3">
<h3><span class="header-section-number">1.1.1</span> Россия — родина слонов</h3>
<p>В России проблем не две, как думают многие, а три: дураки, дороги и русские буквы в именах файлов. Самая распространённая проблема, с которой мне доводилось бороться не один раз, — это русские буквы и пробелы в названиях файлов и папок под Windows.</p>
<div class="warning">
<p>
Если ты используешь Windows, то никогда при серьёзной работе не используй русские буквы и пробелы в названиях файлов и папок.
</p>
</div>
<p>Папку с котиками можно оставить под названием <code>мои котики</code> :)</p>
<p>Заповедь о русских буквах легко нарушить даже не осознавая этого. Если имя пользователя Windows написано русскими буквами, например, <code>Машенька</code>, то по умолчанию все документы этого пользователя будут находиться в папке <code>C:/Users/Машенька/Documents/</code>.</p>
<div class="warning">
<p>
Для серьёзной работы под Windows нужно создать нового пользователя с английским именем, например, <code>Mashenka</code>.
</p>
</div>
<p>Переименование старого пользователя не помогает, проверено. После создания нового пользователя можно перенести документы из старой папке <code>C:/Users/Машенька/Documents/</code> в новую <code>C:/Users/Mashenka/Documents/</code>.</p>
<p>Правильное имя пользователя без пробелов и русских букв <strong>значительно</strong> снижает риск дальнейших проблем.</p>
</div>
</div>
<div id="light_setup" class="section level2">
<h2><span class="header-section-number">1.2</span> Набор легковооружённого кавалериста</h2>
<p>Набор легковооружённого кавалериста включает в себя всего две программы, <a href="https://cran.r-project.org/">R</a> и <a href="https://rstudio.com/">Rstudio</a>. Лишь в небольшой части разделов этого учебника тебе потребуется установка дополнительного софта.</p>
<p>R — это язык программирования ориентированный на статистический анализ данных, а Rstudio — гламурная графическая оболочка к R. Rstudio не может работать без R. Никаких принципиально новых возможностей Rstudio к R не добавляет, но здорово упрощает жизнь!</p>
<div id="install_R" class="section level3">
<h3><span class="header-section-number">1.2.1</span> R</h3>
<p>Устанавливаем R.</p>
<div id="r--windows" class="section level4">
<h4><span class="header-section-number">1.2.1.1</span> R под Windows:</h4>
<ol style="list-style-type: decimal">
<li><p>Заходим на <a href="https://cran.r-project.org/">официальный сайт</a></p></li>
<li><p>Кликаем <code>Download R for Windows</code></p></li>
<li><p>Выбираем <code>base</code>. Это не какая-то ограниченная, базовая версия, а самая настощая полная версия R.</p></li>
<li><p>Кликаем <code>Download R 3.3.x for Windows</code></p></li>
<li><p>Запускаем установщик.</p></li>
<li><p>На вопрос установщика, куда устанавливать R, указываем папку <code>C:\R</code>.</p></li>
</ol>
<p>Проблема в том, что по умолчанию R ставится в папку <code>C:\Program files\...</code>. В имени папки есть пробел, который иногда приводит к проблемам. Чтобы не играть в лотерею с проблемами, лучше выбрать папку <code>C:\R</code> или любую другую без русских букв и пробелов.</p>
</div>
<div id="r--macos" class="section level4">
<h4><span class="header-section-number">1.2.1.2</span> R под Macos:</h4>
<ol style="list-style-type: decimal">
<li><p>Заходим на <a href="https://cran.r-project.org/">официальный сайт</a></p></li>
<li><p>Кликаем <code>R-3.3.x.pkg</code></p></li>
<li><p>Запускаем установщик.</p></li>
</ol>
<p>Раньше при установке R пользователь должен был выбрать зеркало, с которого скачивать R. Это пугало новичков! Разработчики не сразу поставили автоматический выбор зеркала. Выбор ещё остался при установке пакетов. Можно смело брать любое, например, самое первое, <code>0-cloud</code>.</p>
</div>
<div id="r--linux" class="section level4">
<h4><span class="header-section-number">1.2.1.3</span> R под linux</h4>
<p>Linux на примере Ubuntu 16.04 Xenial:</p>
<div class="sourceCode"><pre class="sourceCode bash"><code class="sourceCode bash"><span class="kw">sudo</span> echo <span class="st">&quot;deb http://cran.rstudio.com/bin/linux/ubuntu xenial/&quot;</span> <span class="kw">|</span> <span class="kw">sudo</span> tee -a /etc/apt/sources.list
<span class="kw">gpg</span> --keyserver keyserver.ubuntu.com --recv-key E084DAB9
<span class="kw">gpg</span> -a --export E084DAB9 <span class="kw">|</span> <span class="kw">sudo</span> apt-key add -
<span class="kw">sudo</span> apt-get update
<span class="kw">sudo</span> apt-get install r-base r-base-dev</code></pre></div>
</div>
</div>
<div id="r_chelyabinsk" class="section level3">
<h3><span class="header-section-number">1.2.2</span> Установка R для суровых челябинцев</h3>
<p>Вместо классического R можно поставить конкурирующий <a href="https://mran.microsoft.com/download/">дистрибутив R от Microsoft</a>, MRO. Отличия MRO от классического R:</p>
<ol style="list-style-type: decimal">
<li><p>Работает только с 64-битным процессором</p></li>
<li><p>Использует быструю библиотеку MKL для операций с матрицами</p></li>
<li><p>По умолчанию ставит не самые свежие пакеты, а версии пакетов, выпущенные на заданную дату. Это удобная особенность позволяет легко воспроизвести результаты работы, даже если какой-нибудь пакет кардинально изменился.</p></li>
</ol>
<p>Суровые челябинские мужики могут самостоятельно настроить R на использование быстрых библиотек для матричных операций:</p>
<p>Macos: настраиваем оптимизированную под мак библиотеку:</p>
<div class="sourceCode"><pre class="sourceCode bash"><code class="sourceCode bash"><span class="kw">cd</span> /Library/Frameworks/R.framework/Resources/lib
<span class="kw">ln</span> -sf /System/Library/Frameworks/Accelerate.framework/Frameworks/vecLib.framework/Versions/Current/libBLAS.dylib libRblas.dylib</code></pre></div>
<p>Macos: восстанавливаем дефолтную библиотеку R:</p>
<div class="sourceCode"><pre class="sourceCode bash"><code class="sourceCode bash"><span class="kw">cd</span> /Library/Frameworks/R.framework/Resources/lib
<span class="kw">ln</span> -sf libRblas.0.dylib libRblas.dylib</code></pre></div>
<p>На линуксе можно поэкспериментировать с <a href="http://edustatistics.org/nathanvan/2013/07/09/for-faster-r-use-openblas-instead-better-than-atlas-trivial-to-switch-to-on-ubuntu/">выбором разных BLAS</a></p>
</div>
<div id="install_Rstudio" class="section level3">
<h3><span class="header-section-number">1.2.3</span> Rstudio</h3>
<p>Оболочка Rstudio открытая и бесплатная. Есть платная версия Rstudio, платной в ней является круглосуточная поддержка пользователей. И иногда оболочку Rstudio путают с программой для восстановления данных R-studio, которая полностью платная.</p>
<ol style="list-style-type: decimal">
<li><p>Скачиваем <a href="https://www.rstudio.com/products/rstudio/download/">текущую версию Rstudio Desktop</a>.</p></li>
<li><p>Запускаем установщик.</p></li>
<li><p>Под Windows на вопрос установщика, куда устанавливать Rstudio, указываем папку <code>C:\Rstudio</code>.</p></li>
</ol>
<p>Проблема с Rstudio потенциально та же, что и с R: могут возникнуть трудности при использовании папки с русскими буквами и пробелами, а по умолчанию Rstudio ставится в <code>C:\Program Files\...</code>.</p>
<p>Любители заглянуть вперёд и опробовать новые фишки могут <a href="https://www.rstudio.com/products/rstudio/download/preview/">поставить preview-версию Rstudio</a>. Теоретически подобная бета-версия может быть менее устойчивой, чем обычная. По моему опыту никаких проблем со стабильностью в preview-версии не было, а приятные плюшки, ещё не вошедшие в текущую версию, есть :)</p>
<div id="-rstudio" class="section level4">
<h4><span class="header-section-number">1.2.3.1</span> Настройка Rstudio:</h4>
<ol style="list-style-type: decimal">
<li>Заходим в Tools - Global options - General:</li>
</ol>
<ul>
<li><p>Убираем галочку <code>Restore .Rdata into workspace at startup</code>.</p></li>
<li><p>В разделе <code>Save workspace to .Rdata on exit</code> выбираем <code>Never</code></p></li>
</ul>
<p>Rstudio по умолчанию при выходе сохраняет все объекты в памяти в файл, который затем подгружается при старте. Это плохая привычка. Постепенно в этом <code>.Rdata</code> файле будет накапливаться мусор. Рано или поздно мусора станет так много, что либо загрузка Rstudio будет занимать немерено времени, либо при загрузке будет происходить ошибка.</p>
<ol start="2" style="list-style-type: decimal">
<li>Заходим в <code>Tools</code> - <code>Global options</code> - <code>Sweawe</code>:</li>
</ol>
<ul>
<li>В разделе <code>Weave .Rnw files using</code> выбираем <code>knitr</code>.</li>
</ul>
<p>Для связи R с мы будем использовать более передовой <code>knitr</code>. Первопроходец Sweave сделал прекрасную работу, и его подвиги мы будем помнить и чтить :)</p>
<ol start="3" style="list-style-type: decimal">
<li>Заходим в <code>Tools</code> - <code>Global options</code> - <code>Code</code> - <code>Diagnostics</code>:</li>
</ol>
<ul>
<li>Выставляем все галки!</li>
</ul>
<p>Настоящие леди и джентельмены, а также синьоры и синьориты, пишут стильный код!</p>
</div>
</div>
</div>
<div id="other_programs" class="section level2">
<h2><span class="header-section-number">1.3</span> Тяжёловооружённая кавалерия</h2>
<p>Помимо минимального набора из R и Rstudio любопытный читатель может ознакомиться с другими полезными программами. Для этих программ я привожу скорее ссылки, а не пошаговые инструкции по установке.</p>
<div id="install_Latex" class="section level3">
<h3><span class="header-section-number">1.3.1</span> LaTeX</h3>
<p>— это система для создания красивых структурированных текстов. Читается «Латех». Пользоваться Вордом для написания курсовых или научных статей — это дурной вкус.</p>
<p>дарит возможность писать красивые математические формулы. В силу простоты текстового формата для хранения документов идеально подходит для взаимодействия с другими программами. Связав R и с помощью грамотного программирования, можно в один клик обновлять сложные отчёты при получении новых данных или избегать ошибок, связанных с копированием результатов вычислений в презентацию.</p>
<p>Под Linux основной дистрибутив — это TeXLive. Лучше всего поставить <a href="https://www.tug.org/texlive/acquire-netinstall.html">свежую версию TeXLive руками</a>.</p>
<p>После ручной инсталляции нам надо убедить Ubuntu, что ей не надо ставить из своего репозитория:</p>
<div class="sourceCode"><pre class="sourceCode bash"><code class="sourceCode bash"><span class="kw">sudo</span> apt-get install equivs freeglut3
<span class="kw">mkdir</span> -p /tmp/tl-equivs <span class="kw">&amp;&amp;</span> <span class="kw">cd</span> /tmp/tl-equivs
<span class="kw">wget</span> http://www.tug.org/texlive/files/debian-equivs-2016-ex.txt
<span class="kw">cp</span> -f debian-equivs-2016-ex.txt texlive-local
<span class="kw">equivs-build</span> texlive-local
<span class="kw">sudo</span> dpkg -i texlive-local_2016-2_all.deb</code></pre></div>
<p>Под Macos основной дистрибутив — это <a href="https://tug.org/mactex/">Mactex</a>.</p>
<p>Под Windows существует два конкурирующих дистрибутива — TexLive и Miktex. Я лично <a href="https://www.tug.org/texlive/acquire-netinstall.html">рекомендую TexLive</a>. Если выбирать <a href="http://miktex.org/download">Miktex</a>, то для установки полноценного теха надо скачать не Basic Miktex, а Net Installer!</p>
<div class="warning">
<p>
Важно ставить полную версию со всеми пакетами!
</p>
</div>
<p>Полная установка может занять больше часа, и занять несколько гигабайт жёсткого диска, но красивые документы того стоят.</p>
<p>Если нет необходимости делать красивые структурированные документы в <code>pdf</code> формате, то без можно обойтись.</p>
<p>В данном учебнике не будет серьёзного введения в , мы только затронем вопрос взаимодействия R-.</p>
<p>Хорошим введением в будет: Воронцов, <a href="http://www.ccas.ru/voron/download/voron05latex.pdf">LaTeX в примерах</a><a href="#fn1" class="footnoteRef" id="fnref1"><sup>1</sup></a></p>
</div>
<div id="install_git" class="section level3">
<h3><span class="header-section-number">1.3.2</span> git-клиент</h3>
<p>Git — это система контроля версий. Она позволяет разным авторам работать над одним проектом. Если что-то пошло не так, то можно вернуться на любой момент времени в прошлом — это бывает очень полезно :)</p>
<p>Тру-программеры работают с git из командной строки, а новичкам здорово облегчит жизнь git с графической оболочкой.</p>
<p>Для windows и macos есть оболочка Github Desktop, доступная на <a href="https://desktop.github.com/">desktop.github.com</a>.</p>
<p>В качестве альтернативы Github Desktop есть кросс-платформенный и бесплатный для некоммерческих проектов <a href="http://www.syntevo.com/smartgit/">Smartgit</a>. Будь осторожен при установке: надо вовремя поставить галочку на бесплатной версии. Иначе установится демка на 15 дней.</p>
<p>Если ты хочешь освоить git как тру-программер, то можешь начать с бесплатного курса try-git на <a href="https://www.codeschool.com/courses/try-git">codeschool.com</a>.</p>
<p>Немного стартовых настроек в командной строке macos/linux:</p>
<div class="sourceCode"><pre class="sourceCode bash"><code class="sourceCode bash"><span class="kw">git</span> config --global user.name <span class="st">&quot;Ivan Ivanov&quot;</span>
<span class="kw">git</span> config --global user.email Ivan_Ivanov@ivanov_mail.com</code></pre></div>
</div>
<div id="install_editor" class="section level3">
<h3><span class="header-section-number">1.3.3</span> Текстовый редактор</h3>
<p>Самое важное: Word — это не текстовый редактор! Текстовый редактор — это программа с помощью которой редактируют файлы с простым текстовым содержимым, а Word сохраняет файлы в специальном формате, где кроме текста сохраняется ещё куча дополнительной информации. Расширение у текстового файла может быть довольно произвольным, <code>.txt</code>, <code>.md</code>, <code>.R</code>, <code>.tex</code> и так далее.</p>
<p>Текстовых редакторов много. Я советую кросс-платформенный открытый и бесплатный Atom. Скачать его можно на <a href="https://atom.io/">atom.io</a>. Изнутри самого редактора Atom можно установить кучу плагинов. С помощью плагинов можно подсвечивать синтаксис различных языков или превратить Atom в приличную среду разработки :)</p>
<p>Дополнительные плагины для Atom ставятся через меню Atom - Preferences - Install. Для работы с R и советую поставить плагины <code>language-markdown</code>, <code>language-knitr</code>, <code>atom-beautify</code>.</p>
</div>
<div id="install_jupyter" class="section level3">
<h3><span class="header-section-number">1.3.4</span> jupyter</h3>
<p>jupyter — это браузерная оболочка для кучи языков программирования. Сокращение jupyter намекает на три языка наиболее пригодных для научных вычислений: julia, python и R. Проще всего установить дистрибутив Anaconda, в него входит и python, и jupyter.</p>
<ol style="list-style-type: decimal">
<li>Скачиваем анаконду с <a href="https://www.continuum.io/downloads">www.continuum.io</a></li>
</ol>
<p>Есть две версии python: вторая и третья. Третья — более новая, но под вторую написано много того, что под третьей ещё не рабоет. Если не знаешь, какой python тебе нужен, значит, тебе нужен третий.</p>
<p>Далее нужно зарегистрировать R в jupyter’е:</p>
<ol start="2" style="list-style-type: decimal">
<li><p>Запускаем R. Под Linux и Macos важно запустить R из командной строки. Именно из командной строки, а не из под Rstudio, иначе <a href="http://stackoverflow.com/questions/38064177">чуда не произойдёт</a>.</p></li>
<li><p>Далее инструкция с <a href="https://github.com/IRkernel/IRkernel">github.com/IRkernel/IRkernel</a>:</p></li>
</ol>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">install.packages</span>(<span class="kw">c</span>(<span class="st">&#39;repr&#39;</span>, <span class="st">&#39;IRdisplay&#39;</span>, <span class="st">&#39;crayon&#39;</span>, <span class="st">&#39;pbdZMQ&#39;</span>, <span class="st">&#39;devtools&#39;</span>))
devtools::<span class="kw">install_github</span>(<span class="st">&#39;IRkernel/IRkernel&#39;</span>)
IRkernel::<span class="kw">installspec</span>()  <span class="co"># to register the kernel in the current R installation</span></code></pre></div>
<ol start="4" style="list-style-type: decimal">
<li>Для корректного сохранения блокнота в pdf на Linux/Macos ставим мелочи:</li>
</ol>
<div class="sourceCode"><pre class="sourceCode bash"><code class="sourceCode bash"><span class="kw">pip</span> install nbbrowserpdf</code></pre></div>
<p>Запуск jupyter из командной строке на Linux/Macos:</p>
<div class="sourceCode"><pre class="sourceCode bash"><code class="sourceCode bash"><span class="kw">jupyter</span> notebook</code></pre></div>
<p>Чтобы работало сохранение <code>pdf</code> с русскими буквами нужно руками подменить дефолтный шаблон.</p>
</div>
<div id="install_lyx" class="section level3">
<h3><span class="header-section-number">1.3.5</span> LyX</h3>
<p>Многие пользователи, привыкшие к Ворду, тяжело переходят на . Ведь в текстовом редакторе не видно формулу в привычном виде, а виден только её код. Редактор LyX заполняет эту нишу: используя за кадром тех, он показывает пользователю формулы, таблицы и рисунке в естественном виде. При этом LyX отлично взаимодействует с R.</p>
<p>Недостатком LyX, пожалуй, является его невысокая популярность. Пользователи, боящиеся , сидят в Ворде, а те, кто понял прелести , уже не хотят ничего вспомогательного :)</p>
<p>Windows и Macos: скачиваем с <a href="https://www.lyx.org">lyx.org</a>.</p>
<p>Linux (Ubuntu 16.04):</p>
<div class="sourceCode"><pre class="sourceCode bash"><code class="sourceCode bash"><span class="kw">sudo</span> add-apt-repository ppa:lyx-devel/release
<span class="kw">sudo</span> apt-get update
<span class="kw">sudo</span> apt-get install lyx</code></pre></div>
</div>
<div id="install_font" class="section level3">
<h3><span class="header-section-number">1.3.6</span> Шрифты</h3>
<p>При создании готовых документов автору нужно подумать о шрифте!</p>
<p>У windows и macos есть встроенные программы управления шрифтами. Для linux (Ubuntu 16.04) просмотрщик шрифтов легко поставить:</p>
<div class="sourceCode"><pre class="sourceCode bash"><code class="sourceCode bash"><span class="kw">sudo</span> add-apt-repository ppa:font-manager/staging
<span class="kw">sudo</span> apt-get update
<span class="kw">sudo</span> apt-get install font-manager</code></pre></div>
<p>Шрифты могут быть записаны в разных форматах. Основные — это TTF, OTF и Post-script. Рядовой пользователь может смело выбирать TTF или OTF, а Post-script нужен скорее дизайнерам и типографам.</p>
<p>В pdf-версии данного учебника используется шрифт Linux Libertine OTF. Он открытый, бесплатный и содержит буквы как русского, так и многих других алфавитов. Скачать можно на <a href="http://www.linuxlibertine.org/index.php?id=1&amp;L=1">linuxlibertine.org</a>.</p>
</div>
<div id="pandoc" class="section level3">
<h3><span class="header-section-number">1.3.7</span> Pandoc</h3>
<p>Pandoc — это конвертер текстовых форматов. Он умеет превращать файлы в формате маркдаун, <code>md</code>, во всё, что движется: <code>tex</code>, <code>pdf</code>, <code>docx</code>, <code>epub</code>, <code>html</code>, …</p>
<p>Pandoc входит комплект Rstudio, поэтому отдельно его ставить не нужно.</p>
<p>Впрочем, можно поставить Pandoc и отдельно, без Rstudio. Под windows и macos можно скачать установщик с официального сайта <a href="http://pandoc.org/installing.html">pandoc.org</a>.</p>
<p>А под linux (Ubuntu 16.04) можно поставить pandoc из командной строки:</p>
<div class="sourceCode"><pre class="sourceCode bash"><code class="sourceCode bash"><span class="kw">sudo</span> apt-get install pandoc pandoc-citeproc</code></pre></div>
</div>
<div id="install_gretl" class="section level3">
<h3><span class="header-section-number">1.3.8</span> gretl</h3>
<p>Тебе страшно? Ты боишься R, а регрессию надо построить через 5 минут? Тогда разумное спасение — это эконометрический пакет gretl. Для gretl не обязательно учиться программировать: статистические тесты, графики и эконометрические модели доступны через меню. Кроме того, gretl даёт возможность пользователю взаимодействовать с R, что спасает в тех случаях, когда возможностей gretl не хватает.</p>
<p>Естественно, gretl кросс-платформенный открытый и бесплатный, скачать можно с официального сайта <a href="http://gretl.sourceforge.net/">gretl.sourceforge.net</a>.</p>
</div>
</div>
<div id="funny_calc" class="section level2">
<h2><span class="header-section-number">1.4</span> Весёлый калькулятор</h2>
<p>R можно использовать как весёлый калькулятор:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="dv">5</span> +<span class="st"> </span><span class="dv">9</span></code></pre></div>
<pre><code>## [1] 14</code></pre>
<p>Что-нибудь более интересное, например, <span class="math inline">\(4! + 2^3 + C_4^2\)</span>:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">a &lt;-<span class="st"> </span><span class="kw">factorial</span>(<span class="dv">4</span>)
b &lt;-<span class="st"> </span><span class="dv">2</span>^<span class="dv">3</span>
a +<span class="st"> </span>b +<span class="st"> </span><span class="kw">choose</span>(<span class="dt">n =</span> <span class="dv">4</span>, <span class="dt">k =</span> <span class="dv">2</span>)</code></pre></div>
<pre><code>## [1] 38</code></pre>
<p>Признайся, ты всегда мечтал пошалить? Давай, пока никто не видит, поделим на ноль?</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">a &lt;-<span class="st"> </span><span class="dv">1</span> /<span class="st"> </span><span class="dv">0</span>
a</code></pre></div>
<pre><code>## [1] Inf</code></pre>
<p>Что можно делать с бесконечностью, <code>Inf</code>?</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="dv">1</span> /<span class="st"> </span>(<span class="ot">Inf</span> -<span class="st"> </span><span class="dv">9</span>)</code></pre></div>
<pre><code>## [1] 0</code></pre>
<p>Возьмём арктангенс!</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">atan</span>(<span class="ot">Inf</span>)</code></pre></div>
<pre><code>## [1] 1.570796</code></pre>
<p>Ба! Да это же <span class="math inline">\(\pi/2\)</span>:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">pi /<span class="st"> </span><span class="dv">2</span></code></pre></div>
<pre><code>## [1] 1.570796</code></pre>
<p>Но с неопределенностью ничего не поделаешь:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="dv">0</span> /<span class="st"> </span><span class="dv">0</span></code></pre></div>
<pre><code>## [1] NaN</code></pre>
<p>Сокращение NaN означает «Not a Number», такой объект возникает в результате запрещённых арифметических операций.</p>
<p>Также в дебрях R живёт другой интересный зверь — NA, «Not Available», пропущенное наблюдение. Наблюдение может быть пропущенным по разным причинам: может быть его не было изначально, а может оно родилось в результате запрещённых арифметических операций. Поэтому всякое NaN является NA, но не всякое NA является NaN. Проверять, является ли что-либо NA или NaN, можно так:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">is.na</span>(<span class="dv">0</span> /<span class="st"> </span><span class="dv">0</span>)</code></pre></div>
<pre><code>## [1] TRUE</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">is.nan</span>(<span class="dv">0</span> /<span class="st"> </span><span class="dv">0</span>)</code></pre></div>
<pre><code>## [1] TRUE</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">a &lt;-<span class="st"> </span><span class="ot">NA</span>
<span class="kw">is.na</span>(a)</code></pre></div>
<pre><code>## [1] TRUE</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">is.nan</span>(a)</code></pre></div>
<pre><code>## [1] FALSE</code></pre>
<div id="simple_vector_ops" class="section level4">
<h4><span class="header-section-number">1.4.0.1</span> Простые операции с векторами</h4>
<p>Вектор из чисел по порядку:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">a &lt;-<span class="st"> </span><span class="dv">3</span>:<span class="dv">10</span>
a</code></pre></div>
<pre><code>## [1]  3  4  5  6  7  8  9 10</code></pre>
<p>Вектор из одинаковых чисел:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">b &lt;-<span class="st"> </span><span class="kw">rep</span>(<span class="dv">777</span>, <span class="dt">times =</span> <span class="dv">5</span>)
b</code></pre></div>
<pre><code>## [1] 777 777 777 777 777</code></pre>
<p>Вектор из конкретных чисел:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">vect &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="dv">5</span>, -<span class="dv">4</span>, <span class="dv">1</span>)
vect</code></pre></div>
<pre><code>## [1]  5 -4  1</code></pre>
<p>Что можно делать с вектором?</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">sum</span>(vect)</code></pre></div>
<pre><code>## [1] 2</code></pre>
<p>Хотите среднее арифметическое?</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">mean</span>(vect)</code></pre></div>
<pre><code>## [1] 0.6666667</code></pre>
<p>Если в векторе есть пропущенные значение, <code>NA</code>, то есть два варианта подсчёта среднего:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">v_na &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">3</span>, <span class="ot">NA</span>)
<span class="kw">mean</span>(v_na)</code></pre></div>
<pre><code>## [1] NA</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">mean</span>(v_na, <span class="dt">na.rm =</span> <span class="ot">TRUE</span>)</code></pre></div>
<pre><code>## [1] 2</code></pre>
<p>Команда <code>mean(v_na)</code> выдаст <code>NA</code>, а команда <code>mean(v_na, na.rm = TRUE)</code> удалит из вектора все <code>NA</code> и потом посчитает среднее.</p>
<p>Ещё одна полезная штучка — количество элементов в векторе:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">length</span>(b)</code></pre></div>
<pre><code>## [1] 5</code></pre>
</div>
<div id="value_selection" class="section level3">
<h3><span class="header-section-number">1.4.1</span> Отбор элементов вектора</h3>
<p>Выберем из вектора <span class="math inline">\(s\)</span> значения больше <span class="math inline">\(0\)</span>:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># случайная выборка из 40 равномерно распределённых на [-3;1] чисел:</span>
s &lt;-<span class="st"> </span><span class="kw">runif</span>(<span class="dv">40</span>, <span class="dt">min =</span> -<span class="dv">3</span>, <span class="dt">max =</span> <span class="dv">1</span>)
b &lt;-<span class="st"> </span>s[s &gt;<span class="st"> </span><span class="dv">0</span>] <span class="co"># отбираем те s, что больше нуля</span>
b</code></pre></div>
<pre><code>##  [1] 0.9668179 0.4191308 0.7099391 0.8840982 0.7694346 0.8660118 0.3475744
##  [8] 0.7091967 0.1616006 0.8250308 0.8313753</code></pre>
<p>С точки зрения R, <code>s &gt; 0</code> — это вектор из TRUE/FALSE:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">s &gt;<span class="st"> </span><span class="dv">0</span></code></pre></div>
<pre><code>##  [1]  TRUE FALSE FALSE  TRUE FALSE  TRUE FALSE FALSE FALSE FALSE FALSE
## [12] FALSE FALSE FALSE FALSE  TRUE  TRUE  TRUE FALSE  TRUE  TRUE FALSE
## [23]  TRUE FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE
## [34] FALSE FALSE  TRUE  TRUE FALSE FALSE FALSE</code></pre>
<p>В отличие от python и C++ элементы вектора в R нумеруются начиная с первого.</p>
<p>Можно выбрать конкретные <span class="math inline">\(s\)</span>, например с 6-го по 20-ое:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">s[<span class="dv">6</span>:<span class="dv">20</span>]</code></pre></div>
<pre><code>##  [1]  0.7099391 -1.5762391 -2.1788037 -2.5435254 -1.9767582 -1.0806755
##  [7] -2.2989907 -1.5685530 -0.1115747 -1.6647615  0.8840982  0.7694346
## [13]  0.8660118 -1.2605650  0.3475744</code></pre>
<p>Хочу 5-ый, 7-ой и 13-ый элементы вектора!</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">s[<span class="kw">c</span>(<span class="dv">5</span>, <span class="dv">7</span>, <span class="dv">13</span>)]</code></pre></div>
<pre><code>## [1] -0.9627514 -1.5762391 -1.5685530</code></pre>
<p>Можно узнать, сколько значений <code>s</code> больше нуля:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">sum</span>(s &gt;<span class="st"> </span><span class="dv">0</span>)</code></pre></div>
<pre><code>## [1] 11</code></pre>
</div>
<div id="number_comparison" class="section level3">
<h3><span class="header-section-number">1.4.2</span> Сравнение чисел — штука тонкая</h3>
<p>Правда ли, что 0.4 + 0.1 равно 0.5?</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="fl">0.4</span> +<span class="st"> </span><span class="fl">0.1</span> ==<span class="st"> </span><span class="fl">0.5</span></code></pre></div>
<pre><code>## [1] TRUE</code></pre>
<p>А правда ли, что 0.4 - 0.1 равно 0.3?</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="fl">0.4</span> -<span class="st"> </span><span class="fl">0.1</span> ==<span class="st"> </span><span class="fl">0.3</span></code></pre></div>
<pre><code>## [1] FALSE</code></pre>
<p>Хм, что-то Марь Иванна в школе другое говорила…</p>
<p>Почему так случилось? Компьютер хранит числа в памяти в двоичной системе счисления. В двоичной системе обычное число 0.1 будет записываться в виде бесконечной периодической дроби. Следовательно, без дополнительных ухищрений храниться в памяти абсолютно точно оно не может. Поэтому де-факто компьютер хранит в памяти округленную версию от 0.4, 0.1 и 0.3. В данном случае при вычитании ошибки округления не компенсируют друг друга.</p>
Мораль из этого примера проста:
<div class="warning">
<p>
При операциях с дробными числами помни: компьютер считает примерно!
</p>
</div>
<p>Скорее всего, проверка точного равенства потенциально дробных чисел не нужна. Вместо неё бывает осмысленна проверка примерного равенства:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">all.equal</span>(<span class="fl">0.4</span> -<span class="st"> </span><span class="fl">0.1</span>, <span class="fl">0.3</span>)</code></pre></div>
<pre><code>## [1] TRUE</code></pre>
<p>Единственный нюанс. Оператор <code>==</code> выдаёт результат типа <code>TRUE</code>/<code>FALSE</code>, а функция <code>all.equal</code> может выдать развёрнутый ответ текстом. Поэтому, если нужно использовать функцию <code>all.equal</code> после проверки условия <code>if</code>, то её нужно обрамить в <code>isTRUE</code>:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">if (<span class="kw">isTRUE</span>(<span class="kw">all.equal</span>(a, b))) {
  ...
}</code></pre></div>
</div>
</div>
<div id="first_script" class="section level2">
<h2><span class="header-section-number">1.5</span> Первый скрипт</h2>
<p>….</p>
<p>Если текст программы содержит русские или другие неанглийские буквы, например, в комментариях, то при сохранении файла Rstudio предложит выбрать кодировку.</p>
<p>картинка</p>
<p>Кодировка определяет какой конкретно числовой код будет сопоставлен в записанном файле каждой букве. Например, букве <code>ё</code> в кодировке UTF-8 сопоставлен десятичный<a href="#fn2" class="footnoteRef" id="fnref2"><sup>2</sup></a> код 1105.</p>
<p>Для русского языка есть несколько распространённых кодировок: UTF-8 и CP1251. Linux и Macos используют по умолчанию кодировку UTF-8, а вот Windows<a href="#fn3" class="footnoteRef" id="fnref3"><sup>3</sup></a> сохраняет простые текстовые файлы в кодировке CP1251.</p>
<p>Если русскоязычный файл записать в одной кодировке, а пытаться открыть с помощью другой, то мы увидим на экране “кракозябры”. Поэтому хорошо, когда все используют одну кодировку. Кодировка UTF-8 более универсальна, чем CP1251. Например, с помощью кодировки UTF-8 в одном тексте можно использовать и русские буквы и французские акценты и китайские иероглифы.</p>
<div class="warning">
<p>
Мы всегда будем использовать кодировку UTF-8.
</p>
</div>
</div>
<div id="packages" class="section level2">
<h2><span class="header-section-number">1.6</span> Установка и подключение пакетов</h2>
<p>Одна из сильных сторон R — это открытость: каждая домохозяйка может написать свой пакет для R и выложить его в публичное пользование. Основные операции, например, сложение и умножение чисел или построение множественной регрессии, реализованы в базовом R и не требуют подключения пакетов. Более сложные операции, например, работа с панельными данными или построение сложных графиков, требуют подключения дополнительных пакетов.</p>
<p>Каждый пакет содержив в себе набор функций, расширяющих возможности R. Для R написано более 10 тысяч пакетов. Среди них есть и откровенный мусор, и бриллианты, например, <code>ggplot2</code>, настолько ценные, что их копируют в другие языки программирования.</p>
<p>Скорее всего нужный тебе пакет можно найти:</p>
<ol style="list-style-type: decimal">
<li>В официальном хранилище пакетов R, CRAN.</li>
</ol>
<p>Здесь пакеты прошли минимальное тестирование. Это отнюдь не гарантия качества пакета, но всё же серьёзный, давно функционирующий пакет, наверняка, будет выложен на CRAN.</p>
<ol start="2" style="list-style-type: decimal">
<li>В системе репозиториев <a href="https://github.com/">github.com</a>.</li>
</ol>
<p>Здесь, как правило, разработчики публикуют более свежие версии пакетов, ещё не выложенные на CRAN, или молодые пакеты в процессе разработки.</p>
<ol start="3" style="list-style-type: decimal">
<li>В хранилище пакетов для биологов <code>bioconductor</code>.</li>
</ol>
<p>Это своя отдельная экосистема пакетов R со специальным инсталлятором, блэкджеком и поэтэссами.</p>
<p>Есть и другие хранилища пакетов, например, R-forge, <a href="http://r-forge.r-project.org/">r-forge.r-project.org</a> и Rforge, <a href="https://rforge.net/">rforge.net</a>, но они гораздо менее популярны.</p>
<p>Чтобы начать использовать какой-нибудь пакет R нужно сделать две вещи:</p>
<ol style="list-style-type: decimal">
<li>Установить пакет</li>
</ol>
<p>Установка означает, что пакет будет скачан из Интернета и сохранён в специальной папке на жёстком диске. Установка пакета выполняется <strong>один раз</strong>. Каждый раз при использовании пакета устанавливать его <strong>не нужно</strong>. Переустанавливать пакет имеет смысл, только если вышла новая его версия.</p>
<ol start="2" style="list-style-type: decimal">
<li>Подключить пакет (attach package)</li>
</ol>
<p>Подключение пакета выполняется <strong>каждый раз</strong> перед его использованием. Пакеты подключаются командой <code>library(&quot;имя пакета&quot;)</code>.</p>
<p>Очень часто <strong>пакеты</strong> R ошибочно называют библиотеками. <strong>Библиотека</strong> — это папка на жёстком диске компьютера, где хранятся пакеты.</p>
<p>Для установки различных пакетов, работающих с Интернетом под Linux может потребоваться установка дополнительных библиотек:</p>
<div class="sourceCode"><pre class="sourceCode bash"><code class="sourceCode bash"><span class="kw">sudo</span> apt-get install libssl-dev libcurl4-openssl-dev libxml2-dev</code></pre></div>
<div id="-----cran" class="section level3">
<h3><span class="header-section-number">1.6.1</span> Установка пакета с официального репозитория CRAN</h3>
<p>С репозитория CRAN пакет ставится командой R:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">install.packages</span>(<span class="st">&quot;имя пакета&quot;</span>)</code></pre></div>
<p>В Rstudio установить пакет с репозитория CRAN можно через меню: <code>Tools</code> - <code>Install</code> packages. Далее нужно набрать название пакета, можно указать сразу несколько названий через пробел, и нажать <code>Install</code>.</p>
<div class="warning">
<p>
Главное при установке пакета — не бояться сообщений красным цветом!
</p>
</div>
<p>Любые <strong>сообщения</strong> (messages) R выводит красным цветом и по неопытности их можно принять за ошибку, что скорее всего не так. Ошибка всегда сопровождается словом <font color='red'>Error</font>. Если слова <font color='red'>Error</font> нет, то всё идёт по плану!</p>
<p>Почему R использует красный цвет? Потому, что установка пакета — это потенциально опасное действие, как и установка любой программы. Пакеты на официальном репозитории CRAN проходят определённую проверку, но если ты используешь R для многомиллионных сделок каждый день, то неплохо бы точно знать, что ты ставишь :)</p>
<p>Для примера установим с репозитория CRAN пакет для построения графиков <code>ggplot2</code>:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">install.packages</span>(<span class="st">&quot;ggplot2&quot;</span>)</code></pre></div>
<p>Напомним, что <strong>установка</strong> пакетов выполняется <strong>один раз</strong>.</p>
</div>
<div id="----bioconductor" class="section level3">
<h3><span class="header-section-number">1.6.2</span> Установка пакета с репозитория <code id="bioconductor">bioconductor</code></h3>
<p>О пакетах для биологов подробно написано на официальном сайте <a href="https://www.bioconductor.org/">bioconductor.org</a>. Поставить основную часть подборки можно парой команд:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">source</span>(<span class="st">&quot;https://bioconductor.org/biocLite.R&quot;</span>)
<span class="kw">biocLite</span>()</code></pre></div>
<p>Также можно поставить и любой конкретный пакет из биологической подборки. Например, поставим пакет <code>mygene</code> для перевода наименований генов из одной системы в другую:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">biocLite</span>(<span class="st">&quot;mygene&quot;</span>)</code></pre></div>
</div>
<div id="attach_and_use" class="section level3">
<h3><span class="header-section-number">1.6.3</span> Подключение и использование пакетов</h3>
<p>После того, как пакет <code>ggplot2</code> установлен можно его <strong>подключить</strong></p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(<span class="st">&quot;ggplot2&quot;</span>)</code></pre></div>
<p>И начать использовать :) Здесь мы лишь быстренько построим гистограмму для случайной выборки из нормального распределения, а с красотами <code>ggplot2</code> ознакомимся позже:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">x &lt;-<span class="st"> </span><span class="kw">rnorm</span>(<span class="dv">100</span>)
<span class="kw">qplot</span>(x)</code></pre></div>
<pre><code>## `stat_bin()` using `bins = 30`. Pick better value with `binwidth`.</code></pre>
<p><img src="01_first_steps_files/figure-html/unnamed-chunk-22-1.png" width="672" /></p>
<p>Функция <code>qplot</code> содержится в пакете <code>ggplot2</code>. Если пакет не установлен, или установлен, но не подключен, то R выдаст ошибку <code>Error: could not find function &quot;qplot&quot;</code>.</p>
<p>Иногда разумно использовать команды из какого-нибудь пакета не подключая его командой <code>library</code>. Тогда надо явно указать имя пакета перед функцией, как в C++:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">x &lt;-<span class="st"> </span><span class="kw">rnorm</span>(<span class="dv">100</span>)
ggplot2::<span class="kw">qplot</span>(x)</code></pre></div>
<pre><code>## `stat_bin()` using `bins = 30`. Pick better value with `binwidth`.</code></pre>
<p><img src="01_first_steps_files/figure-html/unnamed-chunk-23-1.png" width="672" /></p>
<p>При подключении пакета, как и при его установке, не стоит пугаться сообщений красным шрифтом. Только явное слово <code>Error</code> говорит об ошибке. Кроме того, часто можно столкнуться с <strong>предупреждением</strong> (warning) о том, что пакет был создан для более новой версии R.</p>
<p><font color='red'>Warning message: package ‘xxx’ was built under R version 3.3.1</font></p>
<p>Это нестрашно. Это означает лишь, что у разработчика пакета <code>xxx</code> установлена более свежая версия R, чем у тебя. Обновлять R на своём компьютере при каждом его мелком обновлении, пожалуй, неразумно, но раз в полгода стоит.</p>
<div class="warning">
<p>
Правила хорошего тона советуют подключать все нужные пакеты в начале скрипта.
</p>
</div>
<p>Часть пакетов, например, пакет <code>stats</code>, входит в ядро R. Пакеты из ядра R не требуется подключать явно, поэтому функции из пакета <code>stats</code> доступны и без выполнения <code>library(&quot;stats&quot;)</code>.</p>
</div>
<div id="-----github" class="section level3">
<h3><span class="header-section-number">1.6.4</span> Установка пакетов с репозитория на github</h3>
<p>Установить пакет с github.com немногим сложнее. Здесь надо знать не только название пакета, но и название репозитория, где пакет хранится. Часто название репозитория — это фамилия автора пакета. Официальной классификации всех пакетов R на github нет. Можно воспользоваться поисковиком github-пакетов на <a href="https://r-how.com/packages/github_repo">r-how.com/packages/github_repo</a> или погуглить.</p>
<p>Кроме того, для установки пакетов с github.com потребуется установить вспомогательный пакет для разработчиков, <code>devtools</code>:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">install.packages</span>(<span class="st">&quot;devtools&quot;</span>)</code></pre></div>
<p>После того, как <code>devtools</code> установлен, мы можем устанавливать любой пакет с репозиториев на github. Например, установим самую свежую версию графического пакета <code>ggplot2</code> с репозитория <code>tidyverse</code>:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">devtools::<span class="kw">install_github</span>(<span class="st">&quot;tidyverse/ggplot2&quot;</span>)</code></pre></div>
</div>
<div id="---" class="section level3">
<h3><span class="header-section-number">1.6.5</span> Какие пакеты мне нужны?</h3>
<p>Джентельменский набор пакетов R зависит от сферы деятельности, но практически всем, сталкивающимся с анализом данных, пригодится пакет-коллекция <code>tidyverse</code>. Ставится коллекция <code>tidyverse</code> стандартно:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">install.packages</span>(<span class="st">&quot;tidyverse&quot;</span>)</code></pre></div>
<p>Например, в коллекцию <code>tidyverse</code> входят:</p>
<ul>
<li><code>ggplot2</code> для построения шикарных двумерных графиков</li>
<li><code>tidyr</code> для причёсывания наборов данных</li>
<li><code>readr</code> для чтения данных</li>
<li><code>dplyr</code> для манипуляций с данными</li>
<li><code>forcats</code> для работы с качественными данными</li>
</ul>
<p>Подключить пакет-коллекцию можно одной командой:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(<span class="st">&quot;tidyverse&quot;</span>)</code></pre></div>
<p>В официальном классификаторе пакетов R <a href="https://cran.r-project.org/web/views/">cran.r-project.org/web/views</a> можно найти тематические подборки по эконометрике, временным рядам и другим сюжетам. В R для всего есть пакет :) Для того, чтобы установить тематическую подборку пакетов тоже есть пакет, называется <code>ctv</code>. Поставим пакет <code>ctv</code> и с помощью него установим эконометрическую подборку пакетов:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">install.package</span>(<span class="st">&quot;ctv&quot;</span>)
ctv::<span class="kw">install.views</span>(<span class="st">&quot;Econometrics&quot;</span>)</code></pre></div>
<p>Каждый пакет из подборки подключается своей отдельной командой. Например, после установки подборки <code>Econometrics</code> можно подключить пакет <code>quantreg</code> для квантильной регрессии:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(<span class="st">&quot;quantreg&quot;</span>)</code></pre></div>
<p>И, конечно, чтобы найти нужный пакет можно погуглить или поискать похожий вопрос на <a href="http://stats.stackexchange.com/">stats.stackexchange.com</a>.</p>
</div>
</div>
<div id="io" class="section level2">
<h2><span class="header-section-number">1.7</span> Чтение и запись данных</h2>
<p>Прежде всего неплохо бы знать, где лежит на жёстком диске файл с нужными данными. Напомню, что названия файлов и папок не должны содержать русских букв и пробелов!</p>
<p>У R есть понятие <strong>рабочей папки</strong> (working folder). В рабочей папке R ищет все требуемые файлы. Одно из простых решений — указать в качестве рабочей папки ту, где лежит нужный файл и далее прочитать его.</p>
<p>Допустим, нужный нам файл лежит в папке <code>C:/project_A/data/</code>. Тогда для установки рабочей папки достаточно выполнить команду:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">setwd</span>(<span class="st">&quot;C:/project_A/data/&quot;</span>)</code></pre></div>
<p>Вместо этой команды можно воспользоваться меню Rstudio: <code>Session</code> - <code>Set working directory</code> - <code>Choose directory</code>. Далее выбрать нужную папку и нажать <code>Open</code>.</p>
<p>После этого можно прочитать нужный нам файл. Начнём с пакета <code>rio</code> позволяющего импортировать данные практически любого типа. На самом деле авторы пакета <code>rio</code> просто объединили усилия многих разработчиков в единую команду. И получилось хорошо :)</p>
<p>Хочешь загрузить данные в формате <code>.csv</code>? Пожалуйста!</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">data &lt;-<span class="st"> </span>rio::<span class="kw">import</span>(<span class="st">&quot;имя_файла.csv&quot;</span>)</code></pre></div>
<p>Хочешь загрузить данные в формате <code>.xlsx</code>? Пожалуйста!</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">data &lt;-<span class="st"> </span>rio::<span class="kw">import</span>(<span class="st">&quot;имя_файла.xlsx&quot;</span>)</code></pre></div>
<p>Однако не всегда всё идёт гладко, поэтому остановимся подробнее на распространённых форматах хранения данных.</p>
</div>
<div id="popular_formats" class="section level2">
<h2><span class="header-section-number">1.8</span> Распространённые форматы</h2>
<div id="comma-separated-values-sv" class="section level3">
<h3><span class="header-section-number">1.8.1</span> Comma separated values: сsv</h3>
<blockquote>
<p>— Иван, ты знаешь, у нас в Чили есть нестандартные обозначения. Мы используем десятичную запятую вместо точки, умножение пишем точкой, а не крестиком, деление — двумя точками, а при измерении температуры пользуемся градусами Цельсия. Я уверен, что ты сможешь поправить все по-своему, как привыкли дети в России.</p>
</blockquote>
<blockquote>
<p>— Разумеется, Раймундо, сделаем. Это не составит труда.</p>
</blockquote>
<blockquote>
<p>Со стены Ивана Высоцкого вконтакте</p>
</blockquote>
<p>Формат <code>.csv</code>, comma separated values, «значения разделённые запятыми», является самым простым и, пожалуй, самым распространённым. Практически любой статистический софт умеет читать и сохранять данные в формате <code>.csv</code>. Поэтому часто <code>.csv</code> файлы используют, чтобы перебросить данные из одной программы в другую.</p>
<p>Классический <code>.csv</code> файл выглядит примерно так:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">id, height, weight, sex
<span class="dv">1</span>, <span class="dv">180</span>, <span class="fl">80.5</span>, Male
<span class="dv">2</span>, <span class="dv">160</span>, <span class="fl">62.5</span>, Female
<span class="dv">3</span>, <span class="dv">150</span>, <span class="fl">51.0</span>, Female
<span class="dv">4</span>, <span class="dv">170</span>, <span class="fl">83.5</span>, Male
...</code></pre></div>
<p>В первой строке <code>.csv</code> файла, как правило, через запятую перечислены названия переменных. В последующих строках идут сами данные. Название формата, <code>comma separated values</code> означает, что <strong>по стандарту</strong> различные переменные должны быть разделены запятыми. Целая часть числа должна отделяться от дробной точкой.</p>
<p>Классический, соответствующий стандарту, <code>.csv</code> файл прекрасно импортируется командой <code>import</code> из пакета <code>rio</code>:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">data &lt;-<span class="st"> </span>rio::<span class="kw">import</span>(<span class="st">&quot;имя_файла.csv&quot;</span>)</code></pre></div>
<p>Также для классического <code>.csv</code> подойдёт функция <code>read_csv</code> из пакета <code>readr</code>:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">data &lt;-<span class="st"> </span>readr::<span class="kw">read_csv</span>(<span class="st">&quot;имя_файла.csv&quot;</span>)</code></pre></div>
<p>Однако на практике можно столкнуться и с «чилийским» <code>.csv</code>. В «чилийском» <code>.csv</code> файле дробная часть числа будет отделяться от целой с помощью запятой. Поэтому различные переменные будут отделяться точкой с запятой. Например, англоязычная версия MS Excel сохраняет классический <code>.csv</code>, а русскоязычная — чилийский.</p>
<p>Чилийский <code>.csv</code> выглядит примерно так:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">id; height; weight; sex
<span class="dv">1</span>; <span class="dv">180</span>; <span class="dv">80</span>,<span class="dv">5</span>; Male
<span class="dv">2</span>; <span class="dv">160</span>; <span class="dv">62</span>,<span class="dv">5</span>; Female
<span class="dv">3</span>; <span class="dv">150</span>; <span class="dv">51</span>,<span class="dv">0</span>; Female
<span class="dv">4</span>; <span class="dv">170</span>; <span class="dv">83</span>,<span class="dv">5</span>; Male
...</code></pre></div>
<p>Чилийский <code>.csv</code> можно прочитать функцией <code>read_csv2</code> из пакета <code>readr</code>:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">data &lt;-<span class="st"> </span>readr::<span class="kw">read_csv2</span>(<span class="st">&quot;имя_файла.csv&quot;</span>)</code></pre></div>
<p>Чилийским данный формат называется потому, что является национальным стандартом в Чили. Дробную часть числа от целой отделяют запятой также в Бразилии, Росии, Франции и некоторых других странах.</p>
<p>Возможны и другие вариации <code>.csv</code> файла. Все отличия между разными вариантами <code>.csv</code> файла описываются тремя пунктами:</p>
<ol style="list-style-type: decimal">
<li>Первая строка файла может содержать короткие названия переменных или же сразу первое наблюдение.</li>
<li>В качестве разделителя дробной и целой части может использоваться запятая, точка, табуляция или просто пробел.</li>
<li>В качестве разделителя столбцов может использоваться запятая или точка с запятой.</li>
</ol>
<p>Данные из <code>.csv</code> файла можно загрузить в память компьютера также через меню <code>Rstudio</code>: <code>File</code> - <code>Import Dataset</code> - <code>From CSV</code>. Можно выставить требуемые опции, а <code>Rstudio</code> подскажет необходимый код R.</p>
</div>
<div id="-excel-xls--xlsx" class="section level3">
<h3><span class="header-section-number">1.8.2</span> Форматы Excel: xls и xlsx</h3>
<p>Самое главное: если есть возможность экспортировать данные из Excel в формат <code>.csv</code>, то лучше воспользоваться ей. Формат <code>.csv</code> проще и надёжнее.</p>
<p>Excel сохраняет файлы в двух форматах: старом <code>.xls</code> и новом <code>.xlsx</code>. Если выбор стоит между этими форматами, то лучше сохранять в новом <code>.xlsx</code>. Чтобы быстро и удачно импортировать данные из Excel в R нужно максимально стандартно оформить их на листе. А именно:</p>
<ol style="list-style-type: decimal">
<li><p>На листе должны быть только данные. Никаких графиков и фильтров.</p></li>
<li><p>В первой строке листа должны идти названия столбцов. Названия столбцов должны быть короткие, без пробелов, на английском языке. Хорошо: <code>rabbit_weight</code>, плохо: <code>Вес кролика</code>.</p></li>
<li><p>Не должно быть объединённых ячеек, шрифтов разного размера и выделения цветом.</p></li>
<li><p>Пропущенные значения лучше кодировать с помощью записи <code>NA</code>.</p></li>
</ol>
<p>Файлы форматов <code>.xlsx</code> или <code>.xls</code> можно прочитать с помощью команды <code>read_excel</code> из пакета <code>readxl</code>:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">data &lt;-<span class="st"> </span>readxl::<span class="kw">read_excel</span>(<span class="st">&quot;имя_файла.xlsx&quot;</span>)</code></pre></div>
<p>Также эти форматы можно загрузить в память компьютера через меню <code>Rstudio</code>: <code>File</code> - <code>Import Dataset</code> - <code>From Excel</code>. Можно выставить требуемые опции, а <code>Rstudio</code> подскажет необходимый код R.</p>
</div>
<div id="-spss-sav" class="section level3">
<h3><span class="header-section-number">1.8.3</span> Формат SPSS: sav</h3>
<p>Как и в случае с Excel, если есть возможность сохранить данные в формате <code>.csv</code>, то лучше воспользоваться ею. Если такой возможности нет, то поможет пакет <code>haven</code> и функция <code>read_spss</code>:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">data &lt;-<span class="st"> </span>haven::<span class="kw">read_spss</span>(<span class="st">&quot;имя файла.sav&quot;</span>)</code></pre></div>
<p>Также можно воспользоваться меню <code>Rstudio</code>: <code>File</code> - <code>Import Dataset</code> - <code>From spss</code>.</p>
</div>
<div id="-eviews-wf1" class="section level3">
<h3><span class="header-section-number">1.8.4</span> Формат Eviews: wf1</h3>
<p>И снова не побоюсь сказать: если есть возможность, воспользуйся экспортом данных в формат <code>.csv</code>. Если такой возможности нет, то поможет пакет <code>hexView</code> и функция <code>readEviews</code>:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">data &lt;-<span class="st"> </span>hexView::<span class="kw">readEViews</span>(<span class="st">&quot;имя файла.wf1&quot;</span>)</code></pre></div>
</div>
<div id="-stata-dta" class="section level3">
<h3><span class="header-section-number">1.8.5</span> Формат Stata: dta</h3>
<p>Дорогой друг, ты ещё помнишь, что лучше прочитать данные через экспорт в формат <code>.csv</code>? Если не судьба, то импортировать данные с помощью команд R:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">data &lt;-<span class="st"> </span>haven::<span class="kw">read_dta</span>(<span class="st">&quot;имя файла.dta&quot;</span>)</code></pre></div>
<p>И снова можно воспользоваться меню Rstudio: <code>File</code> - <code>Import Dataset</code> - <code>From stata</code>.</p>
</div>
</div>
<div id="internet_sources" class="section level2">
<h2><span class="header-section-number">1.9</span> Интернет-источники данных</h2>
<p>Зачастую данные не обязательно даже сохранять. В R есть пакеты, дающие доступ к некоторым источникам данных в Интернете:</p>
<ol style="list-style-type: decimal">
<li><p><code>quandl</code></p></li>
<li><p><code>quantmod</code></p></li>
<li><p><code>WDI</code></p></li>
</ol>
<blockquote>
<p>СССР — родина слонов!</p>
</blockquote>
<p>Пакеты, дающие доступ к данным по России:</p>
<ol style="list-style-type: decimal">
<li><p><code>sophisthse</code> sophist.hse.ru</p></li>
<li><p><code>cbr</code> Центральный Банк России</p></li>
<li><p><code>datamos</code> datamos.ru</p></li>
<li><p>finam.ru.</p></li>
</ol>
<p>А эти источники ещё ждут желающих написать пакет для R:</p>
<ol style="list-style-type: decimal">
<li><p>gks.ru</p></li>
<li><p>open data gov ???</p></li>
</ol>
</div>
<div id="code_style" class="section level2">
<h2><span class="header-section-number">1.10</span> Стиль кода</h2>
<p>R одинаково выполнит и команды</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">x&lt;-<span class="dv">6-7</span>
y&lt;--<span class="dv">6+9</span>
x -<span class="st">     </span>y</code></pre></div>
<p>и команды</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">x &lt;-<span class="st"> </span><span class="dv">6</span> -<span class="st"> </span><span class="dv">7</span>
y &lt;-<span class="st"> </span>-<span class="dv">6</span> +<span class="st"> </span><span class="dv">9</span>
x -<span class="st"> </span>y</code></pre></div>
<p>Однако второй вариант гораздо приятнее для чтения. С тем, кто пишет код как в первом примере, Английская королева рядом не сядет! Чтобы иметь возможность войти в палату Лордов и Общин, тебе следует писать стильный код!</p>
<p>Если ты работаешь в команде, то руководствуйся тем стилем кода, который в ней принят. А для новичков я советую использовать стиль кода, которого придерживается Hadley Wickham, автор очень популярных пакетов R <code>ggplot2</code> и <code>dplyr</code>:</p>
<ol style="list-style-type: decimal">
<li>После запятой всегда пиши пробел. Перед запятой — никогда:</li>
</ol>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">paste0</span>(<span class="st">&quot;Hi &quot;</span>, <span class="st">&quot;guys!&quot;</span>)</code></pre></div>
<ol start="2" style="list-style-type: decimal">
<li>Знак присваивания <code>&lt;-</code>, знаки арифметических действий (<code>+</code>, <code>-</code>, <code>*</code>), логические проверки (<code>&gt;</code>, <code>&lt;</code>, <code>==</code> и прочие) с двух сторон окружай одинарными пробелами.</li>
</ol>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">x &lt;-<span class="st"> </span>(<span class="fl">3.5</span> +<span class="st"> </span><span class="dv">7</span>) *<span class="st"> </span>(<span class="fl">2.8</span> -<span class="st"> </span><span class="dv">9</span>)</code></pre></div>
<ol start="3" style="list-style-type: decimal">
<li>Открывающую фигурную скобку оставляй на старой строке, а закрывающую — ставь на новую:</li>
</ol>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">if (x ==<span class="st"> </span>y) {
  <span class="kw">message</span>(<span class="st">&quot;Variables x and y are equal.&quot;</span>)
}</code></pre></div>
<p>В Rstudio можно включить автоматическую проверку стиля кода в Tools - Global options - Code - Diagnostics. Настоящие сэры и истинные леди в разделе Diagnostics могут проставить все галочки.</p>
</div>
<div id="two_traditions" class="section level2">
<h2><span class="header-section-number">1.11</span> Две записи функций</h2>
<p>Мы все привыкли к тому, что домохозяйки пишут рецепт в естественном порядке, а математики функции — в обратном. Сравни:</p>
<blockquote>
<p>Возьмите пепел перьев чёрного петуха</p>
</blockquote>
<blockquote>
<p>Добавьте печень дракона</p>
</blockquote>
<blockquote>
<p>Варите на медленном огне 2 дня</p>
</blockquote>
<p>и</p>
<p><span class="math display">\[
\cos(\sin(|x|))
\]</span></p>
<p>У домохозяек порядок изложения совпадает с порядком действий. У математиков сначала написано про косинус, но считается он в самом конце.</p>
<p>Похоже Лёнька Эйлер и Алёшка Клеро</p>
<p>фото</p>
<p>введя обозначение <span class="math inline">\(f(x)\)</span> отделили математиков от домохозяек и, вероятно, пустили математику по ложному пути. Было бы гораздо удобнее, если бы в математике функции также записывали в естественном порядке! Но обозначение <span class="math inline">\(f(x)\)</span> мы впитали с молоком матери, уже вряд ли что исправишь.</p>
<p>R позволяет использовать обе традиции обозначени.</p>
<p>Традиция Эйлера-Клеро:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">cos</span>(<span class="kw">sin</span>(<span class="kw">abs</span>(<span class="dv">10</span>)))</code></pre></div>
<pre><code>## [1] 0.8556344</code></pre>
<p>Для того, чтобы иметь возможность писать операции в естественном порядке, подключаем пакет <code>dplyr</code>:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(<span class="st">&quot;tidyverse&quot;</span>) <span class="co"># подключит dplyr, ggplot2 и прочие приятности</span></code></pre></div>
<p>И теперь, в традициях лучших кулинарных рецептов, можно написать</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="dv">10</span> %&gt;%<span class="st"> </span><span class="kw">abs</span>() %&gt;%<span class="st"> </span><span class="kw">sin</span>() %&gt;%<span class="st"> </span><span class="kw">cos</span>()</code></pre></div>
<pre><code>## [1] 0.8556344</code></pre>
<p>Оператор <code>%&gt;%</code> называется трубочкой (pipe). (? канал) По первому впечатлению кажется, что эти трубочки долго писать. Но стоит к ним привыкнуть и ощущаешь, что они безумно удобны для сложных операций!</p>
</div>
<div id="data_manipulations" class="section level2">
<h2><span class="header-section-number">1.12</span> Манипуляции с данными</h2>
<p>(здесь про типы данных)</p>
<p>Правильные имена переменных!!!</p>
<p>Основной объект с которым приходится работать — это табличка с данными. Табличка с данными представляет собой простую двумерную таблицу. Переменные размещаются по столбцам. Каждый столбец может быть своего типа: скажем в одном — числа, а в другом — названия предприятий. Если значение в клетке неизвестно, то там стоит специальное значение <code>NA</code>.</p>
<p>Отличие от матрицы от таблицы с данными состоит в том, что в матрице все клеточки одинакового типа (все — числовые или все — текстовые), а в таблице с данными каждый столбец может быть своего типа.</p>
<p>При обработке данных нам помогут рабочие лошадки:</p>
<ol style="list-style-type: decimal">
<li><p>Быстрый взгляд на табличку</p></li>
<li><p>Отбор наблюдений</p></li>
<li><p>Отбор и переименование переменных</p></li>
<li><p>Преобразование и создание новых переменных</p></li>
</ol>
<p>Сортировка</p>
<ol start="5" style="list-style-type: decimal">
<li><p>Операции с группировкой</p></li>
<li><p>Преобразование широких и длинных таблиц</p></li>
</ol>
<p>Все эти действия можно сделать в базовом R, но это ужасно неудобно. Жизнь становится прекрасной с пакетами <code>data.table</code>, <code>dplyr</code>, <code>reshape2</code>, <code>broom</code> и <code>tidyr</code>.</p>
<p>Седлаем наших верных коней:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(tidyverse) <span class="co"># подключит пакеты dplyr, ggplot2 и прочие</span>
<span class="kw">library</span>(data.table)
<span class="kw">library</span>(reshape2)</code></pre></div>
<p>Погнали!</p>
<p>Пакет <code>data.table</code> работает быстрее <code>dplyr</code>, а у <code>dplyr</code> более приятный синтаксис.</p>
<p>Перед работой с табличкой данных с помощью <code>data.table</code> требуется присвоить ей специальный класс:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">cars2 &lt;-<span class="st"> </span><span class="kw">data.table</span>(cars)
mtcars2 &lt;-<span class="st"> </span><span class="kw">data.table</span>(mtcars)</code></pre></div>
<p>Содержимое таблиц <code>cars</code> и <code>cars2</code> абсолютно одинаково, просто они чуть по-разному хранятся и обрабатываются компьютером.</p>
<div id="glimpse" class="section level3">
<h3><span class="header-section-number">1.12.1</span> Быстрый взгляд на табличку</h3>
<p>С помощью базового R:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">str</span>(mtcars)</code></pre></div>
<pre><code>## &#39;data.frame&#39;:    32 obs. of  11 variables:
##  $ mpg : num  21 21 22.8 21.4 18.7 18.1 14.3 24.4 22.8 19.2 ...
##  $ cyl : num  6 6 4 6 8 6 8 4 4 6 ...
##  $ disp: num  160 160 108 258 360 ...
##  $ hp  : num  110 110 93 110 175 105 245 62 95 123 ...
##  $ drat: num  3.9 3.9 3.85 3.08 3.15 2.76 3.21 3.69 3.92 3.92 ...
##  $ wt  : num  2.62 2.88 2.32 3.21 3.44 ...
##  $ qsec: num  16.5 17 18.6 19.4 17 ...
##  $ vs  : num  0 0 1 1 0 1 0 1 1 1 ...
##  $ am  : num  1 1 1 0 0 0 0 0 0 0 ...
##  $ gear: num  4 4 4 3 3 3 3 4 4 4 ...
##  $ carb: num  4 4 1 1 2 1 4 2 2 4 ...</code></pre>
<p>С помощью <code>dplyr</code>:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">glimpse</span>(mtcars)</code></pre></div>
<pre><code>## Observations: 32
## Variables: 11
## $ mpg  &lt;dbl&gt; 21.0, 21.0, 22.8, 21.4, 18.7, 18.1, 14.3, 24.4, 22.8, 19....
## $ cyl  &lt;dbl&gt; 6, 6, 4, 6, 8, 6, 8, 4, 4, 6, 6, 8, 8, 8, 8, 8, 8, 4, 4, ...
## $ disp &lt;dbl&gt; 160.0, 160.0, 108.0, 258.0, 360.0, 225.0, 360.0, 146.7, 1...
## $ hp   &lt;dbl&gt; 110, 110, 93, 110, 175, 105, 245, 62, 95, 123, 123, 180, ...
## $ drat &lt;dbl&gt; 3.90, 3.90, 3.85, 3.08, 3.15, 2.76, 3.21, 3.69, 3.92, 3.9...
## $ wt   &lt;dbl&gt; 2.620, 2.875, 2.320, 3.215, 3.440, 3.460, 3.570, 3.190, 3...
## $ qsec &lt;dbl&gt; 16.46, 17.02, 18.61, 19.44, 17.02, 20.22, 15.84, 20.00, 2...
## $ vs   &lt;dbl&gt; 0, 0, 1, 1, 0, 1, 0, 1, 1, 1, 1, 0, 0, 0, 0, 0, 0, 1, 1, ...
## $ am   &lt;dbl&gt; 1, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, ...
## $ gear &lt;dbl&gt; 4, 4, 4, 3, 3, 3, 3, 4, 4, 4, 4, 3, 3, 3, 3, 3, 3, 4, 4, ...
## $ carb &lt;dbl&gt; 4, 4, 1, 1, 2, 1, 4, 2, 2, 4, 4, 3, 3, 3, 4, 4, 4, 1, 2, ...</code></pre>
<p>С помощью <code>broom</code></p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">glance</span>(mtcars)</code></pre></div>
<pre><code>##   nrow ncol complete.obs na.fraction
## 1   32   11           32           0</code></pre>
<p>и короткие описательные статистики:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">tidy</span>(mtcars)</code></pre></div>
<pre><code>##    column  n       mean          sd  median     trimmed         mad    min
## 1     mpg 32  20.090625   6.0269481  19.200  19.6961538   5.4114900 10.400
## 2     cyl 32   6.187500   1.7859216   6.000   6.2307692   2.9652000  4.000
## 3    disp 32 230.721875 123.9386938 196.300 222.5230769 140.4763500 71.100
## 4      hp 32 146.687500  68.5628685 123.000 141.1923077  77.0952000 52.000
## 5    drat 32   3.596563   0.5346787   3.695   3.5792308   0.7042350  2.760
## 6      wt 32   3.217250   0.9784574   3.325   3.1526923   0.7672455  1.513
## 7    qsec 32  17.848750   1.7869432  17.710  17.8276923   1.4158830 14.500
## 8      vs 32   0.437500   0.5040161   0.000   0.4230769   0.0000000  0.000
## 9      am 32   0.406250   0.4989909   0.000   0.3846154   0.0000000  0.000
## 10   gear 32   3.687500   0.7378041   4.000   3.6153846   1.4826000  3.000
## 11   carb 32   2.812500   1.6152000   2.000   2.6538462   1.4826000  1.000
##        max   range       skew    kurtosis          se
## 1   33.900  23.500  0.6106550 -0.37276603  1.06542396
## 2    8.000   4.000 -0.1746119 -1.76211977  0.31570933
## 3  472.000 400.900  0.3816570 -1.20721195 21.90947271
## 4  335.000 283.000  0.7260237 -0.13555112 12.12031731
## 5    4.930   2.170  0.2659039 -0.71470062  0.09451874
## 6    5.424   3.911  0.4231465 -0.02271075  0.17296847
## 7   22.900   8.400  0.3690453  0.33511422  0.31588992
## 8    1.000   1.000  0.2402577 -2.00193762  0.08909831
## 9    1.000   1.000  0.3640159 -1.92474143  0.08820997
## 10   5.000   2.000  0.5288545 -1.06975068  0.13042656
## 11   8.000   7.000  1.0508738  1.25704307  0.28552971</code></pre>
<p>Пока что в пакете <code>broom</code> содержится ошибка, <a href="https://github.com/dgrtwo/broom/issues/154">команды glance() и tidy() не срабатывают</a> с некоторыми табличками данных. Тогда описательные статистики можно получить с помощью пакета <code>psych</code>:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(<span class="st">&quot;psych&quot;</span>)</code></pre></div>
<pre><code>## 
## Attaching package: &#39;psych&#39;</code></pre>
<pre><code>## The following objects are masked from &#39;package:ggplot2&#39;:
## 
##     %+%, alpha</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">describe</span>(mtcars)</code></pre></div>
<pre><code>##      vars  n   mean     sd median trimmed    mad   min    max  range  skew
## mpg     1 32  20.09   6.03  19.20   19.70   5.41 10.40  33.90  23.50  0.61
## cyl     2 32   6.19   1.79   6.00    6.23   2.97  4.00   8.00   4.00 -0.17
## disp    3 32 230.72 123.94 196.30  222.52 140.48 71.10 472.00 400.90  0.38
## hp      4 32 146.69  68.56 123.00  141.19  77.10 52.00 335.00 283.00  0.73
## drat    5 32   3.60   0.53   3.70    3.58   0.70  2.76   4.93   2.17  0.27
## wt      6 32   3.22   0.98   3.33    3.15   0.77  1.51   5.42   3.91  0.42
## qsec    7 32  17.85   1.79  17.71   17.83   1.42 14.50  22.90   8.40  0.37
## vs      8 32   0.44   0.50   0.00    0.42   0.00  0.00   1.00   1.00  0.24
## am      9 32   0.41   0.50   0.00    0.38   0.00  0.00   1.00   1.00  0.36
## gear   10 32   3.69   0.74   4.00    3.62   1.48  3.00   5.00   2.00  0.53
## carb   11 32   2.81   1.62   2.00    2.65   1.48  1.00   8.00   7.00  1.05
##      kurtosis    se
## mpg     -0.37  1.07
## cyl     -1.76  0.32
## disp    -1.21 21.91
## hp      -0.14 12.12
## drat    -0.71  0.09
## wt      -0.02  0.17
## qsec     0.34  0.32
## vs      -2.00  0.09
## am      -1.92  0.09
## gear    -1.07  0.13
## carb     1.26  0.29</code></pre>
</div>
<div id="filter_observations" class="section level3">
<h3><span class="header-section-number">1.12.2</span> Отбор наблюдений</h3>
<p>С помощью <code>dplyr</code>:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">head</span>(cars)</code></pre></div>
<pre><code>##   speed dist
## 1     4    2
## 2     4   10
## 3     7    4
## 4     7   22
## 5     8   16
## 6     9   10</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">new_cars &lt;-<span class="st"> </span><span class="kw">filter</span>(cars, speed &gt;<span class="st"> </span><span class="dv">10</span>, dist &lt;<span class="st"> </span><span class="dv">20</span>)
<span class="kw">head</span>(new_cars)</code></pre></div>
<pre><code>##   speed dist
## 1    11   17
## 2    12   14</code></pre>
<p>Не забывай про эквивалентный трубчатый синтаксис:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">new_cars &lt;-<span class="st"> </span>cars %&gt;%<span class="st"> </span><span class="kw">filter</span>(speed &gt;<span class="st"> </span><span class="dv">10</span>, dist &lt;<span class="st"> </span><span class="dv">20</span>)</code></pre></div>
<p>Некоторые другие пакеты помимо <code>dplyr</code> содержат функцию <code>filter</code> — уж больно слово <code>filter</code> популярное. Конфликт имён при использовании команды <code>filter</code> — одна из распространённых ошибок.</p>
<div class="warning">
<p>
Чтобы избежать ошибки из-за конфликта имён можно явно написать <code>dplyr::filter</code> вместо просто <code>filter</code>!
</p>
</div>
<p>А именно:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">new_cars &lt;-<span class="st"> </span>cars %&gt;%<span class="st"> </span>dplyr::<span class="kw">filter</span>(speed &gt;<span class="st"> </span><span class="dv">10</span>, dist &lt;<span class="st"> </span><span class="dv">20</span>)</code></pre></div>
<p>С помощью <code>data.table</code>:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">new_cars &lt;-<span class="st"> </span>cars2[speed &gt;<span class="st"> </span><span class="dv">10</span> &amp;<span class="st"> </span>dist &lt;<span class="st"> </span><span class="dv">20</span>]</code></pre></div>
</div>
<div id="select_rename" class="section level3">
<h3><span class="header-section-number">1.12.3</span> Отбор и переименование переменных:</h3>
<p>К примеру, мы хотим из набора данных <code>mtcars</code> отобрать три переменных, <code>mpg</code>, <code>carb</code> и <code>cyl</code>, а заодно дать им более понятные имена: переименовать <code>cyl</code> в <code>cylinder</code> и <code>carb</code> в <code>carburator</code>.</p>
<p>С помощью <code>dplyr</code>:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">new_mtcars &lt;-<span class="st"> </span><span class="kw">select</span>(mtcars, <span class="dt">cylinder =</span> cyl, mpg, <span class="dt">carburator =</span> carb)</code></pre></div>
<p>Помни о трубочках:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">mtcars2 &lt;-<span class="st"> </span>mtcars %&gt;%
<span class="st">  </span><span class="kw">select</span>(<span class="dt">cylinder =</span> cyl, mpg, <span class="dt">carburator =</span> carb)</code></pre></div>
<div class="warning">
<p>
Некоторые другие пакеты помимо <code>dplyr</code> содержат функцию <code>select</code>. Чтобы избежать конфликта имён, можно явно написать <code>dplyr::select</code> вместо просто <code>select</code>.
</p>
</div>
<p>С помощью пакета <code>data.table</code>:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># new_mtcars2 &lt;- mtcars2[, .(cylinder = cyl, mpg, carburator = carb)]</span></code></pre></div>
<p>Если переназывать переменные не требуется, то можно отобрать переменные и по-другому:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># new_mtcars2 &lt;- mtcars2[, c(&quot;mpg&quot;, &quot;cyl&quot;)]</span></code></pre></div>
</div>
<div id="mutate_variables" class="section level3">
<h3><span class="header-section-number">1.12.4</span> Преобразование и создание новых переменных</h3>
<p>Допустим, я хочу в наборе данных <code>mtcars</code> создать новую переменную <code>weight2</code> равную квадрату переменной <code>wt</code>, а переменную <code>mpg</code> отмасштабировать из милей на галлон бензина в километры на литр бензина. Интернет говорит, что в одном галлоне …. литров, а в одной миле — … километров.</p>
<p>Начнём с трубчатого синтаксиса:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># new_mtcars &lt;- mtcars %&gt;% mutate(weight2 = wt^2, mpg = mpg * ... / ...)</span></code></pre></div>
<p>То же действие без трубочек:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># new_mtcars &lt;- mutate(mtcars, weight2 = wt^2, mpg = mpg * ... / ...)</span></code></pre></div>
<p>Создаём новую переменную с помощью пакета <code>data.table</code>:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># new_mtcars2 &lt;- mtcars2[, weight2 := wt^2]</span></code></pre></div>
<p>Если нужно создать сразу несколько переменных, то синтаксис <code>data.table</code> чуть более громоздкий, чем у <code>dplyr</code>:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># new_mtcars2 &lt;- mtcars2[, weight2 := wt^2][, mpg := mpg / 100]</span></code></pre></div>
<p>Или так:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># new_mtcars2 &lt;- mtcars2[, `:=`(weight2 = wt^2, mpg = mpg / 100)]</span></code></pre></div>
<p>Чтобы лучше была понятна разница, подчеркну отличие двух команд:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># команда A:</span>
<span class="co"># new_mtcars2 &lt;- mtcars2[, .(weight2 = wt^2, mpg = mpg / 100)]</span>
<span class="co"># команда B:</span>
<span class="co"># new_mtcars2 &lt;- mtcars2[, `:=`(weight2 = wt^2, mpg = mpg / 100)]</span></code></pre></div>
<p>После выполнения команды A в массиве <code>new_mtcars2</code> будет только две переменных: <code>weight2</code> и <code>mpg</code>. А после выполнения команды B также останутся и все старые переменный из исходной таблички <code>mtcars2</code>.</p>
</div>
<div id="df_sorting" class="section level3">
<h3><span class="header-section-number">1.12.5</span> Сортировка</h3>
</div>
<div id="group_by" class="section level3">
<h3><span class="header-section-number">1.12.6</span> Операции с группировкой</h3>
</div>
<div id="join_df" class="section level3">
<h3><span class="header-section-number">1.12.7</span> Слияние наборов данных</h3>
</div>
<div id="mortal_kombat" class="section level3">
<h3><span class="header-section-number">1.12.8</span> Комбо-серия!</h3>
</div>
</div>
<div id="graphs" class="section level2">
<h2><span class="header-section-number">1.13</span> Графики</h2>
<p>График можно строить либо чтобы: - самому по-быстрому взглянуть на некий результат и сразу забыть график - показать график кому-нибудь</p>
<p>В первом случае нет никаких требований к графику — лишь бы самому было понятно, что там изображено. Если же график показывать кому-то ещё, то:</p>
<div class="warning">
<p>
Идеальный график должен быстро и верно восприниматься смотрящим.
</p>
</div>
<p>Из этого простого принципа следует ряд выводов:</p>
<ol style="list-style-type: decimal">
<li>Идеальный график должен быть самодостаточным.</li>
</ol>
<p>Если для понимания графика смотрящему требуется прочитать кучу текста вокруг или прослушать получасовое объяснение, то это нехорошо :) Вырежи свой график из статьи/книги/курсовой и подумай, понятен ли он?</p>
<ol start="2" style="list-style-type: decimal">
<li>Подписывай оси.</li>
</ol>
<p>[ссылка на xkcd]</p>
<ol start="3" style="list-style-type: decimal">
<li><p>Выбирай единицы измерения так, чтобы читатель не мучился, считая нули у каждой цифры.</p></li>
<li><p>Указывай единицы измерения.</p></li>
<li><p>Хорошо бы указать источник данных.</p></li>
<li><p>Лучше расшифровать сокращения, хотя иногда это бывает нелегко.</p></li>
<li><p>Никаких круговых диаграмм.</p></li>
</ol>
<p>Круговые диаграммы — это табу. Да, R умеет их строить. Процитирую документацию к функции <code>pie</code>:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">help</span>(pie)</code></pre></div>
<blockquote>
<p>Pie charts are a very bad way of displaying information. The eye is good at judging linear measures and bad at judging relative areas. A bar chart or dot chart is a preferable way of displaying this type of data.</p>
<p>Cleveland (1985), page 264: “Data that can be shown by pie charts always can be shown by a dot chart. This means that judgements of position along a common scale can be made instead of the less accurate angle judgements.” This statement is based on the empirical investigations of Cleveland and McGill as well as investigations by perceptual psychologists.</p>
</blockquote>
<ol start="8" style="list-style-type: decimal">
<li>Никаких псевдо-3D эффектов и прочих «рюшечек».</li>
</ol>
<p>Посмотрите пару анимаций от DarkHorse.</p>
<ol start="9" style="list-style-type: decimal">
<li><p>Ось должна начинаться от нуля.</p></li>
<li><p>Полезно немного ознакомиться с творениями мэтров :)</p></li>
</ol>
<p>Tufte, link</p>
<p>Очень часто к графикам относятся как к чему-то вспомогательному. На самом деле график очень часто является основным результатом, гораздо более важным, чем несколько страниц текста. Именно поэтому полезно отказаться от мысли «я тут за пять минут график вставлю» и потратить на график часок-другой!</p>
<div id="two_simple_graphs" class="section level3">
<h3><span class="header-section-number">1.13.1</span> Два простеньких графика</h3>
<p>Простенькую гистограмму можно построить, например, с помощью функции <code>qplot()</code> из пакета <code>ggplot2</code>:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">s &lt;-<span class="st"> </span><span class="kw">rnorm</span>(<span class="dv">100</span>)
<span class="kw">qplot</span>(<span class="kw">factor</span>(s), <span class="dt">xlab =</span> <span class="st">&quot;Значение&quot;</span>,
<span class="dt">ylab =</span> <span class="st">&quot;Количество&quot;</span>, <span class="dt">main =</span> <span class="st">&quot;Гистограмма&quot;</span>)</code></pre></div>
<p><img src="01_first_steps_files/figure-html/simple_histo-1.png" width="672" /></p>
<p>Ту же гистограммку можно построить с помощью функции <code>ggplot()</code> из того же пакета, предварительно преобразовав s в необходимый для <code>ggplot()</code> формат data frame:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">s_df &lt;-<span class="st"> </span><span class="kw">data.frame</span>(s)
<span class="kw">ggplot</span>(s_df) +<span class="st"> </span><span class="kw">geom_bar</span>(<span class="kw">aes</span>(<span class="kw">factor</span>(s))) +
<span class="kw">labs</span>(<span class="dt">x =</span> <span class="st">&quot;Значение&quot;</span>, <span class="dt">y =</span> <span class="st">&quot;Количество&quot;</span>, <span class="dt">title =</span> <span class="st">&quot;Гистограмма&quot;</span>)</code></pre></div>
<p><img src="01_first_steps_files/figure-html/simple_histo_ggplot2-1.png" width="672" /></p>
<p>И еще простенький график:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">x &lt;-<span class="st"> </span><span class="kw">rnorm</span>(<span class="dv">500</span>) <span class="co"># 500 нормальных величин со средним 0 и дисперсией 1</span>
y &lt;-<span class="st"> </span><span class="kw">rnorm</span>(<span class="dv">500</span>) <span class="co"># 500 нормальных величин со средним 0 и дисперсией 1</span>
<span class="kw">qplot</span>(x, y, <span class="dt">main =</span> <span class="st">&quot;Точечки&quot;</span>)</code></pre></div>
<p><img src="01_first_steps_files/figure-html/scatter_qplot-1.png" width="672" /></p>
<p>Или:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">xy_df &lt;-<span class="st"> </span><span class="kw">data.frame</span>(<span class="dt">x =</span> x, <span class="dt">y =</span> y)
<span class="kw">ggplot</span>(xy_df) +<span class="st"> </span><span class="kw">geom_point</span>(<span class="kw">aes</span>(x, y)) +<span class="st"> </span><span class="kw">labs</span>(<span class="dt">title =</span> <span class="st">&quot;Точечки&quot;</span>)</code></pre></div>
<p><img src="01_first_steps_files/figure-html/scatter_ggplot2-1.png" width="672" /></p>
<p>В зависимости от формата данных часто бывает удобно использовать и <code>qplot()</code>, и <code>ggplot()</code>.</p>
</div>
</div>
<div id="error" class="section level2">
<h2><span class="header-section-number">1.14</span> У меня ошибка!</h2>
<p>Чтобы узнать в каком пакете живет заданная функция, например <code>lm</code>, можно прямо спросить у R:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">help</span>(<span class="st">&quot;lm&quot;</span>)</code></pre></div>
<p>На самом верху справа документации будет написано <code>lm {stats}</code>. Это означает, что функция <code>lm</code> живёт в пакете <code>stats</code>.</p>
<blockquote>
<p>Шеф! Всё пропало! Гипс снимают, клиент уезжает!</p>
</blockquote>
<p>поговори с уточкой, посиди у озера</p>
</div>
<div id="R_links" class="section level2">
<h2><span class="header-section-number">1.15</span> Ресурсы по R</h2>
<p>Начнём с русскоязычных крупных книжек:</p>
<ul>
<li>Шипунов А.Б., Балдин Е.М. и др. <a href="http://ashipunov.info/shipunov/school/books/rbook.pdf">Наглядная статистика. Используем R!</a> * Мастицкий С.Э., Шитиков В.К., <a href="http://www.ievbras.ru/ecostat/Kiril/R/Mastitsky%20and%20Shitikov%202014.pdf">Статистический анализ и визуализация с помощью R</a></li>
<li>Василенко Є.С, <a href="https://www.dropbox.com/sh/gaxtktwbxyuu1ss/AAAb2XW0kquoxfLryf2aYeQZa?dl=0">Обробка геологiчної iнформацiї з використанням програмного середовища R</a></li>
<li>Кабаков Р.И. R в действии. <a href="http://dmkpress.com/catalog/computer/statistics/978-5-94074-912-7/">Анализ и визуализация данных на языке R</a></li>
</ul>
<p>На русском также могут быть полезны:</p>
<ul>
<li>Стилевое руководство гугла: <a href="https://google-styleguide.googlecode.com/svn/trunk/Rguide.xml">english</a>, <a href="https://9ccb6b88-a-cba0391b-s-sites.googlegroups.com/a/kiber-guu.ru/r-practice/links/R_style_from_Google.pdf?attachauth=ANoY7crkge5FhA5LZtMwj6Ilur-WbnkKLijkDkoB01VZZAlsFoRjEo7YwgqvW-Gid6ffwBmz3TMT51kMnw8JljZeQlDPRXMKZctirezqTziipn5TOaB9D1IaQ7qzTSusjkIyYV2jMchrhAsXOHTo_G0VRztBxYeecm4HYS19M1VTxn-UluL_9tYpsOEpDvhV1ghlRvk57pCxDO3C4wSV63SQIy0p7cjo6r-HB6Dj0CG7iNKM_RTjaAw%3D&amp;attredirects=0">русский</a></li>
<li><a href="http://r-analytics.blogspot.ru">Блог r-analytics</a>. На нём есть несколько других подборок русскоязычных ресурсов по R: <a href="http://r-analytics.blogspot.ru/p/blog-page_20.html">раз</a> и <a href="http://r-analytics.blogspot.ru/p/blog-page_80.html">два</a>. * <a href="https://vk.com/rstatistics">Группа вконтакте rstatistics</a> * <a href="https://vk.com/spbrug">Группа вконтакте spbrug</a> * <a href="https://vk.com/introstats">Группа вконтакте introstats</a> * Венэбльз, Смит <a href="http://www.ievbras.ru/ecostat/Kiril/R/Biblio/R_rus/Venables%20%c2%e2%e5%e4%e5%ed%e8%e5%20%e2%20R.pdf">Введение в R</a></li>
<li>Зарядов И.С. <a href="http://www.ievbras.ru/ecostat/Kiril/R/Biblio/R_rus/%c7%e0%f0%ff%e4%ee%e2%20%f7%e0%f1%f2%fc_1.pdf">Введение в R: часть 1</a></li>
<li>Зарядов И.С. <a href="http://www.ievbras.ru/ecostat/Kiril/R/Biblio/R_rus/%c7%e0%f0%ff%e4%ee%e2%20%f7%e0%f1%f2%fc_2.pdf">Введение в R: часть 2</a></li>
<li>Борис Демешев <a href="http://bdemeshev.github.io/r_cycle/">Цикл маленьких заметок по R</a></li>
</ul>
<p>Вопросы и ответы:</p>
<ul>
<li><p><a href="http://stackoverflow.com/">stackoverflow</a> Если возникли проблемы с программированием в R (и не только в R), а документация уже прочитана…</p></li>
<li><p><a href="http://stats.stackexchange.com/">stats.stackexchange</a> Можно спросить по статистическим методам и их реализации в R.</p></li>
<li><p><a href="http://tex.stackexchange.com/">tex.stackexchange</a> Вопросы и ответы про LaTeX</p></li>
</ul>
<p>Он-лайн курсы и видеолекции с использованием R:</p>
<ul>
<li><p><a href="http://r-exercises.com/r-courses/">Поисковик он-лайн курсов по R</a></p></li>
<li><p><a href="http://tryr.codeschool.com/">Try R</a> Путь к сокровищам R для самых начинающих пиRатов!</p></li>
<li><p><a href="https://stepik.org/course/%D0%9E%D1%81%D0%BD%D0%BE%D0%B2%D1%8B-%D0%BF%D1%80%D0%BE%D0%B3%D1%80%D0%B0%D0%BC%D0%BC%D0%B8%D1%80%D0%BE%D0%B2%D0%B0%D0%BD%D0%B8%D1%8F-%D0%BD%D0%B0-R-497/">Основы программирования на R от stepik.org</a></p></li>
<li><p><a href="https://stepik.org/course/%D0%90%D0%BD%D0%B0%D0%BB%D0%B8%D0%B7-%D0%B4%D0%B0%D0%BD%D0%BD%D1%8B%D1%85-%D0%B2-R-129/">Анализ данных в R от stepik.org</a></p></li>
<li><p><a href="https://www.datacamp.com/">datacamp.com</a> Несколько платных и бесплатных интерактивных курсов по R</p></li>
<li><p>Видео-лекции курса Computing for Data Analysis: <a href="http://www.youtube.com/playlist?list=PLjTlxb-wKvXNSDfcKPFH2gzHGyjpeCZmJ">неделя 1</a>, <a href="http://www.youtube.com/playlist?list=PLjTlxb-wKvXNnjUTX4C8IeIhPBjPkng6B">неделя 2</a>, <a href="http://www.youtube.com/playlist?list=PLjTlxb-wKvXOzI2h0F2_rYZHIXz8GWBop">неделя 3</a>, <a href="http://www.youtube.com/playlist?list=PLjTlxb-wKvXOdzysAE6qrEBN_aSBC0LZS">неделя 4</a>. Сам курс доступен на <a href="http://www.coursera.org">coursera.org</a></p></li>
</ul>
<p>Открытые крупные источники на английском:</p>
<ul>
<li><p>Trevor Hastie, Robert Tibshirani, <a href="http://www-bcf.usc.edu/~gareth/ISL/">An Introduction to Statistical Learning</a>. По книжке есть <a href="https://class.stanford.edu/courses/HumanitiesandScience/StatLearning/Winter2015/about">курс на платформе class.standford.edu</a></p></li>
<li><p>Rob Hyndman, <a href="https://www.otexts.org/book/fpp">Forecasting: principles and practice</a> Книжка по временным рядам от автора пакета forecast</p></li>
<li><p>Garrett Grolemund, Hadley Wickham, <a href="http://r4ds.had.co.nz/">R for Data Science</a></p></li>
<li><p>Colin Gillespie, Robin Lovelace, <a href="https://bookdown.org/csgillespie/efficientR">Efficient R programming</a>, он-лайн книга для более продвинутых пользователей R. Написана на R и markdown :)</p></li>
<li><p>Rob Kabacoff, <a href="http://www.statmethods.net/">Quick R</a></p></li>
<li><p>Farnsworth, <a href="http://cran.r-project.org/doc/contrib/Farnsworth-EconometricsInR.pdf">Econometrics in R</a></p></li>
<li><p><a href="http://wiki.stdout.org/rcookbook/">Cookbook for R</a></p></li>
<li><p><a href="http://www.burns-stat.com/pages/Tutor/R_inferno.pdf">R-inferno</a> Адский учебник по R с картинками Ботичелли, “Even if it doesn’t help you with your problem, it might amuse you”</p></li>
<li><p>Roger Peng, <a href="https://leanpub.com/rprogramming/">R programming for data science</a> и на <a href="https://bookdown.org/rdpeng/rprogdatascience/">bookdown</a></p></li>
<li><p><a href="http://cran.r-project.org/doc/manuals/R-intro.pdf">Introduction to R</a>, Введение с официального сайта</p></li>
<li><p>документация <a href="http://docs.ggplot2.org/current/index.html">по графикам ggplot2</a></p></li>
<li><p>документация к <a href="http://stackoverflow.com/documentation/r/topics">R от stats.stackexchange</a></p></li>
<li><p><strong>Шикарные</strong> <a href="https://www.rstudio.com/resources/cheatsheets/"><strong>шпаргалки от Rstudio</strong></a></p></li>
<li><p><a href="https://pairach.com/2012/02/26/r-tutorials-from-universities-around-the-world/">100 курсов и книг по R</a> от разных университетов</p></li>
<li><p>Агрегатор блогов <a href="http://r-bloggers.com/">r-bloggers</a></p></li>
<li><p>Поисковик <a href="http://rseek.org/">rseek.org</a></p></li>
</ul>
<p>Великолепные виньетки к разным пакетам:</p>
<ul>
<li><p><a href="http://cran.r-project.org/web/packages/vars/vignettes/vars.pdf">vars</a>, векторные авторегрессии, есть вольный пересказ <a href="http://rpubs.com/rakhab/9941">по-русски</a></p></li>
<li><p><a href="http://cran.rstudio.com/web/packages/dplyr/vignettes/introduction.html">dplyr</a> манипуляции с данными</p></li>
<li><p><a href="http://cran.r-project.org/web/packages/sandwich/vignettes/sandwich.pdf">sandwich</a> борьба с гетероскедастичностью и заклинания HC0, HC1, HC2, …</p></li>
<li><p><a href="http://cran.r-project.org/web/packages/plm/vignettes/plm.pdf">plm</a> панельные модели в R</p></li>
<li><p><a href="http://journal.r-project.org/archive/2013-1/kahle-wickham.pdf">ggmap</a> рисуем карты</p></li>
<li><p><a href="http://cran.r-project.org/web/packages/vcd/vignettes/strucplot.pdf">vcd</a> полезные графики для качественных переменных</p></li>
<li><p><a href="http://www.jstatsoft.org/v28/c01/paper">Beanplot</a>: A Boxplot Alternative for Visual Comparison of Distributions.</p></li>
</ul>
<p>Ты ещё не заработал свой первый миллион и хочешь скачать научную статью или книжку бесплатно?</p>
<ul>
<li><p>Научные книги можно найти на <a href="http://gen.lib.rus.ec/">gen.lib.rus.ec</a>.</p></li>
<li><p>Научные статьи можно скачать на <a href="http://sci-hub.cc/">sci-hub.cc</a>. Есть даже бот <code>@scihubot</code> для <a href="https://telegram.org/">Telegram</a>, которые вышлет в ответ на запрос полный текст статьи.</p></li>
</ul>
<p>Если какая-нибудь ссылка не работает или хочешь предложить свою, <a href="https://github.com/bdemeshev/r_manual_book/issues">смело открывай issue на github</a>!</p>
<!--chapter:end:01_first_steps.Rmd-->
</div>
</div>
<div id="friends_of_R" class="section level1">
<h1><span class="header-section-number">2</span> Друзья R</h1>
<p>Если ты используешь R, то ты поймёшь, что есть куча других полезных программ!</p>
<div id="workflow" class="section level2">
<h2><span class="header-section-number">2.1</span> Рабочий процесс</h2>
<p>…</p>
</div>
<div id="version_control" class="section level2">
<h2><span class="header-section-number">2.2</span> Контроль версий</h2>
<p>…</p>
</div>
<div id="latex" class="section level2">
<h2><span class="header-section-number">2.3</span> Латех</h2>
<p>…</p>
</div>
<div id="markdown" class="section level2">
<h2><span class="header-section-number">2.4</span> Маркдаун</h2>
<p>…</p>
</div>
<div id="reproducible_research" class="section level2">
<h2><span class="header-section-number">2.5</span> Воспроизводимые исследования</h2>
<p>…</p>
</div>
<div id="own_package" class="section level2">
<h2><span class="header-section-number">2.6</span> Написание своего пакета</h2>
<p>…</p>
</div>
<div id="cloud_computing" class="section level2">
<h2><span class="header-section-number">2.7</span> Вычисления в облаке</h2>
<p>…</p>
</div>
<div id="presentations" class="section level2">
<h2><span class="header-section-number">2.8</span> Презентации</h2>
<p>…</p>
</div>
<div id="this_book" class="section level2">
<h2><span class="header-section-number">2.9</span> Про эту книжку</h2>
<p>Разбить на большее количество глав!!!</p>
<p>Что-то убрать? чтобы была ещё одна книжка? :)</p>
<p>Общие принципы:</p>
<ol style="list-style-type: decimal">
<li><p>Неформальный стиль, на “ты”</p></li>
<li><p>Больше картинок. Лицензия?</p></li>
<li><p>Больше гипер-ссылок.</p></li>
<li><p>Буква <code>ё</code> обязательна.</p></li>
</ol>
<p>Пакет <code>bookdown</code> с помощью которого написана эта книжка ещё немного сыроват. В процессе работы я обнаружил, что:</p>
<ol style="list-style-type: decimal">
<li><p>Порой помогает удаление промежуточных файлов и компиляция заново.</p></li>
<li><p>После неанглоязычного названия главы обязательно должна идти метка <code>{#label}</code>.</p></li>
<li><p>Каждый <code>.Rmd</code> файл содержит только одну главу. Глава обозначается заголовком первого уровня <code>#</code>.</p></li>
<li><p>Сослаться на главу или подраздел можно с помощью <code>\@ref(label)</code>.</p></li>
<li><p>Сослаться на источник литературы можно с помощью <code>[@reference]</code></p></li>
<li><p>Автодобавление пакетов</p></li>
</ol>
<p>глючит на <code>&quot;M&quot;uller</code></p>
<ol start="6" style="list-style-type: decimal">
<li>Для создания <code>MOBI</code> книг:</li>
</ol>
<p>Под macos:</p>
<p>Поставить менеджер пакетов <a href="http://brew.sh/">Homebrewer</a>.</p>
<div class="sourceCode"><pre class="sourceCode bash"><code class="sourceCode bash"><span class="kw">brew</span> update
<span class="kw">brew</span> cask install calibre
<span class="kw">brew</span> cask install kindlegen</code></pre></div>
<p>В предисловии</p>
<div class="sourceCode"><pre class="sourceCode bash"><code class="sourceCode bash"><span class="kw">bookdown</span>::kindlegen:
  <span class="kw">epub</span>: _book/r_manual.epub</code></pre></div>
<p>ругается</p>
<p>или</p>
<div class="sourceCode"><pre class="sourceCode bash"><code class="sourceCode bash"><span class="kw">bookdown</span>::calibre:
  <span class="kw">input</span>: _book/r_manual.epub
  <span class="kw">output</span>: _book/r_manual.mobi </code></pre></div>
<p>ругается</p>
<p>Если надо изобразить yaml в чанке кода, пока пишу, что он bash</p>
<ol start="7" style="list-style-type: decimal">
<li>заставляем травис работать</li>
</ol>
<p>Создаём новый токен на <a href="https://github.com/settings/tokens">github</a>: кликнуть по иконке пользователя, далее settings - token - generate new token.</p>
<div class="sourceCode"><pre class="sourceCode bash"><code class="sourceCode bash"><span class="kw">sudo</span> gem install travis
<span class="kw">travis</span> encrypt GITHUB_TOKEN=[token from githum]</code></pre></div>
<p>Именно переменная <code>GITHUB_TOKEN</code> должна использоваться для того, чтобы обращаться к гитхабу, т.е. клонируется ветка gh-pages командой</p>
<div class="sourceCode"><pre class="sourceCode bash"><code class="sourceCode bash"><span class="kw">git</span> clone -b gh-pages https://<span class="ot">${GITHUB_TOKEN}</span>@github.com/<span class="ot">${TRAVIS_REPO_SLUG}</span>.git book-output</code></pre></div>
<p>Переменная <code>TRAVIS_REPO_SLUG</code> будет сама определена сервисом Travis и будет равна названию репозитория.</p>
<p>Добавляем получившуюся закодированную строку в <code>.travis.yml</code>. Забавно, что похоже используется рандомный ключ для шифрования и поэтому зашифрованная строка каждый раз выходит разной.</p>
<p>Можно не шифровать её, а добавить в travis-ci.org/user/repo/settings</p>
<p>Для быстрой компиляции добавляем в <code>.travis.yml</code> указание, что мы будем использовать готовые бинарные пакеты R:</p>
<div class="sourceCode"><pre class="sourceCode bash"><code class="sourceCode bash"><span class="kw">r_binary_packages</span>:
  <span class="kw">-</span> ggplot2
  <span class="kw">-</span> dplyr
  <span class="kw">-</span> rio</code></pre></div>
<p>Для того, чтобы эти опции не были проигнорированы <code>.travis.yml</code> должен содержать строку <code>sudo: required</code>.</p>
<p>Если бинарный пакет слишком старый или вообще отсутствует, можно проинсталлировать его обычным образом, для этого добавляем строки</p>
<div class="sourceCode"><pre class="sourceCode bash"><code class="sourceCode bash"><span class="kw">r_packages</span>:
  <span class="kw">-</span> devtools
  <span class="kw">-</span> rio</code></pre></div>
<ol start="8" style="list-style-type: decimal">
<li>Красный шрифт</li>
</ol>
<p>по мотивам <a href="http://stackoverflow.com/questions/29067541" class="uri">http://stackoverflow.com/questions/29067541</a></p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">colFmt &lt;-<span class="st"> </span>function(x, color) {
  outputFormat &lt;-<span class="st"> </span>opts_knit$<span class="kw">get</span>(<span class="st">&quot;rmarkdown.pandoc.to&quot;</span>)
  if (outputFormat ==<span class="st"> &quot;latex&quot;</span>) {
    result &lt;-<span class="st"> </span><span class="kw">paste0</span>(<span class="st">&quot;</span><span class="ch">\\</span><span class="st">textcolor{&quot;</span>, color, <span class="st">&quot;}{&quot;</span>, x, <span class="st">&quot;}&quot;</span>)
  } else if (outputFormat %in%<span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;html&quot;</span>, <span class="st">&quot;epub&quot;</span>)) {
    result &lt;-<span class="st"> </span><span class="kw">paste0</span>(<span class="st">&quot;&lt;font color=&#39;&quot;</span>, color, <span class="st">&quot;&#39;&gt;&quot;</span>, x, <span class="st">&quot;&lt;/font&gt;&quot;</span>)
  } else {
    result &lt;-<span class="st"> </span>x
  }
  <span class="kw">return</span>(result)
}</code></pre></div>
<p>Then you can use it inline like this: <font color='red'>MY RED TEXT</font></p>
<ol start="9" style="list-style-type: decimal">
<li>Файл <code>_output.yaml</code> это просто <code>output:</code> кусок из <code>yaml</code>-части файла <code>index.Rmd</code>. Поэтому можно внести <code>_output.yaml</code> обратно в <code>index.Rmd</code>, чтобы все настройки были в одном месте.</li>
</ol>
<p>Формально <code>_output.yaml</code> действует на все <code>.Rmd</code> документы в папке, но что там будет кроме учебника в целом. Разве что отдельные главы компилировать :)</p>
<!--chapter:end:02_friends_of_R.Rmd-->
</div>
</div>
<div id="statistics_and_more" class="section level1">
<h1><span class="header-section-number">3</span> Статистика и не только</h1>
<p>Пора вспомнить о том, что R ориентирован на статистику :)</p>
<div id="random_variables" class="section level2">
<h2><span class="header-section-number">3.1</span> Генерирование случайных величин</h2>
<p>Для решения задач по теории вероятностей или исследования свойств статистических алгоритмов может потребоваться сгененировать случайную выборку из заданного закона распределения.</p>
<p>Генерируем 10 равномерных на отрезке <span class="math inline">\([4;10.5]\)</span> случайных величин:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">runif</span>(<span class="dv">10</span>, <span class="dt">min =</span> <span class="dv">4</span>, <span class="dt">max =</span> <span class="fl">10.5</span>)</code></pre></div>
<pre><code>##  [1] 8.332251 8.577703 8.967174 4.404422 9.131656 9.887249 7.935560
##  [8] 5.599316 5.304904 4.092821</code></pre>
<p>Генерируем 10 нормальных <span class="math inline">\(N(2;9)\)</span> случайных величин с математическим ожиданием <span class="math inline">\(2\)</span> и дисперсией <span class="math inline">\(9=3^2\)</span>:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">rnorm</span>(<span class="dv">10</span>, <span class="dt">mean =</span> <span class="dv">2</span>, <span class="dt">sd =</span> <span class="dv">3</span>)</code></pre></div>
<pre><code>##  [1]  2.9067083 -0.5496545  1.7926215  5.9895407  1.3112444  6.3808746
##  [7]  0.3957746  3.5054769  1.3545586 -0.1549924</code></pre>
<p>Например, с помощью симуляций легко оценить математическое ожидание <span class="math inline">\(E(1/X)\)</span>, где <span class="math inline">\(X \sim N(2;9)\)</span>. Для этого мы вспомним Закон Больших Чисел. Он говорит, что арифметическое среднее по большой выборке стремится по вероятности и почти наверное к математическому ожиданию. Поэтому мы просто сгенерируем большую выборку в миллион наблюдений:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">n_obs &lt;-<span class="st"> </span><span class="dv">10</span>^<span class="dv">6</span>
x &lt;-<span class="st"> </span><span class="kw">rnorm</span>(n_obs, <span class="dt">mean =</span> <span class="dv">2</span>, <span class="dt">sd =</span> <span class="dv">3</span>)
<span class="kw">mean</span>(<span class="dv">1</span>/x)</code></pre></div>
<pre><code>## [1] 0.1106875</code></pre>
<p>Также легко оценить многие вероятности. Например, оценим вероятность <span class="math inline">\(P(X_1 + X_2 + X_3^2 &gt; 5)\)</span>, где величины <span class="math inline">\(X_i\)</span> независимы и одинаково распределены <span class="math inline">\(X_i \sim U[0;2]\)</span>:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">n_obs &lt;-<span class="st"> </span><span class="dv">10</span>^<span class="dv">6</span>
x_1 &lt;-<span class="st"> </span><span class="kw">runif</span>(n_obs, <span class="dt">min =</span> <span class="dv">0</span>, <span class="dt">max =</span> <span class="dv">2</span>)
x_2 &lt;-<span class="st"> </span><span class="kw">runif</span>(n_obs, <span class="dt">min =</span> <span class="dv">0</span>, <span class="dt">max =</span> <span class="dv">2</span>)
x_3 &lt;-<span class="st"> </span><span class="kw">runif</span>(n_obs, <span class="dt">min =</span> <span class="dv">0</span>, <span class="dt">max =</span> <span class="dv">2</span>)
success &lt;-<span class="st"> </span>x_1 +<span class="st"> </span>x_2 +<span class="st"> </span>x_3^<span class="dv">2</span> &gt;<span class="st"> </span><span class="dv">5</span>
<span class="kw">sum</span>(success) /<span class="st"> </span>n_obs</code></pre></div>
<pre><code>## [1] 0.147307</code></pre>
<p>Здесь вектор <code>success</code> будет содержать значение TRUE там, где условие <code>x_1 + x_2 + x_3^2 &gt; 5</code> выполнено, и FALSE там, где условие не выполнено. При сложении командой <code>sum()</code> каждое TRUE будет посчитано как единица, а каждое FALSE как ноль. Поэтому <code>sum(success)</code> даст количество раз, когда условие <code>x_1 + x_2 + x_3^2 &gt; 5</code> выполнено.</p>
<p>С любым распределением <code>[xxx]</code> в R связано четыре функции: <code>r[xxx]</code>, <code>d[xxx]</code>, <code>p[xxx]</code> и <code>q[xxx]</code>. Для примера возьмём нормальное распределение <span class="math inline">\(N(2;9)\)</span>:</p>
<ul>
<li>Функция для создания случайной выборки из нормального <span class="math inline">\(N(2; 9)\)</span> распределения — <code>rnorm</code>:</li>
</ul>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">x &lt;-<span class="st"> </span><span class="kw">rnorm</span>(<span class="dv">100</span>, <span class="dt">mean =</span> <span class="dv">2</span>, <span class="dt">sd =</span> <span class="dv">3</span>) <span class="co"># случайная выборка из 100 нормальных N(2; 9) величин</span>
<span class="kw">head</span>(x, <span class="dv">10</span>) <span class="co"># первые 10 элементов вектора</span></code></pre></div>
<pre><code>##  [1]  2.8133431  5.5480578 -3.4726572  0.5462824 -1.7972469 -5.1008670
##  [7]  1.6356092  3.9687793  4.4972188 -2.4802381</code></pre>
<ul>
<li>Функция плотности — <code>dnorm</code>:</li>
</ul>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">x &lt;-<span class="st"> </span><span class="kw">seq</span>(<span class="dt">from =</span> -<span class="dv">6</span>, <span class="dt">to =</span> <span class="dv">10</span>, <span class="dt">length.out =</span> <span class="dv">100</span>)
y &lt;-<span class="st"> </span><span class="kw">dnorm</span>(x, <span class="dt">mean =</span> <span class="dv">2</span>, <span class="dt">sd =</span> <span class="dv">3</span>)
<span class="kw">qplot</span>(<span class="dt">x =</span> x, <span class="dt">y =</span> y, <span class="dt">geom =</span> <span class="st">&quot;line&quot;</span>) +<span class="st"> </span><span class="kw">xlab</span>(<span class="st">&quot;Значения случайной величины $X$&quot;</span>) +<span class="st"> </span><span class="kw">ylab</span>(<span class="st">&quot;Функция плотности&quot;</span>)</code></pre></div>
<p><img src="03_statistics_and_more_files/figure-html/normal_pdf_plot-1.png" width="672" /></p>
<p>Для дискретных распределений с буквы <code>d</code> начинается название функции, возвращающей вероятность получить заданное значение. Найдём для случайной величины <span class="math inline">\(W\)</span>, имеющей Пуассоновское распределение с параметром <span class="math inline">\(\lambda = 2\)</span> вероятность <span class="math inline">\(P(W = 3)\)</span>:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">dpois</span>(<span class="dv">3</span>, <span class="dt">lambda =</span> <span class="dv">2</span>)</code></pre></div>
<pre><code>## [1] 0.180447</code></pre>
<ul>
<li>Функция распределения, <span class="math inline">\(F(t)=P(X\leq t)\)</span> — <code>pnorm</code>:</li>
</ul>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">x &lt;-<span class="st"> </span><span class="kw">seq</span>(<span class="dt">from =</span> -<span class="dv">6</span>, <span class="dt">to =</span> <span class="dv">10</span>, <span class="dt">length.out =</span> <span class="dv">100</span>)
y &lt;-<span class="st"> </span><span class="kw">pnorm</span>(x, <span class="dt">mean =</span> <span class="dv">2</span>, <span class="dt">sd =</span> <span class="dv">3</span>)
<span class="kw">qplot</span>(<span class="dt">x =</span> x, <span class="dt">y =</span> y, <span class="dt">geom =</span> <span class="st">&quot;line&quot;</span>) +<span class="st"> </span><span class="kw">xlab</span>(<span class="st">&quot;Значения случайной величины $X$&quot;</span>) +<span class="st"> </span><span class="kw">ylab</span>(<span class="st">&quot;Функция распределения&quot;</span>)</code></pre></div>
<p><img src="03_statistics_and_more_files/figure-html/normal_cdf_plot-1.png" width="672" /></p>
<ul>
<li>Квантильная функция или обратная функция распределения, <span class="math inline">\(q(x) = F^{-1}(x)\)</span> — <code>qnorm</code>:</li>
</ul>
<p>Найдём перцентили 5%, 15% и 90% для нормального <span class="math inline">\(N(2; 9)\)</span> распределения:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">x &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="fl">0.05</span>, <span class="fl">0.15</span>, <span class="fl">0.9</span>)
<span class="kw">qnorm</span>(x, <span class="dt">mean =</span> <span class="dv">2</span>, <span class="dt">sd =</span> <span class="dv">3</span>)</code></pre></div>
<pre><code>## [1] -2.934561 -1.109300  5.844655</code></pre>
<p>Иногда бывает полезно получить случайную выборку из заданного вектора без повторений:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">sample</span>(<span class="dv">1</span>:<span class="dv">100</span>, <span class="dt">size =</span> <span class="dv">20</span>)</code></pre></div>
<pre><code>##  [1]  30  67  55  21  95  23  83 100  73  97  36  63  11  33  75  91  27
## [18]  65  60  70</code></pre>
<p>Или с повторениями:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">sample</span>(<span class="kw">c</span>(<span class="st">&quot;Орёл&quot;</span>, <span class="st">&quot;Решка&quot;</span>), <span class="dt">size =</span> <span class="dv">10</span>, <span class="dt">replace =</span> <span class="ot">TRUE</span>)</code></pre></div>
<pre><code>##  [1] &quot;Решка&quot; &quot;Решка&quot; &quot;Орёл&quot;  &quot;Решка&quot; &quot;Орёл&quot;  &quot;Орёл&quot;  &quot;Орёл&quot;  &quot;Решка&quot;
##  [9] &quot;Орёл&quot;  &quot;Решка&quot;</code></pre>
<p>Можно добавить неравные вероятности:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">sample</span>(<span class="kw">c</span>(<span class="st">&quot;Орёл&quot;</span>, <span class="st">&quot;Решка&quot;</span>), <span class="dt">size =</span> <span class="dv">10</span>, <span class="dt">replace =</span> <span class="ot">TRUE</span>, <span class="dt">prob =</span> <span class="kw">c</span>(<span class="fl">0.3</span>, <span class="fl">0.7</span>))</code></pre></div>
<pre><code>##  [1] &quot;Орёл&quot;  &quot;Решка&quot; &quot;Орёл&quot;  &quot;Решка&quot; &quot;Решка&quot; &quot;Решка&quot; &quot;Орёл&quot;  &quot;Орёл&quot; 
##  [9] &quot;Орёл&quot;  &quot;Орёл&quot;</code></pre>
<p>Если выполнить команду <code>rnorm(10, mean = 2, sd = 3)</code> на двух разных компьютерах или два раза на одном и том же, то результат будет разный. Не зря же они случайные :) Однако генерирование случайных величин никак не противоречит идее абсолютно точной воспроизводимости исследований. Для того, чтобы получились одинаковые результаты, необходимо синхронизировать генераторы случайных чисел на этих двух компьютерах. Делается это путём задания <strong>зерна</strong> генератора случайных чисел (seed). Зерно также называют <strong>стартовым значением</strong>. В качестве зерна подойдёт любое целое число.</p>
<p>И в результате запуска кода</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">set.seed</span>(<span class="dv">42</span>)
<span class="kw">rnorm</span>(<span class="dv">1</span>, <span class="dt">mean =</span> <span class="dv">2</span>, <span class="dt">sd =</span> <span class="dv">3</span>)</code></pre></div>
<pre><code>## [1] 6.112875</code></pre>
<p>все компьютеры выведут число <span class="math inline">\(6.112875\)</span>.</p>
<div class="warning">
<p>
Если код содержит генерерирование случайных чисел, то необходимо задавать зерно генератора случайных чисел!
</p>
</div>
</div>
<div id="statistical_tests" class="section level2">
<h2><span class="header-section-number">3.2</span> Базовые статистические тесты</h2>
<p>…</p>
</div>
<div id="classic_regression" class="section level2">
<h2><span class="header-section-number">3.3</span> Множественная регрессия</h2>
<p>…</p>
<p>Эконометристы любят копаться в остатках :)</p>
<p><a href="https://www.r-bloggers.com/visualising-residuals/" class="uri">https://www.r-bloggers.com/visualising-residuals/</a></p>
</div>
<div id="quantile_regression" class="section level2">
<h2><span class="header-section-number">3.4</span> Квантильная регрессия</h2>
<p>Незаслуженно забытой оказывается квантильная регрессия. Коэнкер (ссылка…) утверждает, что развитие эконометрики началось именно с квантильной регрессии. Для оценок квантильной регрессии не существует формул в явном виде, поэтому она проиграла классической регрессии среднего с готовой формулой <span class="math inline">\(\hat\beta = (X&#39;X)^{-1}X&#39;y\)</span>. Сейчас компьютер позволяет начихать на отсутствие явных формул :)</p>
<p>…</p>
</div>
<div id="instrumental_variables" class="section level2">
<h2><span class="header-section-number">3.5</span> Инструментальные переменные</h2>
<p>Каждый исследователь мечтает обнаружить не просто статистическую связь, а причинно-следственную. К сожалению, это не так просто. Записывая количество людей с зонтиками на улице и количество осадков но не зная физическую природу дождя, невозможно определить, вызывают ли люди с зонтиками дождь или наоборот. Для выяснения причинно-следственных связей необходим случайный эксперимент. Например, можно выбрать несколько случайных дней в году и выгнать толпу знакомых с зонтами на улицу, а затем посмотреть, было ли больше осадков в эти дни.</p>
<p>Использование инструментальных переменных не гарантирует нахождение причинно-следственной связи! Однако они могут быть полезны.</p>
<div class="warning">
<p>
Для обнаружения причинно-следственной связи необходимо либо использовать данные случайного эксперимента, либо прекрасно разбираться в закономерностях происходящего.
</p>
</div>
<p>Этот раздел не о том, как обнаружить причинно-следственную связь, а о том, как реализовать метод инструментальных переменных в R и как его проинтепретировать.</p>
</div>
<div id="heteroskedasticity" class="section level2">
<h2><span class="header-section-number">3.6</span> Гетероскедастичность</h2>
<p>Подключаем нужные пакеты:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(<span class="st">&quot;ggplot2&quot;</span>) <span class="co"># графики</span>
<span class="kw">library</span>(<span class="st">&quot;sandwich&quot;</span>) <span class="co"># оценка Var для гетероскедастичности</span>
<span class="kw">library</span>(<span class="st">&quot;lmtest&quot;</span>) <span class="co"># тест Бройша-Пагана</span>
<span class="kw">library</span>(<span class="st">&quot;dplyr&quot;</span>) <span class="co"># манипуляции с данными</span></code></pre></div>
<p>Условная гетероскедастичность — <span class="math inline">\(Var(\epsilon_i | x_i)\neq const\)</span>.</p>
<p>Последствия</p>
<ul>
<li>Нарушены предпосылки теоремы Гаусса-Маркова. Получаемые <span class="math inline">\(\hat{\beta}_{ols}\)</span> не являются эффективными.</li>
<li>Несмещенность оценок <span class="math inline">\(\hat{\beta}_{ols}\)</span> сохраняется</li>
<li>Нарушены предпосылки для использования <span class="math inline">\(t\)</span>-статистик. При использовании стандартных формул <span class="math inline">\(t\)</span>-статистики не имеют <span class="math inline">\(t\)</span>-распределения. Доверительные интервалы и проверка гипотез по стандартным формулам даёт неверные результаты.</li>
</ul>
<p>Что делать?</p>
<ul>
<li>Если нужны несмещенные оценки — ничего</li>
<li>Если нужно проверять гипотезы или строить доверительные интервалы, то нужно использовать правильную формулу для <span class="math inline">\(\widehat{Var}(\hat{\beta})\)</span>.</li>
<li>Если нужны эффективные оценки и есть представление о том, какого вида может быть гетероскедастичность то можно взвесить наблюдения. Оценить регрессию:</li>
</ul>
<p><span class="math display">\[
\frac{y_i}{\hat{\sigma}_i}=\beta_1 \frac{1}{\hat{\sigma}_i}+\beta_2 \frac{x_i}{\hat{\sigma}_i}+\frac{\epsilon_i}{\hat{\sigma}_i}
\]</span></p>
<ul>
<li>Задать другой вопрос:
<ul>
<li>Вместо регрессии <span class="math inline">\(y_i=\beta_1+\beta_2 x_i+\epsilon_i\)</span> попробовать оценить регрессию <span class="math inline">\(\ln(y_i)=\beta_1+\beta_2 \ln(x_i)+\epsilon_i\)</span>.</li>
<li>Оценить квантильную регрессию</li>
</ul></li>
</ul>
<p>Файл с данными по стоимости квартир в Москве доступен по ссылке <a href="http://goo.gl/zL5JQ">goo.gl/zL5JQ</a></p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">filename &lt;-<span class="st"> &quot;datasets/flats_moscow.txt&quot;</span>
flats &lt;-<span class="st"> </span><span class="kw">read.table</span>(filename, <span class="dt">header =</span> <span class="ot">TRUE</span>)


<span class="kw">ggplot</span>(flats) +<span class="st"> </span><span class="kw">geom_point</span>(<span class="kw">aes</span>(<span class="dt">x =</span> totsp, <span class="dt">y =</span> price)) +<span class="st"> </span>
<span class="st">  </span><span class="kw">labs</span>(<span class="dt">x =</span> <span class="st">&quot;Общая площадь квартиры, кв.м.&quot;</span>, <span class="dt">y =</span> <span class="st">&quot;Цена квартиры, тысяч у.е.&quot;</span>, 
  <span class="dt">title =</span> <span class="st">&quot;Стоимость квартир в Москве&quot;</span>)</code></pre></div>
<p><img src="03_statistics_and_more_files/figure-html/read_table_plot_flats-1.png" width="672" /></p>
<p>Строим регрессию стоимости на общую площадь.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">m1 &lt;-<span class="st"> </span><span class="kw">lm</span>(price ~<span class="st"> </span>totsp, <span class="dt">data =</span> flats)
<span class="kw">summary</span>(m1)</code></pre></div>
<pre><code>## 
## Call:
## lm(formula = price ~ totsp, data = flats)
## 
## Residuals:
##     Min      1Q  Median      3Q     Max 
## -120.58  -17.44   -3.56   10.99  444.52 
## 
## Coefficients:
##              Estimate Std. Error t value Pr(&gt;|t|)    
## (Intercept) -62.04484    3.71178  -16.72   &lt;2e-16 ***
## totsp         2.59346    0.04973   52.15   &lt;2e-16 ***
## ---
## Signif. codes:  0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1
## 
## Residual standard error: 33.96 on 2038 degrees of freedom
## Multiple R-squared:  0.5716, Adjusted R-squared:  0.5714 
## F-statistic:  2719 on 1 and 2038 DF,  p-value: &lt; 2.2e-16</code></pre>
<p>Покажем доверительные интервалы для коэффициентов из регрессии.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">confint</span>(m1)</code></pre></div>
<pre><code>##                  2.5 %     97.5 %
## (Intercept) -69.324117 -54.765570
## totsp         2.495927   2.690998</code></pre>
<p>Посмотрим на <span class="math inline">\(\widehat{Var}(\hat{\beta}|X)\)</span>.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">vcov</span>(m1)</code></pre></div>
<pre><code>##             (Intercept)        totsp
## (Intercept)  13.7772925 -0.180775186
## totsp        -0.1807752  0.002473516</code></pre>
<p>Если не хотим смотреть на всё summary, а только на то, что касается бет с крышкой.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">coeftest</span>(m1)</code></pre></div>
<pre><code>## 
## t test of coefficients:
## 
##               Estimate Std. Error t value  Pr(&gt;|t|)    
## (Intercept) -62.044844   3.711778 -16.716 &lt; 2.2e-16 ***
## totsp         2.593462   0.049734  52.146 &lt; 2.2e-16 ***
## ---
## Signif. codes:  0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1</code></pre>
<p>Как было сказано ранее: если в данных присутствует гетероскедастичность, но нужно проверить гипотезы и строить доверительные интервалы, то нужно использовать правильную оценку ковариационной матрицы, она выглядит так: <span class="math display">\[
\widehat{Var}_{HC}(\hat{\beta}|X)=(X&#39;X)^{-1}X&#39;\hat{\Omega}X(X&#39;X)^{-1}
\]</span></p>
<p><span class="math display">\[
\hat{\Omega}=diag(\hat{\sigma}^2_1,\ldots,\hat{\sigma}^2_n)
\]</span></p>
<p>Есть разные способы состоятельно оценить отдельные дисперсии <span class="math inline">\(\hat{\sigma}^2_i\)</span>, подробно можно почитать в описании пакета <a href="http://cran.r-project.org/web/packages/sandwich/vignettes/sandwich.pdf"><code>sandwich</code></a>. Наиболее популярный на сегодня — это так называемый “HC3”: <span class="math display">\[
\hat{\sigma}^2_i=\frac{\hat{\epsilon}_i^2}{(1-h_{ii})^2}
\]</span></p>
<p>Здесь <span class="math inline">\(h_{ii}\)</span> — диагональный элемент матрицы-шляпницы (hat matrix), <span class="math inline">\(\hat{y}=Hy\)</span>, <span class="math inline">\(H=X(X&#39;X)^{-1}X&#39;\)</span>. Матрицу-шляпницу также называют проектором, т.к. она проецирует вектор <span class="math inline">\(y\)</span> на линейную оболочку регрессоров.</p>
<p>Посмотрим на матрицу <span class="math inline">\(\widehat{Var}_{HC}(\hat{\beta}|X)\)</span> в R.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">vcovHC</span>(m1)</code></pre></div>
<pre><code>##             (Intercept)       totsp
## (Intercept)  61.7662920 -0.89503034
## totsp        -0.8950303  0.01303563</code></pre>
<p>Применяя правильную <span class="math inline">\(\widehat{Var}_{HC}(\hat{\beta}|X)\)</span>, проверим гипотезы.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">coeftest</span>(m1, <span class="dt">vcov =</span> <span class="kw">vcovHC</span>(m1))</code></pre></div>
<pre><code>## 
## t test of coefficients:
## 
##              Estimate Std. Error t value  Pr(&gt;|t|)    
## (Intercept) -62.04484    7.85915 -7.8946 4.716e-15 ***
## totsp         2.59346    0.11417 22.7151 &lt; 2.2e-16 ***
## ---
## Signif. codes:  0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1</code></pre>
<p>Доверительный интервал надо строить руками. За основу мы возьмем табличку с правильными стандартными ошибками и прибавим и вычтем их от оценок коэффициентов.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">conftable &lt;-<span class="st"> </span><span class="kw">coeftest</span>(m1, <span class="dt">vcov =</span> <span class="kw">vcovHC</span>(m1))
ci &lt;-<span class="st"> </span><span class="kw">data_frame</span>(<span class="dt">estimate =</span> conftable[, <span class="dv">1</span>], 
                 <span class="dt">se_hc =</span> conftable[, <span class="dv">2</span>],
                 <span class="dt">left_95 =</span> estimate -<span class="st"> </span><span class="kw">qnorm</span>(<span class="fl">0.975</span>)*se_hc,
                 <span class="dt">right_95 =</span> estimate +<span class="st"> </span><span class="kw">qnorm</span>(<span class="fl">0.975</span>)*se_hc)
ci</code></pre></div>
<pre><code>## # A tibble: 2 x 4
##     estimate     se_hc    left_95   right_95
##        &lt;dbl&gt;     &lt;dbl&gt;      &lt;dbl&gt;      &lt;dbl&gt;
## 1 -62.044844 7.8591534 -77.448501 -46.641186
## 2   2.593462 0.1141737   2.369686   2.817239</code></pre>
<p>Ещё есть малоизвестный пакет <code>Greg</code> Макса Гордона и в нём есть готовая функция:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">Greg::<span class="kw">confint_robust</span>(m1)</code></pre></div>
<p>Пакет <code>Greg</code> не доступен на официальном репозитории CRAN, ставится с <code>github</code> командой <code>devtools::install_github(&quot;gforge/Greg&quot;)</code>. Пакет <code>Greg</code> тянет за собой такую кучу всего, что не хочется его ставить ради одной функции. Здесь уместно упражнение: сделайте функцию <code>confint_robust</code> самостоятельно :)</p>
<p>В условиях гетероскедастичности обычная <span class="math inline">\(t\)</span>-статистика не имеет ни <span class="math inline">\(t\)</span>-распределения при нормальных <span class="math inline">\(\varepsilon_i\)</span>, ни даже асимптотически нормального. И такая же проблема возникает с <span class="math inline">\(F\)</span>-статистикой для сравнения вложенных моделей. Отныне привычная <span class="math inline">\(F\)</span>-статистика</p>
<p><span class="math display">\[
F=\frac{(RSS_R-RSS_{UR})/r}{RSS_{UR}/(n-k_{UR})}
\]</span></p>
<p>не имеет ни <span class="math inline">\(F\)</span>-распределения при нормальных остатках, ни <span class="math inline">\(\chi^2\)</span>-распределения асимптотически. В частности, для проверки незначимости регрессии в целом некорректно использовать <span class="math inline">\(F\)</span>-статистику равную <span class="math inline">\(F=\frac{ESS/(k-1)}{RSS/(n-k)}\)</span>.</p>
<p>Если для теста Вальда использовать корректную оценку ковариационной матрицы, то его можно применять в условиях гетероскедастичности. Допустим, мы хотим проверить гипотезу <span class="math inline">\(H_0\)</span>: <span class="math inline">\(A\beta=b\)</span>, состоящую из <span class="math inline">\(q\)</span> уравнений, против альтернативной о том, что хотя бы одно равенство нарушено. Тогда статистика Вальда имеет вид:</p>
<p><span class="math display">\[
W = (A\beta - b)&#39;(A\cdot \widehat{Var}_{HC}(\hat\beta)A&#39;)^{-1}(A\beta - b)
\]</span></p>
<p>и имеет асимптотически <span class="math inline">\(\chi^2\)</span>-распределение с <span class="math inline">\(q\)</span> степенями свободы.</p>
<p>В R реализуется с помощью опции для команды <code>waldtest</code>. Покажем на примере гипотезы о незначимости регрессии в целом:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">m0 &lt;-<span class="st"> </span><span class="kw">lm</span>(price ~<span class="st"> </span><span class="dv">1</span>, <span class="dt">data =</span> flats) <span class="co"># оцениваем ограниченную модель (регрессия на константу)</span>
<span class="kw">waldtest</span>(m0, m1, <span class="dt">vcov =</span> <span class="kw">vcovHC</span>(m1))</code></pre></div>
<pre><code>## Wald test
## 
## Model 1: price ~ 1
## Model 2: price ~ totsp
##   Res.Df Df      F    Pr(&gt;F)    
## 1   2039                        
## 2   2038  1 515.97 &lt; 2.2e-16 ***
## ---
## Signif. codes:  0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1</code></pre>
<p>Переходим ко взвешенному МНК. Взвешенный МНК требует знания структуры гетероскедастичности, что редко встречается на практике. Предположим, что в нашем случае <span class="math inline">\(Var(\epsilon_i | totsp_i) = const \cdot totsp_i\)</span>.</p>
<p>В R вектор весов <code>weights</code> должен быть обратно пропорционален дисперсиям, т.е. <span class="math inline">\(w_i=1/\sigma^2_i\)</span>.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">m2 &lt;-<span class="st"> </span><span class="kw">lm</span>(price ~<span class="st"> </span>totsp, <span class="dt">weights =</span> <span class="kw">I</span>(<span class="dv">1</span> /<span class="st"> </span>totsp), <span class="dt">data =</span> flats)
<span class="kw">summary</span>(m2)</code></pre></div>
<pre><code>## 
## Call:
## lm(formula = price ~ totsp, data = flats, weights = I(1/totsp))
## 
## Weighted Residuals:
##     Min      1Q  Median      3Q     Max 
## -11.571  -1.994  -0.591   1.235  39.088 
## 
## Coefficients:
##              Estimate Std. Error t value Pr(&gt;|t|)    
## (Intercept) -52.50302    3.53967  -14.83   &lt;2e-16 ***
## totsp         2.46290    0.04931   49.95   &lt;2e-16 ***
## ---
## Signif. codes:  0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1
## 
## Residual standard error: 3.58 on 2038 degrees of freedom
## Multiple R-squared:  0.5504, Adjusted R-squared:  0.5501 
## F-statistic:  2495 on 1 and 2038 DF,  p-value: &lt; 2.2e-16</code></pre>
<div id="hetero_testing" class="section level3">
<h3><span class="header-section-number">3.6.1</span> Тесты на гетероскедастичность</h3>
<p>Графическое обнаружение гетероскедастичности:</p>
<ul>
<li>Оценивается исходная регрессия и из неё получаются остатки <span class="math inline">\(\hat{\varepsilon}_i\)</span>.</li>
<li>Если верить в гомоскедастичность, то дисперсия вектора остатков определяется по формуле <span class="math inline">\(Var(\hat{\varepsilon}|X)=\sigma^2 (I-X(X&#39;X)^{-1}X&#39;)\)</span>. Т.е. дисперсия у остатков разная (!) даже если <span class="math inline">\(Var(\varepsilon_i|X)=\sigma^2\)</span>. Поэтому остатки стандартизуют по формуле: <span class="math display">\[
s_i = \frac{\varepsilon_i}{\sqrt{\hat{\sigma}^2(1-h_{ii})}}
\]</span> Остатки полученные после такого преобразования называют стандартизированными или иногда стьюдентизированными.</li>
<li>Можно построить график зависимости величины <span class="math inline">\(s_i^2\)</span> или <span class="math inline">\(|s_i|\)</span> от переменной, предположительно повинной в гетроскедастичности.</li>
</ul>
<p>В R:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">m1.st.resid &lt;-<span class="st"> </span><span class="kw">rstandard</span>(m1) <span class="co"># получаем стандартизированные остатки</span>
<span class="kw">ggplot</span>(<span class="kw">aes</span>(<span class="dt">x =</span> totsp, <span class="dt">y =</span> <span class="kw">abs</span>(m1.st.resid)), <span class="dt">data =</span>flats) +<span class="st"> </span><span class="kw">geom_point</span>(<span class="dt">alpha =</span> <span class="fl">0.2</span>) +<span class="st"> </span>
<span class="st">  </span><span class="kw">labs</span>(<span class="dt">x =</span> <span class="st">&quot;Общая площадь квартиры, кв.м&quot;</span>, <span class="dt">y =</span> <span class="kw">expression</span>(<span class="kw">paste</span>(<span class="st">&quot;Стандартизированные остатки, &quot;</span>, s[i])),
  <span class="dt">title =</span> <span class="st">&quot;Графическое обнаружение гетероскедастичности&quot;</span>)</code></pre></div>
<p><img src="03_statistics_and_more_files/figure-html/standartised_residuals_plot-1.png" width="672" /></p>
<p>Иногда для простоты пропускают второй шаг со стандартизацией остатков и в результате могут ошибочно принять принять разную <span class="math inline">\(Var(\hat{\varepsilon}_i)\)</span> за гетероскедастичность, т.е. за разную <span class="math inline">\(Var(\varepsilon_i)\)</span>. Впрочем, если гетероскедастичность сильная, то её будет видно и на нестандартизированных остатках.</p>
</div>
<div id="hetero_bp_test" class="section level3">
<h3><span class="header-section-number">3.6.2</span> Тест Бройша-Пагана, Breusch-Pagan:</h3>
<p>Есть две версии теста Бройша-Пагана: авторская и современная модификация.</p>
<p>Предпосылки авторской версии:</p>
<ul>
<li>нормальность остатков, <span class="math inline">\(\varepsilon_i \sim N(0,\sigma^2_i)\)</span></li>
<li><span class="math inline">\(\sigma^2_i=h(\alpha_1+\alpha_2 z_{i2}+\ldots+\alpha_{p}z_{ip})\)</span></li>
<li>у функции <span class="math inline">\(h\)</span> существуют первая и вторая производные</li>
<li>тест асимптотический</li>
</ul>
<p>Суть теста: Используя метод максимального правдоподобия посчитаем LM-статистику. При верной <span class="math inline">\(H_0\)</span> она имеет хи-квадрат распределение с <span class="math inline">\(p-1\)</span> степенью свободы.</p>
<p>Оказывается, что LM-статистику можно получить с помощью вспомогательной регрессии. Авторская процедура:</p>
<ol style="list-style-type: decimal">
<li>Оценивается регрессия <span class="math inline">\(y_i=\beta_1+\beta_2 x_i +\varepsilon_i\)</span></li>
<li>Переходим к <span class="math inline">\(g_i=\frac{n}{SSR}\hat{\varepsilon_i}\)</span></li>
<li>Строим регрессию <span class="math inline">\(g_i\)</span> на <span class="math inline">\(\alpha_1+\alpha_2 z_{i2}+\ldots+\alpha_{p}z_{ip}\)</span></li>
<li><span class="math inline">\(LM=\frac{ESS}{2}\)</span></li>
</ol>
<p>Современная модификация выглядит (неизвестный рецензент Коэнкера) так:</p>
<ol style="list-style-type: decimal">
<li>Оценивается регрессия <span class="math inline">\(y_i=\beta_1+\beta_2 x_i +\varepsilon_i\)</span></li>
<li>Оценивается регрессия <span class="math inline">\(\hat{\varepsilon_i^2}\)</span> на переменные вызывающие гетероскедастичность</li>
<li>При верной <span class="math inline">\(H_0\)</span> асимптотически: <span class="math display">\[
nR^2 \sim \chi^2_{p-1},
\]</span> где <span class="math inline">\(p\)</span> — число оцениваемых коэффициентов во вспомогательной регрессии. По смыслу <span class="math inline">\((p-1)\)</span> — это количество факторов, от которых потенциально может зависеть дисперсия <span class="math inline">\(Var(\varepsilon_i)\)</span>.</li>
</ol>
<p>Тест Бройша-Пагана в R:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">bptest</span>(m1) <span class="co"># версия Коэнкера</span></code></pre></div>
<pre><code>## 
##  studentized Breusch-Pagan test
## 
## data:  m1
## BP = 201.95, df = 1, p-value &lt; 2.2e-16</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">bptest</span>(m1, <span class="dt">studentize =</span> <span class="ot">FALSE</span>) <span class="co"># классика Бройша-Пагана</span></code></pre></div>
<pre><code>## 
##  Breusch-Pagan test
## 
## data:  m1
## BP = 2366, df = 1, p-value &lt; 2.2e-16</code></pre>
<p>У современной модификации Бройша-Пагана более слабые предпосылки:</p>
<ul>
<li><span class="math inline">\(H_0\)</span>: <span class="math inline">\(Var(\varepsilon_i)=\sigma^2\)</span>, нормальность не требуется</li>
<li><span class="math inline">\(E(\varepsilon_i^4)=const\)</span></li>
<li>тест асимптотический</li>
<li>(? Коэнкер в статье критикует что-то про мощность ?)</li>
</ul>
</div>
<div id="white_test" class="section level3">
<h3><span class="header-section-number">3.6.3</span> Тест Уайта. White test</h3>
<p>Предпосылки:</p>
<ul>
<li><span class="math inline">\(H_0\)</span>: <span class="math inline">\(Var(\varepsilon_i)=\sigma^2\)</span>, нормальность не требуется</li>
<li><span class="math inline">\(E(\varepsilon_i^4)=const\)</span></li>
<li>тест асимптотический</li>
</ul>
<p>Процедура:</p>
<ol style="list-style-type: decimal">
<li>Оценивается регрессия <span class="math inline">\(y_i=\beta_1+\beta_2 x_i +\varepsilon_i\)</span></li>
<li>Строим регрессию <span class="math inline">\(\hat{\varepsilon_i^2}\)</span> на исходные регрессоры и их квадраты</li>
<li>Асимптотически <span class="math inline">\(nR^2\)</span> имеет хи-квадрат распределение</li>
</ol>
<p>Тест Уайта в R:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">bptest</span>(m1, <span class="dt">varformula =</span> ~<span class="st"> </span>totsp +<span class="st"> </span><span class="kw">I</span>(totsp^<span class="dv">2</span>), <span class="dt">data =</span> flats)</code></pre></div>
<pre><code>## 
##  studentized Breusch-Pagan test
## 
## data:  m1
## BP = 247.35, df = 2, p-value &lt; 2.2e-16</code></pre>
<p>Тест Уайта является частным случаем современной модификации теста Бройша-Пагана. В тесте Бройша-Пагана во вспомогательной регресии можно брать любые объясняющие переменные. В тесте Уайта берутся исходные регрессоры, их квадраты и попарные произведения. Если в R попросить сделать тест Бройша-Пагана и не указать спецификацию вспомогательной регрессии, то он возьмет только все регрессоры исходной.</p>
</div>
<div id="gq_test" class="section level3">
<h3><span class="header-section-number">3.6.4</span> Тест Goldfeld-Quandt</h3>
<p>Предпосылки:</p>
<ul>
<li>нормальность остатков, <span class="math inline">\(\varepsilon_i \sim N(0,\sigma^2_i)\)</span></li>
<li>Наблюдения упорядочены по возростанию гетероскедастичности</li>
<li>тест точный (неасимптотический)</li>
</ul>
<p>Процедура:</p>
<ol style="list-style-type: decimal">
<li>Упорядочить наблюдения в том порядке, в котором подозревается рост гетероскедастичности</li>
<li>Выкинуть некий процент наблюдений по середине, чтобы подчеркнуть разницу в дисперсии между начальными и конечными наблюдениями.</li>
<li>Оценить исходную модель по наблюдениям из начала выборки и по наблюдениям конца выборки</li>
<li>Получить, соответственно, <span class="math inline">\(RSS_1\)</span> и <span class="math inline">\(RSS_2\)</span></li>
</ol>
<p>При верной <span class="math inline">\(H_0\)</span> <span class="math display">\[
\frac{RSS_2}{RSS_1}\sim F_{r-k,r-k},
\]</span> где <span class="math inline">\(r\)</span> — размер подвыборки в начале и в конце.</p>
<p>Тест Голдфельда-Квандта в R:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">flats2 &lt;-<span class="st"> </span>flats[<span class="kw">order</span>(flats$totsp), ] <span class="co"># сменим порядок строк в табличке h</span>
m3 &lt;-<span class="st"> </span><span class="kw">lm</span>(price ~<span class="st"> </span>totsp, <span class="dt">data =</span> flats2) 
<span class="kw">gqtest</span>(m3, <span class="dt">fraction =</span> <span class="fl">0.2</span>) <span class="co"># проведем GQ тест выкинув посередине 20% наблюдений</span></code></pre></div>
<pre><code>## 
##  Goldfeld-Quandt test
## 
## data:  m3
## GQ = 8.2121, df1 = 814, df2 = 814, p-value &lt; 2.2e-16
## alternative hypothesis: variance increases from segment 1 to 2</code></pre>
</div>
<div id="hetero_fail" class="section level3">
<h3><span class="header-section-number">3.6.5</span> Тестирование и борьба с гетероскедастичностью</h3>
<p>Чайники часто используют такой <em>ошибочный</em> подход:</p>
<p>Протестировать гетероскедастичность. Если тесты выявили гетероскедастичность, то бороться с ней (использовать устойчивые стандартные ошибки или применять взвешенный мнк). Если тесты не выявили гетероскедастичность, то не бороться с ней.</p>
<p>Этот подход неверен!</p>
<p>Правильно делать так:</p>
<ul>
<li>Если есть теоретические основания ожидать гетероскедастичность и наблюдений достаточно, то использовать устойчивые стандартные ошибки вне зависимости от результатов тестирования.</li>
<li>Если есть теоретические основания ожидать гетероскедастичность и наблюдений мало, то отказаться от девичьих грёз об эффективности оценок и проверке гипотез. Довольствоваться возможной несмещенностью оценок.</li>
</ul>
<p>Тут обычно спрашивают: “А зачем же тогда тестировать на гетероскедастичность, если это решение ни на что не влияет?”. Ответ прост — чтобы узнать, есть ли гетероскедастичность. :) Впрочем, если есть теоретические основания её ожидать, то можно и не тестировать.</p>
</div>
<div id="hetero_forecasting" class="section level3">
<h3><span class="header-section-number">3.6.6</span> Прогнозирование при гетероскедастичности</h3>
<p>При прогнозировании строят доверительный интервал для среднего значения зависимой переменной и предиктивный интервал для конкретного будущего значения. С доверительным интервалом похоже надо код писать руками:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># ...</span></code></pre></div>
<p>С предиктивным интервалом чуть сложнее. Поскольку предиктивный интервал строиться для конкретного наблюдения, то нам надо знать дисперсию этого наблюдения. Идея робастных ошибок состоит в том, чтобы проверять гипотезы не делая точных предположений о структуре гетероскедастичности. Поэтому при использовании робастных стандартных ошибок традиционно предиктивные интервалы не строят.</p>
<p>Хм. А если взять парадигму рандомных регрессоров и оценку безусловной дисперсии?</p>
<p>Если же случилось чудо и структура гетероскедастичности доподлинно известна, то мы спокойно используем взвешенный МНК и указываем вес для новых наблюдений.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># ...</span></code></pre></div>
</div>
<div id="hetero_links" class="section level3">
<h3><span class="header-section-number">3.6.7</span> Дополнительно:</h3>
<ul>
<li><a href="http://cran.r-project.org/web/packages/sandwich/vignettes/sandwich.pdf">Описание пакета <code>sandwich</code></a> с очень правильным изложением современного взгляда на гетероскедастичность</li>
<li>Breusch, Pagan, <a href="http://www.jstor.org/stable/1911963">Simple test for heteroskedasticity</a></li>
<li>White, <a href="http://www.jstor.org/stable/1912934">A Heteroskedasticity-Consistent Covariance Matrix Estimator and a Direct Test for Heteroskedasticity</a></li>
<li>Koenker, <a href="http://www.sciencedirect.com/science/article/pii/0304407681900622">A note on studentizing a test for heteroscedasticity</a></li>
</ul>
</div>
</div>
<div id="factor_variables" class="section level2">
<h2><span class="header-section-number">3.7</span> Работа с качественными переменными</h2>
<p>…</p>
</div>
<div id="logit_probit" class="section level2">
<h2><span class="header-section-number">3.8</span> Логит и пробит с визуализацией</h2>
<p>…</p>
</div>
<div id="pca" class="section level2">
<h2><span class="header-section-number">3.9</span> Метод главных компонент</h2>
<p>…</p>
</div>
<div id="multicollinearity" class="section level2">
<h2><span class="header-section-number">3.10</span> Мультиколлинеарность</h2>
<p>…</p>
</div>
<div id="lasso" class="section level2">
<h2><span class="header-section-number">3.11</span> LASSO</h2>
<p>Оказывается, что оценки LASSO для всех значений параметра <span class="math inline">\(\lambda\)</span> можно получить очень быстро! Для этого нам потребуется алгоритм LARS (Least Angle Regresssion):</p>
<ol style="list-style-type: decimal">
<li><p>Положим стартовые значения всех <span class="math inline">\(\beta_j\)</span> равными нулю.</p></li>
<li><p>Найдём регрессор <span class="math inline">\(x_j\)</span> сильнее всего коррелированный с <span class="math inline">\(y\)</span> по модулю</p></li>
<li><p>Изменяем коэффициент <span class="math inline">\(\beta_j\)</span> в направлении знака корреляции <span class="math inline">\(x_j\)</span> и <span class="math inline">\(y_j\)</span>. Попутно считаем остатки <span class="math inline">\(\hat u = y - \hat y\)</span>. Прекращаем изменять коэффициент <span class="math inline">\(\beta_j\)</span>, как только некоторый регрессор <span class="math inline">\(x_k\)</span> будет настолько же сильно коррелирован с <span class="math inline">\(r\)</span> как <span class="math inline">\(x_j\)</span></p></li>
<li><p>Увеличиваем пару <span class="math inline">\((\beta_j, \beta_k)\)</span> в направлении задаваемом линейной регрессией, до тех пор пока у некоторого <span class="math inline">\(x_m\)</span> не будет высокой корреляции с <span class="math inline">\(r\)</span></p></li>
<li><p>Если ненулевой коэффициент уходит в ноль, то выкидываем его из множества активных регрессоров.</p></li>
<li><p>Продолжаем до тех пор, пока все регрессоры не вошли в модель.</p></li>
</ol>
</div>
<div id="maximum_likelihood" class="section level2">
<h2><span class="header-section-number">3.12</span> Метод максимального правдоподобия</h2>
<p>…</p>
</div>
<div id="svm" class="section level2">
<h2><span class="header-section-number">3.13</span> Метод опорных векторов</h2>
<p>…</p>
</div>
<div id="random_forest" class="section level2">
<h2><span class="header-section-number">3.14</span> Случайный лес</h2>
<p>…</p>
</div>
<div id="exponential_smoothing" class="section level2">
<h2><span class="header-section-number">3.15</span> Экспоненциальное сглаживание</h2>
<p>…</p>
</div>
<div id="arma" class="section level2">
<h2><span class="header-section-number">3.16</span> ARMA модели</h2>
<p>…</p>
</div>
<div id="garch" class="section level2">
<h2><span class="header-section-number">3.17</span> GARCH</h2>
<p>…</p>
</div>
<div id="var_bvar" class="section level2">
<h2><span class="header-section-number">3.18</span> VAR и BVAR</h2>
<p>…</p>
<p>Я не верю в пользу от структурных BVAR, поэтому их здесь нет :)</p>
</div>
<div id="panel_data" class="section level2">
<h2><span class="header-section-number">3.19</span> Панельные данные</h2>
<p>…</p>
</div>
<div id="bayesian_first_steps" class="section level2">
<h2><span class="header-section-number">3.20</span> Байесовский подход: первые шаги</h2>
<p>…</p>
</div>
<div id="stan" class="section level2">
<h2><span class="header-section-number">3.21</span> Байесовский подход: STAN</h2>
<p>…</p>
</div>
<div id="maps" class="section level2">
<h2><span class="header-section-number">3.22</span> Карты</h2>
<blockquote>
<p>Где карта, Билли?</p>
</blockquote>
</div>
<div id="differential_equations" class="section level2">
<h2><span class="header-section-number">3.23</span> Дифференциальные уравнения</h2>
<p>…</p>
</div>
<div id="optimisation" class="section level2">
<h2><span class="header-section-number">3.24</span> Задачи оптимизации</h2>
<p>…</p>
<!--chapter:end:03_statistics_and_more.Rmd-->
</div>
</div>
<div class="footnotes">
<hr />
<ol>
<li id="fn1"><p>Единственным неудачным советом в книжке Воронцова, пожалуй, является выбор кодировки СP1251, правильнее выбирать UTF-8.<a href="#fnref1">↩</a></p></li>
<li id="fn2"><p>Если шестнадцатиричный, то 0451. Ради интереса можно посмотреть сопоставление букв и их кодов в UTF-8, например, на <a href="http://unicode-table.com/ru/">unicode-table.com</a><a href="#fnref2">↩</a></p></li>
<li id="fn3"><p>На самом деле всё немного хитрее и сама Windows технически использует UTF-16, а вот многие приложения под ней — CP1251.<a href="#fnref3">↩</a></p></li>
</ol>
</div>
<!--bookdown:body:end-->
            </section>

          </div>
        </div>
      </div>
<!--bookdown:link_prev-->
<!--bookdown:link_next-->
    </div>
  </div>
<!--bookdown:config-->

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://cdn.bootcss.com/mathjax/2.7.1/MathJax.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:" && /^https?:/.test(script.src))
      script.src  = script.src.replace(/^https?:/, '');
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>

</html>
