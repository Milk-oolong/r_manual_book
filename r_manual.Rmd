--- 
title: "Учебник по языку R для начинающих"
author: "Борис Демешев"
date: '`r Sys.Date()`'
output:
  bookdown::gitbook:
    config:
      download: [["r_manual.pdf", "PDF"], ["r_manual.epub", "EPUB"], ["r_manual.mobi", "MOBI"]]
      edit:
        link: https://github.com/bdemeshev/r_manual_book/issues
      fontsettings:
        family: sans
        size: 2
        theme: white
      search: yes
      sharing:
        all:
        - facebook
        - google
        - twitter
        - weibo
        - instapaper
        - vk
        facebook: yes
        google: no
        instapper: no
        twitter: no
        vk: yes
        weibo: no
      toc:
        after: |
          <li><a href="https://github.com/rstudio/bookdown"   target="blank">Создано с использованием пакета bookdown</a></li>
        before: |
          <li><a href="./">Учебник по языку R для начинающих</a></li>
        collapse: section
        scroll_highlight: yes
      toolbar:
        position: fixed
    css: style.css
  bookdown::html_chapters:
    includes:
      in_header: style.css
  bookdown::pdf_book:
    citation_package: biblatex
    includes:
      in_header: preamble.tex
    keep_tex: yes
    latex_engine: xelatex
  bookdown::epub_book: default
  bookdown::kindlegen:
    epub: _book/r_manual.epub
description: Учебник по языку R и не только :)
documentclass: book
fontsize: 11pt
github-repo: bdemeshev/r_manual_book
lang: ru-RU
link-citations: yes
mainfont: Linux Libertine O
monofont: Linux Libertine O
otherlangs: en-GB
bibliography:
- book.bib
- packages.bib
sansfont: Linux Libertine O
site: bookdown::bookdown_site
biblio-style: alphabetic
---

# О книге {-}

Сейчас живут три кита анализа данных и научных вычислений --- Julia, Python и R. Эта книга про одного из китов!


```{r "knitr options"}
library("knitr")
library("tikzDevice")

activateTikz <- function() {
  
  # tikz plots options
  options(tikzDefaultEngine = "xetex")
  
  # cash font metrics for speed:
  options(tikzMetricsDictionary = "./tikz_metrics") 
  
  add_xelatex <- c("\\defaultfontfeatures{Ligatures=TeX,Scale=MatchLowercase}",
                   "\\setmainfont{Linux Libertine O}",
                   "\\setmonofont{Linux Libertine O}",
                   "\\setsansfont{Linux Libertine O}",
                   "\\newfontfamily{\\cyrillicfonttt}{Linux Libertine O}",
                   "\\newfontfamily{\\cyrillicfont}{Linux Libertine O}",
                   "\\newfontfamily{\\cyrillicfontsf}{Linux Libertine O}")
  
  options(tikzXelatexPackages = c(getOption("tikzXelatexPackages"),
                                  add_xelatex))
  
  # does remove warnings:
  # it is important to remove fontenc package wich is loaded by default
  options(tikzUnicodeMetricPackages = c("\\usetikzlibrary{calc}",    
                                        "\\usepackage{fontspec, xunicode}", add_xelatex)) 
  
  
  opts_chunk$set(dev = "tikz", dev.args = list(pointsize = 11))
}


colFmt <- function(x, color) {
  outputFormat <- opts_knit$get("rmarkdown.pandoc.to")
  if (outputFormat == "latex") {
    result <- paste0("\\textcolor{", color, "}{", x, "}")
  } else if (outputFormat %in% c("html", "epub")) {
    result <- paste0("<font color='", color, "'>", x, "</font>")
  } else {
    result <- x
  }
  return(result)
}

outputFormat <- opts_knit$get("rmarkdown.pandoc.to")


if (outputFormat == "latex") {
  activateTikz()
}

```

Данная версия книги скомпилирована для `r outputFormat`.






<!--chapter:end:index.Rmd-->

# Первые шаги {#first_steps}

> Поехали!
>
> Алексей Гагарин

## Установка софта {#installation}

Казалось бы, чего проще --- поставить программу?! Однако не всегда всё идёт
гладко.

Самая распространённая проблема, с которой мне доводилось бороться на разных
компьютерах, --- это русские буквы и пробелы в названиях файлов и папок под
Windows.

```{block, type="warning"}
Если ты используешь Windows, то никогда при серьёзной работе не
используй русские буквы и пробелы в названиях файлов и папок. 
```


Папку с котиками можно оставить под названием `мои котики` :)

Заповедь о русских буквых легко нарушить даже не осознавая этого. Если имя пользователя Windows написано русскими буквами, например, `Машенька`, то все документы этого пользователя будут находиться в папке `C:/Users/Машенька/Documents/`.


```{block, type="warning"}
Поэтому для серьёзной работы под Windows нужно создать нового пользователя с
английским именем, например, `Mashenka`, залогиниться и работать из-под него.
```

Переименование старого пользователя не помогает.

### R {#install_R}

...



### Rstudio {#install_Rstudio}

...


### LaTeX {#install_Latex}

...


### git-клиент {#install_git}

...


### Текстовый редактор {#install_editor}

Самое важное: Word --- это не текстовый редактор! Текстовый редактор --- это
программа с помощью которой редактируют файлы с простым текстовым содержимым, а
Word сохраняет файлы в специальном формате, где кроме текста сохраняется ещё
куча дополнительной информации. Расширение у текстового файла может быть
довольно произвольным, `.txt`, `.md`, `.R`, `.tex` и так далее.

Текстовых редакторов много. Я советую кросс-платформенный открытый и бесплатный Atom. Скачать его можн на [atom.io](https://atom.io/).



### STAN {#install_STAN}

...



### jupyter {#install_jupyter}

...


### gretl {#install_gretl}

Тебе страшно? Тебя пугает даже список того, что нужно установить? Ты боишься R,
а регрессию надо построить через 5 минут?  Тогда разумное спасение --- это
gretl. Для gretl не обязательно учиться программировать: статистические тесты,
графики и эконометрические модели доступны через меню. Кроме того, gretl даёт
возможность пользователю взаимодействовать с R, что спасает в тех случаях, когда
возможностей gretl не хватает.

Естественно, gretl кросс-платформенный открытый и бесплатный,
[gretl](http://gretl.sourceforge.net/).


## Весёлый калькулятор {#funny_calc}

R можно использовать как весёлый калькулятор: 
```{r} 
5 + 9 
```


Что-нибудь более интересное: 
```{r} 
a <- factorial(4) 
b <- 2^3 
a + b 
```

Признайся, ты всегда мечтал пошалить? Давай пока никто не видит поделим на ноль?
```{r} 
a <- 1 / 0 
a 
```

Что можно делать с бесконечностью, `Inf`? 
```{r} 
1 / (Inf - 9) 
```

Возьмём арктангенс! 
```{r} 
atan(Inf) 
```

Ба! Да это же $\pi/2$: 
```{r} 
pi / 2 
```

Но с неопределенностью ничего не поделаешь: 
```{r} 
0 / 0 
```

Сокращение NaN означает «Not a Number», такой объект возникает в результате запрещённых арифметических операций. 

Также в дебрях R живёт другой интересный зверь ---  NA, «Not Available», пропущенное наблюдение. Наблюдение может быть пропущенным по разным причинам: может быть его не было изначально, а может оно родилось в результате запрещённых арифметических операций. Поэтому всякое NaN является NA, но не всякое NA является NaN. Проверять, является ли что-либо NA или NaN, можно так:

```{r} 
is.na(0 / 0)
is.nan(0 / 0)

a <- NA 
is.na(a) 
is.nan(a) 
```





#### Простые операции с векторами

Вектор из чисел по порядку: 
```{r} 
a <- 3:10 
a
```

Вектор из одинаковых чисел: 
```{r} 
b <- rep(777, times = 5) 
b 
```

Вектор из конкретных чисел: 
```{r} 
vect <- c(5, -4, 1) 
vect
```

Что можно делать с вектором? 
```{r} 
sum(vect) 
```

Хотите среднее арифметическое? 
```{r} 
mean(vect) 
```



### Отбор значений

Выберем из вектора $s$ значения больше $0$: 
```{r} 
b <- s[s > 0] 
b 
```

Можно выбрать конкретные $s$, например с 6-го по 20-ое: ```{r} s[6:20] ```

Хочу 5-ый, 7-ой и 13-ый элементы вектора! 
```{r} 
s[c(5, 7, 13)] 
```

Можно узнать, сколько значений равно 3: 
```{r} 
sum(s == 3) 
```

Еще полезная штучка --- количество элементов в векторе: 
```{r} 
length(b) 
```

Операции, похожие на те, что проделали с векторами, можно делать и с другими
типами данных, например, с матрицами (*matrix*), таблицами (*table*) и др.
Покажем на примере наборов данных (*data frame*).

Будем использовать набор данных `diamonds` из пакета `ggplot2`. Множество других
встроены во многие пакеты, а также в сам R, и список с кратким описанием
последних можно вызвать командой `library(help = "datasets")`.

Наборы данных состоят из строк (*rows*) и столбцов (*columns*); в каждой строке
хорошо построенного набора --- характеристики одного объекта, а по столбцам ---
значения одной характеристики у разных объектов. Так, например, в `diamonds`
объектами являются бриллианты, а их характеристиками --- цена, вес, цвет и т. д.
Это можно увидеть с помощью всё той же команды `str()`:

```{r} 
str(diamonds) 
```

Отобразим наблюдения с 5-го по 7-е: 
```{r} 
diamonds[c(5:7), ] 
```

Первые 4 значения параметров цены (*price*) и веса (*carat*):

```{r} 
head(diamonds[, c("price", "carat")], n = 4) 
```

Можно отобразить и все названия характеристик:

```{r} 
colnames(diamonds) 
```

Найдём, сколько камней имеют чистоту не меньшую, чем VS2 (характеристика
*clarity* --- упорядоченный фактор).

```{r} 
nrow(diamonds[diamonds$clarity >= "VS2", ]) 
```


### Сравнение чисел --- штука тонкая

Правда ли, что 0.4 + 0.1 равно 0.5? 
```{r} 
0.4 + 0.1 == 0.5 
```

А правда ли, что 0.4 - 0.1 равно 0.3? 
```{r} 
0.4 - 0.1 == 0.3 
```

Хм, что-то Марь Иванна в школе другое говорила...

Почему так случилось? Компьютер хранит числа в памяти в двоичной системе
счисления. В двоичной системе обычное число 0.1 будет записываться в виде
бесконечной периодической дроби. Следовательно, без дополнительных ухищрений
храниться в памяти абсолютно точно оно не может. Поэтому де-факто компьютер
хранит в памяти округленную версию от 0.4, 0.1 и 0.3. В данном случае при
вычитании ошибки округления не компенсируют друг друга.

## Первый скрипт {#first_script}


....

Если текст программы содержит русские или другие неанглийские буквы, например, в
комментариях, то при сохранении файла Rstudio предложит выбрать кодировку.


картинка


Кодировка определяет какой конкретно числовой код будет сопоставлен в записанном
файле каждой букве. Например, букве `ё` в кодировке UTF-8 сопоставлен
десятичный^[Если шестнадцатиричный, то 0451. Ради интереса можно посмотреть
сопоставление букв и их кодов в UTF-8, например, на
[unicode-table.com](http://unicode-table.com/ru/)] код 1105.

Для русского языка есть несколько распространённых кодировок: UTF-8 и CP1251.
Linux и Macos используют по умолчанию кодировку UTF-8, а вот Windows^[На самом
деле всё немного хитрее и сама Windows технически использует UTF-16, а вот
многие приложения под ней --- CP1251.] сохраняет простые текстовые файлы в
кодировке CP1251.

Если русскоязычный файл записать в одной кодировке, а пытаться открыть с помощью
другой, то мы увидим на экране "кракозябры". Поэтому хорошо, когда все
используют одну кодировку. Кодировка UTF-8 более универсальна, чем CP1251.
Например, с помощью кодировки UTF-8 в одном тексте можно использовать и русские
буквы и французские акценты и китайские иероглифы.

```{block, type="warning"} Мы всегда будем использовать кодировку UTF-8. ```



## Установка и подключение пакетов {#packages}

Одна из сильных сторон R --- это открытость: каждая домохозяйка может написать
свой пакет для R и выложить его в публичное пользование. Пакеты расширяют
возможности R.  Для R написано более 10 тысяч пакетов. Среди них есть и
откровенный мусор, и бриллианты, например, `ggplot2`, настолько ценные, что их
копируют в другие языки программирования.



Скорее всего нужный тебе пакет можно найти:

1. В официальном хранилище пакетов R, CRAN.

Здесь пакеты прошли минимальное тестирование. Это отнюдь не гарантия качества
пакета, но всё же серьезный давно функционирующий пакет наверняка будет выложен
на CRAN.

2. В системе репозиториев github.com.

Здесь, как правило, разработчики публикуют более свежие версии пакетов, ещё не
выложенные на CRAN, или молодые пакеты в процессе разработки.

3. В хранилище пакетов для биологов `bioconductor`.

Это своя отдельная экосистема пакетов R со специальным инсталлятором, блэкджеком
и поэтэссами.

Есть и другие хранилища пакетов, например, R-forge и ..., но они гораздо менее
популярны.




Сначала надо определиться, какой пакет тебе нужен. Можно погуглить, можно
воспользоваться официальным классификатором пакетов R ....


Чтобы начать использовать какой-нибудь пакет R нужно сделать две вещи.
Во-первых, установить его. Установка означает, что пакет будет скачан из
Интернета и сохранён в специальной папке на жёстком диске. Установка пакета
выполняется один раз. Каждый раз при использовании пакета устанавливать его не
нужно. Переустанавливать пакет имеет смысл только если вышла новая его версия.
Во-вторых, нужно подключить пакет. Подключение пакета выполняется каждый раз
перед его использованием.


С репозитория CRAN пакет ставится командой R: ```{r, eval=FALSE} 
install.packages("имя пакета") ```

В Rstudio установить пакет с репозитория CRAN можно через меню: Tools - Install
packages. Далее нужно набрать название пакета, можно указать сразу несколько
названий через пробел, и нажать `Install`.

```{block, type="warning"} 
Главное при установке пакета --- не бояться сообщений
красным цветом! 
```


Любые **сообщения** (messages) R выводит красным цветом и по неопытности их
можно принять за ошибку, что скорее всего не так. Ошибка всегда сопровождается
словом `r colFmt("Error", "red")`. Если слова `r colFmt("Error", "red")` нет, то
всё идёт по плану!

Почему R использует красный цвет? Потому, что установка пакета --- это
потенциально опасное действие, как и установка любой программы. Пакеты на
официальном репозитории CRAN проходят определённую проверку, но если ты
используешь R для многомиллионных сделок каждый день, то неплохо бы точно знать,
что ты ставишь :)




Установить пакет с github.com немногим сложнее. Здесь надо знать не только
название пакета, но и название репозитория, где он хранится. Часто название
репозитория --- это фамилия автора пакета. Официальной классификации всех
пакетов R на github нет, поэтому чтобы понять, какой нужен, остаётся только
гуглить.

Кроме того, для установки пакетов с github.com потребуется установить с
официального репозитория




Джентельменский набор пакетов R зависит от сферы деятельности, но практически
всем сталкивающимся с анализом данных пригодятся:

...

Очень часто пакеты R ошибочно называют библиотеками. Библиотека --- это папка на
жёстком диске компьютера, где хранятся пакеты.

Если пакет установлен, то можно воспользоваться его командами. Если из пакета
нужна всего одна команда и один раз, то быстрее указать и нужный пакет, и нужную
команду. Например, вызовем команду `qplot` из пакета `ggplot2` и построим
гистограмму для случайной выборки из 100 нормальных стандартных случайных
величин: ```{r} x <- rnorm(100) # генерируем случайную выборку из 100 нормальных
N(0;1) случайных величин ggplot2::qplot(x) ```

Если же ты хочешь использовать команды некоторого пакета много раз, то проще
**подключить** пакет командой `library()`. При этом не надо будет каждый раз
набирать название пакета и двойное двоеточие. Можно просто использовать команды
из этого пакеты: ```{r} library("ggplot2") # подключаем пакет `ggplot2`

x <- rnorm(100) # генерируем случайную выборку из 100 нормальных N(0;1)
случайных величин y <- x^2 + rnorm(100)

# строим гистограмму величины x: qplot(x) + xlab("Величина X") +
ylab("Количество значений")

# строим диагрраму рассеяния величин x и y: qplot(x, y) + xlab("Величина X") +
ylab("Величина Y") ```

При подключении пакета, как и при его установке, не стоит пугаться сообщений
красным шрифтом. Только явное слово `Error` говорит об ошибке. Кроме того, часто
можно столкнуться с **предупреждением** (warning) о том, что пакет был создан
для более новой версии R.

`r colFmt("Warning message: package 'xxx' was built under R version 3.3.1",
"red")`

Это не страшно. Это означает лишь, что у разработчика пакета `xxx` установлена
более свежая версия R, чем у тебя. Обновлять R на своём компьютере при каждом
его мелком обновлении, пожалуй, неразумно, но раз в полгода стоит.

```{block, type="warning"} Правила хорошего тона советуют подключать все нужные
пакеты в начале скрипта. ```


## Чтение и запись данных {#io}

Прежде всего неплохо бы знать, где лежит на жёстком диске файл с нужными
данными. Напомню, что названия файлов и папок не должны содержать русским букв и
пробелов!

У R есть понятие **рабочей папки** (working folder). В рабочей папке R ищет все
требуемые файлы. Одно из простых решений --- указать в качестве рабочей папки ту
папку, где лежит нужный файл и далее прочитать его.

Допустим, нужный нам файл лежит в папке `C:/project_A/data/`. Тогда для
установки рабочей папки достаточно выполнить команду:

```{r, eval=FALSE} setwd("C:/project_A/data/") ```

Вместо этой команды можно воспользоваться меню Rstudio: Session - Set working
directory - Choose directory. Далее выбрать нужную папку и нажать `Open`.

После этого можно прочитать нужный нам файл. Начнём с пакета `rio` позволяющего
импортировать данные практически любого типа. На самом деле авторы пакета `rio`
просто объединили усилия многих разработчиков в единую команду. И получилось
хорошо :)


Хочешь загрузить данные в формате `.csv`? Пожалуйста! ```{r, eval=FALSE} data <-
rio::import("имя_файла.csv") ```

Хочешь загрузить данные в формате `.xlsx`? Пожалуйста! ```{r, eval=FALSE} data
<- rio::import("имя_файла.xlsx") ```

Однако не всегда всё идёт гладко, поэтому остановимся подробнее на разных
форматах данных.


## Интернет-источники данных {#internet_sources}

Зачастую данные не обязательно даже сохранять. В R есть пакеты, дающие доступ к
некоторым источникам данных в Интернете:

1. `quandl`

2. `quantmod`

3. `WDI`


> СССР --- родина слонов!

Пакеты, дающие доступ к данным по России:

1. `sophisthse` sophist.hse.ru

2. `cbr` Центральный Банк России

3. `datamos` datamos.ru

4. finam.ru.

А эти источники ещё ждут желающих написать пакет для R:

1. gks.ru

2. open data gov ???




## Стиль кода {#code_style}

R одинаково выполнит и команды ```{r, eval=FALSE} x<-6-7 y<--6+9 x -     y ```

и команды ```{r, eval=FALSE} x <- 6 - 7 y <- -6 + 9 x - y ```

Однако второй вариант гораздо приятнее для чтения. С тем, кто пишет код как в
первом примере, Английская королева рядом не сядет! Чтобы иметь возможность
войти в палату Лордов и Общин, тебе следует писать стильный код!


Если ты работаешь в команде, то руководствуйся тем стилем кода, который в ней
принят. А для новичков я советую использовать стиль кода, которого
придерживается Hadley Wickham, автор очень популярных пакетов R `ggplot2` и
`dplyr`:

1. После запятой всегда пиши пробел. Перед запятой --- никогда:

```{r, eval=FALSE} paste0("Hi ", "guys!") ```


2. Знак присваивания `<-`, знаки арифметических действий (`+`, `-`, `*`),
логические проверки (`>`, `<`, `==` и прочие) с двух сторон окружай одинарными
пробелами.

```{r, eval=FALSE} x <- (3.5 + 7) * (2.8 - 9) ```


3. Открывающую фигурную скобку оставляй на старой строке, а закрывающую ---
ставь на новую:

```{r, eval=FALSE} if (x == y) { message("Variables x and y are equal.") } ```


В Rstudio можно включить автоматическую проверку стиля кода в Tools - Global
options - Code - Diagnostics. Настоящие сэры и истинные леди в разделе
Diagnostics могут проставить все галочки.


## Две записи функций {#two_traditions}

Мы все привыкли к тому, что домохозяйки пишут рецепт в естественном порядке, а
математики функции --- в обратном. Сравни:

> Возьмите пепел перьев чёрного петуха

> Добавьте печень дракона

> Варите на медленном огне 2 дня

и

\[ \cos(\sin(|x|)) \]

У домохозяек порядок изложения совпадает с порядком действий. У математиков
сначала написано про косинус, но считается он в самом конце.

Похоже Лёнька Эйлер и Алёшка Клеро

фото

введя обозначение $f(x)$ отделили математиков от домохозяек и, вероятно, пустили
математику по ложному пути. Было бы гораздо удобнее, если бы в математике
функции также записывали в естественном порядке! Но обозначение $f(x)$ мы
впитали с молоком матери, уже вряд ли что исправишь.


R позволяет использовать обе традиции обозначени.

Традиция Эйлера-Клеро: ```{r} cos(sin(abs(10))) ```

Для того, чтобы иметь возможность писать операции в естественном порядке,
подключаем пакет `dplyr`: ```{r, message=FALSE} library("dplyr") ```

И теперь в традиции лучших кулинарных рецептов можно написать ```{r} 10 %>%
abs() %>% sin() %>% cos() ```

Оператор `%>%` называется трубочкой (pipe). (? канал) По первому впечатлению
кажется, что эти трубочки долго писать. Но стоит к ним привыкнуть и ощущаешь,
что они безумно удобны для сложных операций!



## Манипуляции с данными  {#data_manipulations}

(здесь про типы данных)

## Графики {#graphs}

График можно строить либо чтобы: - самому по-быстрому взглянуть на некий
результат и сразу забыть график - показать график кому-нибудь

В первом случае нет никаких требований к графику --- лишь бы самому было
понятно, что там изображено. Если же график показывать кому-то ещё, то:

```{block, type="warning"} 
Идеальный график должен быстро и верно восприниматься
смотрящим. ```

Из этого простого принципа следует ряд выводов:

1. Идеальный график должен быть самодостаточным.

Если для понимания графика смотрящему требуется прочитать кучу текста вокруг или
прослушать получасовое объяснение, то это нехорошо :) Вырежи свой график из
статьи/книги/курсовой и подумай, понятен ли он?

2. Подписывай оси.

[ссылка на xkcd]

3. Выбирай единицы измерения так, чтобы читатель не мучился, считая нули у
каждой цифры.

4. Указывай единицы измерения.

5. Хорошо бы указать источник данных.

6. Лучше расшифровать сокращения, хотя иногда это бывает нелегко.

7. Никаких круговых диаграмм.

Круговые диаграммы --- это табу. Да, R умеет их строить. Процитирую документацию к функции `pie`:
```{r, eval=FALSE}
help(pie)
```

> Pie charts are a very bad way of displaying information. The eye is good at judging linear measures and bad at judging relative areas. A bar chart or dot chart is a preferable way of displaying this type of data.
>
> Cleveland (1985), page 264: “Data that can be shown by pie charts always can be shown by a dot chart. This means that judgements of position along a common scale can be made instead of the less accurate angle judgements.” This statement is based on the empirical investigations of Cleveland and McGill as well as investigations by perceptual psychologists.

8. Никаких псевдо-3D эффектов и прочих «рюшечек».

Посмотрите пару анимаций от DarkHorse.

9. Ось должна начинаться от нуля.

10. Полезно немного ознакомиться с творениями мэтров :)

Tufte, link

Очень часто к графикам относятся как к чему-то вспомогательному. На самом деле график очень часто является основным результатом, гораздо более важным, чем несколько страниц текста. Именно поэтому полезно отказаться от мысли «я тут за пять минут график вставлю» и потратить на график часок-другой!


### Два простеньких графика

Простенькую гистограмму можно построить, например, с помощью функции `qplot()`
из пакета `ggplot2`: 
```{r, warning=FALSE} 
s <- rnorm(100)
qplot(factor(s), xlab = "Значение",
ylab = "Количество", main = "Гистограмма") 
```

Ту же гистограммку можно построить с помощью функции `ggplot()` из того же
пакета, предварительно преобразовав s в необходимый для `ggplot()` формат data
frame: 
```{r} 
s_df <- data.frame(s) 
ggplot(s_df) + geom_bar(aes(factor(s))) +
labs(x = "Значение", y = "Количество", title = "Гистограмма") 
```

И еще простенький график: 
```{r, warning=FALSE} 
x <- rnorm(500) 
# 500 нормальных величин со средним 0 и дисперсией 1 
y <- rnorm(500) # 500 нормальных величин со средним 0 и дисперсией 1 
qplot(x, y, main = "Точечки") 
```

Или: 
```{r} 
xy_df <- data.frame(x = x, y = y) 
ggplot(xy_df) + geom_point(aes(x, y)) + labs(title = "Точечки") 
```

В зависимости от формата данных часто бывает удобно использовать и `qplot()`, и `ggplot()`.



## У меня ошибка! {#error}

> Шеф! Всё пропало! Гипс снимают, клиент уезжает!

поговори с уточкой, посиди у озера

## Ресурсы по R {#R_links}

Начнём с русскоязычных крупных книжек:

* Шипунов А.Б., Балдин Е.М. и др. [Наглядная статистика. Используем
R!](http://ashipunov.info/shipunov/school/books/rbook.pdf) * Мастицкий С.Э.,
Шитиков В.К., [Статистический анализ и визуализация с помощью
R](http://www.ievbras.ru/ecostat/Kiril/R/Mastitsky%20and%20Shitikov%202014.pdf) 
* Василенко Є.С, [Обробка геологiчної iнформацiї з використанням програмного
середовища
R](https://www.dropbox.com/sh/gaxtktwbxyuu1ss/AAAb2XW0kquoxfLryf2aYeQZa?dl=0) *
Кабаков Р.И. R в действии. [Анализ и визуализация данных на языке
R](http://dmkpress.com/catalog/computer/statistics/978-5-94074-912-7/)

На русском также могут быть полезны:

* Стилевое руководство гугла:
[english](https://google-styleguide.googlecode.com/svn/trunk/Rguide.xml),
[русский](https://9ccb6b88-a-cba0391b-s-sites.googlegroups.com/a/kiber-guu.ru/r-practice/links/R_style_from_Google.pdf?attachauth=ANoY7crkge5FhA5LZtMwj6Ilur-WbnkKLijkDkoB01VZZAlsFoRjEo7YwgqvW-Gid6ffwBmz3TMT51kMnw8JljZeQlDPRXMKZctirezqTziipn5TOaB9D1IaQ7qzTSusjkIyYV2jMchrhAsXOHTo_G0VRztBxYeecm4HYS19M1VTxn-UluL_9tYpsOEpDvhV1ghlRvk57pCxDO3C4wSV63SQIy0p7cjo6r-HB6Dj0CG7iNKM_RTjaAw%3D&attredirects=0)
* [Блог r-analytics](http://r-analytics.blogspot.ru). На нём есть несколько
других подборок русскоязычных ресурсов по R:
[раз](http://r-analytics.blogspot.ru/p/blog-page_20.html) и
[два](http://r-analytics.blogspot.ru/p/blog-page_80.html). * [Группа вконтакте
rstatistics](https://vk.com/rstatistics) * [Группа вконтакте
spbrug](https://vk.com/spbrug) * [Группа вконтакте
introstats](https://vk.com/introstats) * Венэбльз, Смит [Введение в
R](http://www.ievbras.ru/ecostat/Kiril/R/Biblio/R_rus/Venables%20%c2%e2%e5%e4%e5%ed%e8%e5%20%e2%20R.pdf)
* Зарядов И.С. [Введение в R: часть
1](http://www.ievbras.ru/ecostat/Kiril/R/Biblio/R_rus/%c7%e0%f0%ff%e4%ee%e2%20%f7%e0%f1%f2%fc_1.pdf)
* Зарядов И.С. [Введение в R: часть
2](http://www.ievbras.ru/ecostat/Kiril/R/Biblio/R_rus/%c7%e0%f0%ff%e4%ee%e2%20%f7%e0%f1%f2%fc_2.pdf)
* Борис Демешев [Цикл маленьких заметок по
R](http://bdemeshev.github.io/r_cycle/)

Вопросы и ответы:

* [stackoverflow](http://stackoverflow.com/) Если возникли проблемы с
программированием в R (и не только в R), а документация уже прочитана... *
[stats.stackexchange](http://stats.stackexchange.com/) Можно спросить по
статистическим методам и их реализации в R. *
[tex.stackexchange](http://tex.stackexchange.com/) Вопросы и ответы про LaTeX



Он-лайн курсы и видеолекции с использованием R:

* [Try R](http://tryr.codeschool.com/) Путь к сокровищам R для самых начинающих
пиRатов!

* [datacamp.com](https://www.datacamp.com/) Несколько платных и бесплатных
интерактивных курсов по R

* Видео-лекции курса Computing for Data Analysis: [неделя
1](http://www.youtube.com/playlist?list=PLjTlxb-wKvXNSDfcKPFH2gzHGyjpeCZmJ),
[неделя
2](http://www.youtube.com/playlist?list=PLjTlxb-wKvXNnjUTX4C8IeIhPBjPkng6B),
[неделя
3](http://www.youtube.com/playlist?list=PLjTlxb-wKvXOzI2h0F2_rYZHIXz8GWBop),
[неделя
4](http://www.youtube.com/playlist?list=PLjTlxb-wKvXOdzysAE6qrEBN_aSBC0LZS). Сам
курс доступен на [coursera.org](http://www.coursera.org)


Открытые крупные источники на английском:

* Trevor Hastie, Robert Tibshirani, [An Introduction to Statistical
Learning](http://www-bcf.usc.edu/~gareth/ISL/). По книжке есть [курс на
платформе
class.standford.edu](https://class.stanford.edu/courses/HumanitiesandScience/StatLearning/Winter2015/about)

* Rob Hyndman, [Forecasting: principles and
practice](https://www.otexts.org/book/fpp) Книжка по временным рядам от автора
пакета forecast

* Garrett Grolemund, Hadley Wickham, [R for Data
Science](http://r4ds.had.co.nz/)

* Colin Gillespie, Robin Lovelace, [Efficient R
programming](https://bookdown.org/csgillespie/efficientR), он-лайн книга для
более продвинутых пользователей R. Написана на R и markdown :)

* Rob Kabacoff, [Quick R](http://www.statmethods.net/)

* Farnsworth, [Econometrics in
R](http://cran.r-project.org/doc/contrib/Farnsworth-EconometricsInR.pdf)

* [Cookbook for R](http://wiki.stdout.org/rcookbook/)

* [R-inferno](http://www.burns-stat.com/pages/Tutor/R_inferno.pdf) Адский
учебник по R с картинками Ботичелли, "Even if it doesn't help you with your
problem, it might amuse you"


* Roger Peng, [R programming for data
science](https://leanpub.com/rprogramming/) и на
[bookdown](https://bookdown.org/rdpeng/rprogdatascience/)

* [Introduction to R](http://cran.r-project.org/doc/manuals/R-intro.pdf),
Введение с официального сайта

* документация [по графикам ggplot2](http://docs.ggplot2.org/current/index.html)

* документация к [R от
stats.stackexchange](http://stackoverflow.com/documentation/r/topics)

* **Шикарные** [**шпаргалки от
Rstudio**](https://www.rstudio.com/resources/cheatsheets/)

* [100 курсов и книг по
R](https://pairach.com/2012/02/26/r-tutorials-from-universities-around-the-world/)
от разных университетов

* Агрегатор блогов [r-bloggers](http://r-bloggers.com/)

* Поисковик [rseek.org](http://rseek.org/)


Великолепные виньетки к разным пакетам:

* [vars](http://cran.r-project.org/web/packages/vars/vignettes/vars.pdf),
векторные авторегрессии, есть вольный пересказ
[по-русски](http://rpubs.com/rakhab/9941) *
[dplyr](http://cran.rstudio.com/web/packages/dplyr/vignettes/introduction.html)
манипуляции с данными *
[sandwich](http://cran.r-project.org/web/packages/sandwich/vignettes/sandwich.pdf)
борьба с гетероскедастичностью и заклинания HC0, HC1, HC2, ... *
[plm](http://cran.r-project.org/web/packages/plm/vignettes/plm.pdf) панельные
модели в R *
[ggmap](http://journal.r-project.org/archive/2013-1/kahle-wickham.pdf) рисуем
карты *
[vcd](http://cran.r-project.org/web/packages/vcd/vignettes/strucplot.pdf)
полезные графики для качественных переменных *
[Beanplot](http://www.jstatsoft.org/v28/c01/paper): A Boxplot Alternative for
Visual Comparison of Distributions.



Ты ещё не заработал свой первый миллион и хочешь скачать научную статью или
книжку бесплатно?

* Научные книги можно найти на [gen.lib.rus.ec](http://gen.lib.rus.ec/).

* Научные статьи можно скачать на [sci-hub.cc](http://sci-hub.cc/). Есть даже
бот `@scihubot` для [Telegram](https://telegram.org/), которые вышлет в ответ на
запрос полный текст статьи.


Если какая-нибудь ссылка не работает или хочешь предложить свою, [смело открывай
issue на github](https://github.com/bdemeshev/r_manual_book/issues)!

<!--chapter:end:01_first_steps.Rmd-->

# Друзья R {#friends_of_R}

ывава
ыва
ыва
test

## Рабочий процесс {#workflow}

...


## Контроль версий {#version_control}

...


## Латех {#latex}


...

## Маркдаун {#markdown}

...

## Воспроизводимые исследования {#reproducible_research}

...

## Написание своего пакета {#own_package}

...

## Вычисления в облаке {#cloud_computing}

...

## Презентации {#presentations}

...

## Про эту книжку {#this_book}


Разбить на большее количество глав!!!

Что-то убрать? чтобы была ещё одна книжка? :)


Общие принципы:

1. Неформальный стиль, на "ты"

2. Больше картинок. Лицензия?

3. Больше гипер-ссылок.

4. Буква `ё` обязательна.


Пакет `bookdown` с помощью которого написана эта книжка ещё немного сыроват. В процессе работы я обнаружил, что:

1. Порой помогает удаление промежуточных файлов и компиляция заново.

2. После неанглоязычного названия главы обязательно должна идти метка `{#label}`.

3. Каждый `.Rmd` файл содержит только одну главу. Глава обозначается заголовком первого уровня `#`.

4. Сослаться на главу или подраздел можно с помощью `\@ref(label)`. 

5. Сослаться на источник литературы можно с помощью `[@reference]`

6. Автодобавление пакетов

```{r, include=FALSE, eval=FALSE}
# automatically create a bib database for R packages
knitr::write_bib(c(
  .packages(), 'bookdown', 'knitr', 'rmarkdown'
), 'packages.bib')
```

глючит на `"M"uller`

6. Для создания `MOBI` книг:

```{bash, eval=FALSE}
brew update
brew cask install calibre
brew cask install kindlegen
```

В предисловии
```{bash, eval=FALSE}
bookdown::kindlegen:
  epub: _book/r_manual.epub
```

ругается


или
```{bash, eval=FALSE}
bookdown::calibre:
  input: _book/r_manual.epub
  output: _book/r_manual.mobi 
```

ругается

Если надо изобразить yaml в чанке кода, пока пишу, что он bash


7. заставляем травис работать

Создаём новый токен на [github](https://github.com/settings/tokens): кликнуть по иконке пользователя, далее settings - token - generate new token.

```{bash, eval=FALSE}
sudo gem install travis
travis encrypt GITHUB_TOKEN=[token from githum]
```

Именно переменная `GITHUB_TOKEN` должна использоваться для того, чтобы обращаться к гитхабу, т.е.
```{bash, eval=FALSE}

```

Добавляем получившуюся закодированную строку в `.travis.yml`. Забавно, что похоже используется рандомный ключ для шифрования и поэтому зашифрованная строка каждый раз выходит разной.

Можно не шифровать её, а добавить в travis-ci.org/user/repo/settings 





Для быстрой компиляции добавляем в `.travis.yml` указание, что мы будем использовать готовые бинарные пакеты R:
```{bash, eval=FALSE}
r_binary_packages:
  - ggplot2
  - dplyr
  - rio
```

Черт его знает? всё равно компилирует?


8. Красный шрифт

по мотивам [http://stackoverflow.com/questions/29067541](http://stackoverflow.com/questions/29067541)

```{r, eval=FALSE}
colFmt <- function(x, color) {
  outputFormat <- opts_knit$get("rmarkdown.pandoc.to")
  if (outputFormat == "latex") {
    result <- paste0("\\textcolor{", color, "}{", x, "}")
  } else if (outputFormat %in% c("html", "epub")) {
    result <- paste0("<font color='", color, "'>", x, "</font>")
  } else {
    result <- x
  }
  return(result)
}
```



Then you can use it inline like this: `r colFmt("MY RED TEXT", "red")`

9. Файл `_output.yaml` это просто `output:` кусок из `yaml`-части файла `index.Rmd`. Поэтому можно внести `_output.yaml` обратно в `index.Rmd`, чтобы все настройки были в одном месте. 

Формально `_output.yaml` действует на все `.Rmd` документы в папке, но что там будет кроме учебника в целом. Разве что отдельные главы компилировать :)




<!--chapter:end:02_friends_of_R.Rmd-->

# Статистика и не только {#statistics_and_more}

ываываыв
ываываыв

## Генерирование случайных величин {#random_variables}

Для решения задач по теории вероятностей или исследования свойств статистических алгоритмов может потребоваться сгененировать случайную выборку из заданного закона распределения.

Генерируем 10 равномерных на отрезке $[4;10.5]$ случайных величин:
```{r}
runif(10, min = 4, max = 10.5)
```

Генерируем 10 нормальных $N(2;9)$ случайных величин с математическим ожиданием $2$ и дисперсией $9=3^2$:
```{r}
rnorm(10, mean = 2, sd = 3)
```

Например, с помощью симуляций легко оценить математическое ожидание $E(1/X)$, где $X \sim N(2;9)$. Для этого мы вспомним Закон Больших Чисел. Он говорит, что арифметическое среднее по большой выборке стремится по вероятности и почти наверное к математическому ожиданию. Поэтому мы просто сгенерируем большую выборку в миллион наблюдений:

```{r}
n_obs <- 10^6
x <- rnorm(n_obs, mean = 2, sd = 3)
mean(1/x)
```

Также легко оценить многие вероятности. Например, оценим вероятность $P(X_1 + X_2 + X_3^2 > 5)$, где величины $X_i$ независимы и одинаково распределены $X_i \sim U[0;2]$:
```{r}
n_obs <- 10^6
x_1 <- runif(n_obs, min = 0, max = 2)
x_2 <- runif(n_obs, min = 0, max = 2)
x_3 <- runif(n_obs, min = 0, max = 2)
success <- x_1 + x_2 + x_3^2 > 5
sum(success) / n_obs
```

Здесь вектор `success` будет содержать значение TRUE там, где условие `x_1 + x_2 + x_3^2 > 5` выполнено, и FALSE  там, где условие не выполнено. При сложении командой `sum()` каждое TRUE будет посчитано как единица, а каждое FALSE как ноль. Поэтому `sum(success)` даст количество раз, когда условие `x_1 + x_2 + x_3^2 > 5` выполнено.


С любым распределением `[xxx]` в R связано четыре функции: `r[xxx]`, `d[xxx]`, `p[xxx]` и `q[xxx]`. Для примера возьмём нормальное распределение $N(2;9)$:

- Функция для создания случайной выборки из нормального $N(2; 9)$ распределения --- `rnorm`:
```{r}
x <- rnorm(100, mean = 2, sd = 3) # случайная выборка из 100 нормальных N(2; 9) величин
head(x, 10) # первые 10 элементов вектора
```

- Функция плотности --- `dnorm`:
```{r, "normal_pdf_plot"}
x <- seq(from = -6, to = 10, length.out = 100)
y <- dnorm(x, mean = 2, sd = 3)
qplot(x = x, y = y, geom = "line") + xlab("Значения случайной величины $X$") + ylab("Функция плотности")
```

Для дискретных распределений с буквы `d` начинается название функции, возвращающей вероятность получить заданное значение. Найдём для случайной величины $W$, имеющей Пуассоновское распределение с параметром $\lambda = 2$ вероятность $P(W = 3)$:
```{r, "poisson_example"}
dpois(3, lambda = 2)
```


- Функция распределения, $F(t)=P(X\leq t)$ --- `pnorm`:
```{r, "normal_cdf_plot"}
x <- seq(from = -6, to = 10, length.out = 100)
y <- pnorm(x, mean = 2, sd = 3)
qplot(x = x, y = y, geom = "line") + xlab("Значения случайной величины $X$") + ylab("Функция распределения")
```

- Квантильная функция или обратная функция распределения, $q(x) = F^{-1}(x)$ --- `qnorm`:

Найдём перцентили 5\%, 15\% и 90\% для нормального $N(2; 9)$ распределения:
```{r, "normal_quantile_function_example"}
x <- c(0.05, 0.15, 0.9)
qnorm(x, mean = 2, sd = 3)
```

Иногда бывает полезно получить случайную выборку из заданного вектора без повторений:
```{r, "simple_random_sample"}
sample(1:100, size = 20)
```


Или с повторениями:
```{r, "sample_with_replacement"}
sample(c("Орёл", "Решка"), size = 10, replace = TRUE)
```

Можно добавить неравные вероятности:
```{r, "sample_with_probabilities"}
sample(c("Орёл", "Решка"), size = 10, replace = TRUE, prob = c(0.3, 0.7))
```


Если выполнить команду `rnorm(10, mean = 2, sd = 3)` на двух разных компьютерах или два раза на одном и том же, то результат будет разный. Не зря же они случайные :) Однако генерирование случайных величин никак не противоречит идее абсолютно точной воспроизводимости исследований. Для того, чтобы получились одинаковые результаты, необходимо синхронизировать генераторы случайных чисел на этих двух компьютерах. Делается это путём задания **зерна** генератора случайных чисел (seed). Зерно также называют **стартовым значением**. В качестве зерна подойдёт любое целое число.

И в результате запуска кода
```{r}
set.seed(42)
rnorm(1, mean = 2, sd = 3)
```

все компьютеры выведут число $6.112875$.

```{block, type="warning"}
Если код содержит генерерирование случайных чисел, то необходимо задавать зерно генератора случайных чисел!
```



## Базовые статистические тесты {#statistical_tests}

...

## Множественная регрессия {#classic_regression}

...

Эконометристы любят копаться в остатках :)

https://www.r-bloggers.com/visualising-residuals/


## Квантильная регрессия {#quantile_regression}

Незаслуженно забытой оказывается квантильная регрессия. Коэнкер (ссылка) утверждает, что развитие эконометрики началось именно с квантильной регрессии. Для оценок квантильной регрессии не существует формул в явном виде, поэтому она проиграла классической регрессии среднего с формулой $\hat\beta = (X'X)^{-1}X'y$. Сейчас компьютер позволяет начихать на отсутствие явных формул :)

...

## Инструментальные переменные {#instrumental_variables}

Каждый исследователь мечтает обнаружить не просто статистическую связь, а причинно-следственную. К сожалению, это не так просто. Фиксируя количество людей с зонтиками на улице и количество осадков но не зная физическую природу дождя, невозможно определить, вызывают ли люди с зонтиками дождь или наоборот. Для выяснения причинно следственных связей необходим случайный эксперимент. Например, можно выбрать несколько случайных дней в году и выгнать толпу знакомых с зонтами на улицу, а затем посмотреть, было ли больше осадков в эти дни.

Инструментальные переменные часто используются исследователями при поиске причинно следственных связей, но это ни в коем случае не означает, что введение инструментальных переменных само по себе гарантирует нахождение причинно-следственной связи! 

```{block, type="warning"}
Для обнаружения причинно-следственной связи необходимо либо использовать данные случайного эксперимента, либо прекрасно разбираться в закономерностях происходящего.
```

Этот раздел не о том, как обнаружить причинно-следственную связь, а о том, как реализовать метод инструментальных переменных в R и как его проинтепретировать.





## Гетероскедастичность {#heteroskedasticity}

...


## Работа с качественными переменными {#factor_variables}

...


## Логит и пробит с визуализацией {#logit_probit}

...


## Метод главных компонент {#pca}

...


## Мультиколлинеарность {#multicollinearity}

...


## LASSO {#lasso}

...


## Метод максимального правдоподобия {#maximum_likelihood}

...


## Метод опорных векторов {#svm}

...


## Случайный лес {#random_forest}

...


## Экспоненциальное сглаживание {#exponential_smoothing}

...


## ARMA модели {#arma}

...


## GARCH {#garch}

...


## VAR и BVAR {#var_bvar}

...



Я не верю в пользу от структурных BVAR, поэтому их здесь нет :)

## Панельные данные {#panel_data}

...



## Байесовский подход: первые шаги {#bayesian_first_steps}

...


## Байесовский подход: STAN {#stan}

...


## Карты {#maps}

> Где карта, Билли?

## Дифференциальные уравнения {#differential_equations}

...


## Задачи оптимизации {#optimisation}

...






<!--chapter:end:03_statistics_and_more.Rmd-->

